/// <reference path="../typings/index.d.ts"/>
const _ = require("lodash");
class Event {
    constructor() {
        this.listeners = [];
        this.isBeingTriggered = false;
        this.triggerDelegate = null;
        this.listenDelegate = null;
        this.matchDelegate = null;
        this.matchOnceDelegate = null;
        this.unlistenDelegate = null;
        this.onceDelegate = null;
        this.whenDelegate = null;
        this.thenDelegate = null;
        this.catchDelegate = null;
        this.promise = null;
        this.isFirstTriggerDone = false;
        this.idCounter = 0;
        this.triggerDelegate = (eventArg) => this.trigger(eventArg);
        this.listenDelegate = (...args) => {
            return this.listen.apply(this, args);
        };
        this.matchDelegate = (...args) => {
            return this.match.apply(this, args);
        };
        this.matchOnceDelegate = (...args) => {
            return this.matchOnce.apply(this, args);
        };
        this.unlistenDelegate = (...args) => {
            return this.unlisten.apply(this, args);
        };
        this.onceDelegate = (handler, context = null) => {
            return this.once(handler, context);
        };
        this.whenDelegate = () => {
            return this.when();
        };
        this.thenDelegate = (onOk, onFail) => {
            return this.then(onOk, onFail);
        };
        this.catchDelegate = (onFail) => {
            return this.catch(onFail);
        };
        this.promise = new Promise((resolve) => { this.resolve = resolve; });
    }
    mixin(target) {
        target.trigger = this.getTriggerer();
        target.getTriggerer = () => {
            return this.getTriggerer();
        };
        target.listen = this.getListener();
        target.match = this.getMatchListener();
        target.matchOnce = this.getMatchOncer();
        target.unlisten = this.getUnlistener();
        target.once = this.getOncer();
        target.when = this.getWhener();
        target.then = this.getThener();
        target.catch = this.getCatcher();
        return target;
    }
    /** Returns a context-independent callback that triggers the event with given argument */
    getTriggerer() { return this.triggerDelegate; }
    getListener() { return this.listenDelegate; }
    getMatchListener() { return this.matchDelegate; }
    getMatchOncer() { return this.matchOnceDelegate; }
    getUnlistener() { return this.unlistenDelegate; }
    getOncer() { return this.onceDelegate; }
    getWhener() { return this.whenDelegate; }
    getThener() { return this.thenDelegate; }
    getCatcher() { return this.catchDelegate; }
    /**
     * Triggers the event with given argument, invoking all of its handlers, and if
     * the event is triggered for the first time - removing the once event handlers and
     * saving given argument inetrnally as first trigger argument.
     */
    trigger(eventArg) {
        if (this.isBeingTriggered) {
            throw new Error(`Event triggered during trigger handling - suspecting recursive event.`);
        }
        this.isBeingTriggered = true;
        if (!this.isFirstTriggerDone) {
            this.isFirstTriggerDone = true;
            this.resolve(eventArg);
        }
        this.listeners.slice().forEach((listener) => {
            let doCall = true;
            if (listener.onlyMatching) {
                doCall = listener.matchValue === eventArg;
            }
            if (doCall) {
                if (listener.context) {
                    listener.handler.call(listener.context, eventArg);
                }
                else {
                    listener.handler.call(null, eventArg);
                }
                if (listener.once) {
                    this.removeListener(listener);
                }
            }
        });
        this.isBeingTriggered = false;
    }
    listen(...args) {
        let id;
        if (typeof args[0] === 'string') {
            let [name, handler, context] = args;
            id = this.addListener({ name, handler, context });
        }
        else {
            let [handler, context] = args;
            id = this.addListener({ handler, context });
        }
        return id;
    }
    ;
    match(value, ...args) {
        let id;
        if (typeof args[0] === 'string') {
            let [name, handler, context] = args;
            id = this.addListener({ name, handler, context, onlyMatching: true, matchValue: value });
        }
        else {
            let [handler, context] = args;
            id = this.addListener({ handler, context, onlyMatching: true, matchValue: value });
        }
        return id;
    }
    ;
    matchOnce(value, handler, context = null) {
        return this.addListener({ context, handler, once: true, onlyMatching: true, matchValue: value });
    }
    once(handler, context = null) {
        return this.addListener({ context, handler, once: true });
    }
    unlisten(...args) {
        let name = null, context, handler, idToRemove = null;
        switch (args.length) {
            case 0:
                this.listeners = [];
                return;
            case 1:
                if (typeof args[0] === 'string') {
                    name = args[0];
                    handler = args[1];
                    context = args[2];
                }
                else if (typeof args[0] === 'number') {
                    idToRemove = args[0];
                }
                else {
                    handler = args[0];
                    context = args[1];
                }
                ;
                break;
            case 2:
                handler = args[0];
                context = args[1];
                break;
        }
        this.listeners = _.filter(this.listeners, (hConf) => {
            let differentHandler = hConf.handler !== handler;
            let noContextGiven = context === null;
            let confHasNoContext = !!hConf.context;
            let differentContext = hConf.context !== context;
            let sameName = name && hConf.name && (name === hConf.name);
            let dontRemove;
            if (idToRemove !== null) {
                dontRemove = idToRemove !== hConf.id;
            }
            else {
                if (name) {
                    dontRemove = !sameName;
                }
                else {
                    if (differentHandler) {
                        dontRemove = true;
                    }
                    else {
                        dontRemove = noContextGiven ? (!confHasNoContext) : (confHasNoContext || differentContext);
                    }
                }
            }
            return dontRemove;
        });
    }
    on(nameOrHandler, handlerOrNothing) {
        return this.listen.apply(this, arguments);
    }
    off(bullshitWTF, context) {
        return this.unlisten.apply(this, arguments);
    }
    when() { return this.promise; }
    then(onOk, onFail) { return this.when().then(onOk, onFail); }
    after(onAny) { return this.then(onAny).catch(onAny); }
    catch(onFail) { return this.when().catch(onFail); }
    pipe(other) {
        this.on(other.getTriggerer());
    }
    unpipe(other) {
        this.off(other.getTriggerer());
    }
    removeListener(listener) {
        let listenerIndex = this.listeners.indexOf(listener);
        if (listenerIndex !== -1) {
            this.listeners.splice(listenerIndex, 1);
        }
    }
    addListener(options) {
        let { context, handler, once, onlyMatching, matchValue } = options;
        this.idCounter++;
        this.listeners.push({ context, handler, once, id: this.idCounter, onlyMatching, matchValue });
        return this.idCounter;
    }
    static event() {
        return function (prototype, eventName) {
            return {
                configurable: true,
                enumerable: false,
                get() {
                    let event = new Event();
                    Reflect.defineProperty(this, eventName, {
                        configurable: false,
                        enumerable: false,
                        writable: false,
                        value: event
                    });
                    return event;
                }
            };
        };
    }
    static emits(eventName) {
        return function (prototype, methodName, original) {
            let originalMethod = original.value;
            let descriptor = {
                configurable: false,
                enumerable: false,
                writeable: false,
                value(...args) {
                    let result = originalMethod.apply(this, args);
                    this[eventName].trigger(result);
                    return result;
                }
            };
            return descriptor;
        };
    }
}
exports.Event = Event;
function emits(name) {
    return Event.emits(name);
}
exports.emits = emits;
function event(name) {
    return Event.emits(name);
}
exports.event = event;
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Event;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw2Q0FBNkM7QUFFN0MsNEJBQTRCO0FBaU81QjtJQXlCSTtRQXhCUSxjQUFTLEdBQWdDLEVBQUUsQ0FBQztRQUM1QyxxQkFBZ0IsR0FBWSxLQUFLLENBQUM7UUFFbEMsb0JBQWUsR0FBc0IsSUFBSSxDQUFDO1FBRTFDLG1CQUFjLEdBQXFCLElBQUksQ0FBQztRQUN4QyxrQkFBYSxHQUEwQixJQUFJLENBQUM7UUFDNUMsc0JBQWlCLEdBQXVCLElBQUksQ0FBQztRQUM3QyxxQkFBZ0IsR0FBdUIsSUFBSSxDQUFDO1FBRTVDLGlCQUFZLEdBQWtCLElBQUksQ0FBQztRQUVuQyxpQkFBWSxHQUFtQixJQUFJLENBQUM7UUFFcEMsaUJBQVksR0FBbUIsSUFBSSxDQUFDO1FBQ3BDLGtCQUFhLEdBQW9CLElBQUksQ0FBQztRQUV0QyxZQUFPLEdBQWUsSUFBSSxDQUFDO1FBRTNCLHVCQUFrQixHQUFZLEtBQUssQ0FBQztRQUVwQyxjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBSTFCLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxRQUFXLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsR0FBRyxJQUFXO1lBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDekMsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLEdBQUcsSUFBVztZQUNoQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQztRQUNGLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLEdBQUcsSUFBVztZQUNwQyxN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Q0YsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUN0QixDQUFDLENBQUE7SUFDTCxDQUFDO0NBQ0o7QUF2U0Qsc0JBdVNDO0FBRUQsZUFBc0IsSUFBWTtJQUM5QixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRkQsc0JBRUM7QUFFRCxlQUFzQixJQUFZO0lBQzlCLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFGRCxzQkFFQzs7QUFFRCxrQkFBZSxLQUFLLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9pbmRleC5kLnRzXCIvPlxuXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5cbi8qKlxuICogQSBmdW5jdGlvbiwgY2FsbGJhY2ssIHdoaWNoIGlzIGNhbGxlZCwgd2hlbiBzdWJqZWN0IGV2ZW50IG9jY3Vycy5cbiAqIEl0IGlzIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGFyZ3VtZW50IC0gaXQgaXMgdGhlIHNhbWUgYXJndW1lbnQgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZVxuICogXCJ0cmlnZ2VyKClcIiBtZXRob2QgY2FsbCwgd2hpY2ggaXMgdGhlIG9ubHkgd2F5IHRvIG1ha2UgZXZlbnQgXCJoYXBwZW5cIi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudEhhbmRsZXI8VD4ge1xuICAgIChldmVudEFyZzogVCk6IHZvaWRcbn1cblxuLyoqXG4gKiBUaGUgZnVsbCBjb25maWd1cmF0aW9uIGZvciBhIHNwZWNpZmljIGV2ZW50LWhhbmRsZXIuIEl0IGNvbnRyb2xzIHRoZSB3YXlcbiAqIHRoZSByZWxldmFudCBldmVudC1oYW5kbGVyIGZ1bmN0aW9uIGlzIGludm9rZWQuXG4gKi9cbmludGVyZmFjZSBFdmVudEhhbmRsZXJPcHRpb25zPFQ+IHtcbiAgICAvKiogVGhlIGFjdHVhbCBoYW5kbGVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudCBvY2N1cnMuICovXG4gICAgaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+O1xuICAgIFxuICAgIC8qKiBJZiB0aGlzIGZsYWcgaXMgc2V0IC0gdGhlIGV2ZW50IGhhbmRsZXIgd2lsbCByZW1vdmUgaXRzZWxmIGZyb20gdGhlIGV2ZW50XG4gICAgYWZ0ZXIgZmlyc3QgaW52b2NhdGlvbi4gKi9cbiAgICBvbmNlPzogYm9vbGVhbjtcbiAgICBcbiAgICAvKiogSWYgdGhpcyBmaWVsZCBpcyBzcGVjaWZpZWQsIHRoZW4gaGFuZGxlciB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoYXQgY29udGV4dC4gKi9cbiAgICBjb250ZXh0PzogT2JqZWN0O1xuICAgIFxuICAgIC8qKiBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgaGFuZGxlci4gVXNlZCBmb3IgaWRlbnRpZmljYXRpb24uIFlvdSBtYXkgY3JlYXRlIHR3b1xuICAgICAqIGxpc3RlbmVycywgd2l0aCBzYW1lIGhhbmRsZXIgZnVuY3Rpb24sIGJ1dCBkaWZmZXJlbnQgbmFtZXMgLSBzbyB0aGF0IGxhdGVyLFxuICAgICAqIHlvdSBjYW4gJ29mZicvJ3VubGlzdGVuJyBhIHNwZWNpZmljIGxpc3RlbmVyIGJ5IG5hbWUsIHdoaWxlIHVubGlzdGVuaW5nIGJ5XG4gICAgICogaGFuZGxlciBmdW5jdGlvbiB3b3VsZCd2ZSByZW1vdmVkIGJvdGggbGlzdGVuZXIuXG4gICAgICovXG4gICAgbmFtZT86IHN0cmluZztcbiAgICBcbiAgICAvKipcbiAgICAgKiBBbHdheXMgdXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIGZvbGxvd2luZyBwYXJhbWV0ZXIgJ21hdGNoVmFsdWUnIGFuZCBpcyBhXG4gICAgICogZmxhZywgd2hpY2ggbWVhbnMoaWYgc2V0KSB0aGF0IG9ubHkgZXZlbnQgaW52b2NhdGlvbnMgd2l0aCBhcmd1bWVudCBlcXVhbFxuICAgICAqIHRvIHRoYXQgcHJlZGVmaW5lZCAnbWF0Y2hWYWx1ZScgc2hvdWxkIGJlIHBhc3NlZCB0byB0aGUgaGFuZGxlciBmdW5jdGlvbi5cbiAgICAgKiBCYXNpY2FsbHkgdGhpcyBpcyBhIHNob3J0aGFuZCBmb3IgdGhlIGNvZGUgbGlrZSB0aGlzOlxuICAgICAqXG4gICAgICogIGV2ZW50Lmxpc3RlbigoYXJnKSA9PiB7XG4gICAgICogICAgICBpZihhcmcgPT09IG1hdGNoVmFsdWUpKSBldmVudC5jYWxsSGFuZGxlcigpO1xuICAgICAqIH0pOyAgICAgICAgXG4gICAgICogXG4gICAgICogQHR5cGUge1t0eXBlXX1cbiAgICAgKi9cbiAgICBvbmx5TWF0Y2hpbmc/OiBib29sZWFuO1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSB2YWx1ZSwgdG8gYmUgbWF0Y2hlZCBpZiB0aGUgJ29ubHlNYXRjaGluZycgZmxhZyBpcyBzZXQuXG4gICAgICogQHR5cGUge1t0eXBlXX1cbiAgICAgKi9cbiAgICBtYXRjaFZhbHVlPzogVDtcbn1cblxuLyoqXG4gKiBUaGlzIGlzIHRoZSBvYmplY3Qgd2hpY2ggcmVwcmVzZW50cyBhbiBleGlzdGluZyBoYW5kbGVyIGludGVybmFsbHkgaW4gRXZlbnQgb2JqZWN0LlxuICovXG5pbnRlcmZhY2UgRXZlbnRIYW5kbGVyRGVzY3JpcHRvcjxUPiBleHRlbmRzIEV2ZW50SGFuZGxlck9wdGlvbnM8VD4ge1xuICAgIGlkOiBudW1iZXI7XG59XG5cbi8qKlxuICogVGhlIGludGVyZmFjZSBmb3IgdGhlICdldmVudC50cmlnZ2VyKCknIG1ldGhvZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50VHJpZ2dlcmVyPFQ+IHtcbiAgICAoYXJnOiBUKTogdm9pZFxufVxuXG4vKipcbiAqIFRoZSBpbnRlcmZhY2UgZm9yIHRoZSAnZXZlbnQubGlzdGVuKCknIG1ldGhvZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50TGlzdGVuZXI8VD4ge1xuICAgIChoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgIChuYW1lOiBzdHJpbmcsIGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG59XG5cbi8qKlxuICogVGhlIGludGVyZmFjZSBmb3IgdGhlICdldmVudC51bmxpc3RlbigpJyBtZXRob2RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudFVubGlzdGVuZXI8VD4ge1xuICAgIChoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgIChjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgIChuYW1lOiBzdHJpbmcpOiB2b2lkO1xuICAgICgpOiB2b2lkO1xufVxuXG4vKipcbiAqIFRoZSBpbnRlcmZhY2UgZm9yIHRoZSAnZXZlbnQub25jZSgpJyBtZXRob2RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudE9uY2VyPFQ+IHtcbiAgICAoaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZFxufVxuXG4vKipcbiAqIFRoZSBpbnRlcmZhY2UgZm9yIHRoZSAnZXZlbnQubWF0Y2goKScgbWV0aG9kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRNYXRjaExpc3RlbmVyPFQ+IHtcbiAgICAodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG4gICAgKHZhbHVlOiBULCBuYW1lOiBzdHJpbmcsIGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG59XG5cbi8qKlxuICogVGhlIGludGVyZmFjZSBmb3IgdGhlICdldmVudC5tYXRjaE9uY2UoKScgbWV0aG9kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRNYXRjaE9uY2VyPFQ+IHtcbiAgICAodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG59XG5cbi8qKlxuICogVGhlIGludGVyZmFjZSBmb3IgdGhlICdldmVudC53aGVuKCknIG1ldGhvZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50V2hlbmVyPFQ+IHtcbiAgICAoKTogUHJvbWlzZTxUPjtcbn1cblxuLyoqXG4gKiBUaGUgaW50ZXJmYWNlIGZvciB0aGUgJ2V2ZW50LnRoZW4oKScgbWV0aG9kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRUaGVuZXI8VD4ge1xuICAgIChvbk9rOiBGdW5jdGlvbiwgb25GYWlsOiBGdW5jdGlvbik6IFByb21pc2U8VD47XG59XG5cbi8qKlxuICogVGhlIGludGVyZmFjZSBmb3IgdGhlICdldmVudC5jYXRjaCgpJyBtZXRob2RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudENhdGNoZXI8VD4ge1xuICAgIChvbkZhaWw6IChlcnI6YW55KSA9PiBUfGFueSk6IFByb21pc2U8VD47XG59XG5cbi8qKlxuICogSW4gY29udGV4dCBvZiB0aGlzIGxpYnJhcnksIGFuICdldmVudC1lbWl0dGVyJyBtZWFucyB0aGUgc2FtZSBhcyAnZXZlbnQvZXZlbnQtb2JqZWN0JyxcbiAqIGV4Y2VwdCB0aGVyZSBpcyBub3QgdHJpZ2dlcmluZyBtZXRob2RzIGluIGV2ZW50LWVtaXR0ZXIuIEV2ZW50IGVtaXR0ZXIgaXNcbiAqIGRlZmluaXRpb24gb2YgdGhlIGludGVyZmFjZSBvZiB0aGUgZXZlbnQgd2hpY2ggc2hvdWxkIGJlIGFjY2Vzc2libGUgYnkgZXh0ZXJuYWxcbiAqIGVudGl0eS4gVGhlIHRyaWdnZXIgbWV0aG9kIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW50ZXJuYWwgdG8gdGhlIG9iamVjdCwgd2hpY2ggdGhpc1xuICogZXZlbnQgYmVsb25ncyB0by4gU28gb25seSB0aGUgb2JqZWN0IGl0c2VsZiBzaG91bGQgYmUgYWJsZSB0byB0cmlnZ2VyIGl0cyBvd24gZXZlbnRzLFxuICogbm90IGFueSBleHRlcm5hbCBvYmplY3QuXG4gKiBcbiAqIFRoZSBjb21tb24gcGF0dGVybiBpIHVzZSBpcyB0aGlzOlxuICogLSBkZWZpbmUgYSBwcml2YXRlL3Byb3RlY3RlZCBldmVudCBwcm9wZXJ0eSwgZXhwbGljaXRseSBuYW1lZCAnZXZlbnRCbGFibGEnXG4gKiAtIGRlZmluZSBhIHB1YmxpYyBnZXR0ZXIsIHJldHVybmluZyBFdmVudEVtaXR0ZXIsIGFuZCBuYW1lZCB3aXRob3V0IHRoZSBldmVudCBwcmVmaXg6XG4gKiBcbiAqICAgICAgY2xhc3MgU29tZUF3ZXNvbWVDbGFzcyB7XG4gKiAgICAgICAgICBwcml2YXRlIGV2ZW50QmxhYmxhOiBFdmVudDxhbnk+ID0gbmV3IEV2ZW50PGFueT4oKTtcbiAqICAgICAgICAgIHB1YmxpYyBnZXQgYmxhYmxhKCk6IEV2ZW50RW1pdHRlcjxhbnk+IHsgcmV0dXJuIHRoaXMuZXZlbnRCbGFibGE7IH1cbiAqICAgICAgfSBcbiAqIFxuICogICAgICBsZXQgeCA9IG5ldyBTb21lQXdlc29tZUNsYXNzKCk7XG4gKiAgICAgIHguYmxhYmxhLmxpc3RlbigoKSA9PiBjb25zb2xlLmxvZygnYmxhYmxhYmxhIScpKTtcbiAqIFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50RW1pdHRlcjxUPiBleHRlbmRzIFRoZW5hYmxlPFQ+IHtcbiAgICAvKipcbiAgICAgKiBBZGQgZXZlbnQgaGFuZGxlciB0byB0aGlzIGV2ZW50LiBPcHRpb25hbGx5IHBhc3MgYSBjb250ZXh0IGluIHNlY29uZCBhcmd1bWVudCAtIFxuICAgICAqIHRoZW4gd2hlbiB0cmlnZ2VyZWQgdGhpcyAgZXZlbnQgd2lsbCBjYWxsIHRoZSAnaCcgaGFuZGxlciB3aXRoIHRoZSBnaXZlbiBjb250ZXh0LlxuICAgICAqL1xuICAgIGxpc3RlbihoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG4gICAgbGlzdGVuKG5hbWU6IHN0cmluZywgaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIEFkZCBldmVudCBoYW5kbGVyIHRvIHRoaXMgZXZlbnQsIHdoaWNoIHdpbGwgYmUgY2FsbGVkIG9ubHkgd2hlbiBldmVudCBpcyB0cmlnZ2VyZWRcbiAgICAgKiB3aXRoIHZhbHVlLCB3aGljaCBpcyBleGFjdGx5KD09PSkgdGhlIHNhbWUgYXMgdGhlIG9uZSB5b3UgcGFzcyB0byB0aGUgbWF0Y2ggXG4gICAgICogbWV0aG9kIGFzIGZpcnN0IGFyZ3VtZW50XG4gICAgICovXG4gICAgbWF0Y2godmFsdWU6IFQsIGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcbiAgICBtYXRjaCh2YWx1ZTogVCwgbmFtZTogc3RyaW5nLCBoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGFuIGV2ZW50IGhhbmRsZXIuXG4gICAgICogQ29tYmluZXMgdGhlICdvbmNlJyBhbmQgdGhlICdtYXRjaCcgYmVoYXZpb3Vycy5cbiAgICAgKi9cbiAgICBtYXRjaE9uY2UodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIEFuIGFsaWFzIGZvciB0aGUgbGlzdGVuIG1ldGhvZC5cbiAgICAgKi9cbiAgICBvbihoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG4gICAgb24obmFtZTogc3RyaW5nLCBoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVudCBhY3R1YWxseSBmdWxseSBpbXBsZW1lbnRzIGEgcHJvbWlzZSBpbnRlcmZhY2UuIFRoYXQgcHJvbWlzZSBpbnRlcmZhY2VcbiAgICAgKiByZWZlcnMgdG8gdGhlIGZpcnN0IHRpbWUgdGhlIGV2ZW50IGlzIHRyaWdnZXJlZC4gU28gd2hlbiB5b3UgdHJpZ2dlciBhbnkgZXZlbnRcbiAgICAgKiBmb3IgdGhlIGZpcnN0IHRpbWUgLSBhcyBhIHByb21pc2UgaXQgaXMgcmVzb2x2ZWQgd2l0aCB0aGUgdmFsdWUgeW91IHBhc3MgdG9cbiAgICAgKiB0cmlnZ2VyIG1ldGhvZCBjYWxsLlxuICAgICAqIFxuICAgICAqIFRoZSBhZnRlciBtZXRob2QgaXMgYSBzaG9ydGN1dC1oZWxwZXIgLSBpdCBqdXN0IHVzZXMgZ2l2ZW4gaGFuZGxlciBvbiBwcm9taXNlXG4gICAgICogYXMgYm90aCBhICd0aGVuJyBhbmQgYSAnY2F0Y2gnIGhhbmRsZXIuXG4gICAgICogXG4gICAgICovXG4gICAgYWZ0ZXIob25SZXNvbHZlOiAocmVzdWx0OiBUfGFueSk9PmFueSk6IFRoZW5hYmxlPFQ+O1xuXG4gICAgdW5saXN0ZW4oaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICB1bmxpc3Rlbihjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgIHVubGlzdGVuKG5hbWU6IHN0cmluZyk6IHZvaWQ7XG4gICAgdW5saXN0ZW4oaWQ6IG51bWJlcik6IHZvaWQ7XG4gICAgdW5saXN0ZW4oKTogdm9pZDtcbiAgICBvZmYoaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICBvZmYoY29udGV4dDogT2JqZWN0KTogdm9pZDtcbiAgICBvZmYobmFtZTogc3RyaW5nKTogdm9pZDtcbiAgICBvZmYoaWQ6IG51bWJlcik6IHZvaWQ7XG4gICAgb2ZmKCk6IHZvaWQ7XG5cbiAgICBwaXBlKG90aGVyOiBFdmVudEVtaXR0ZXI8VD4pOiB2b2lkO1xuXG4gICAgb25jZShoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG5cbiAgICB3aGVuKCk6IFByb21pc2U8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRUcmFpdDxUPiBleHRlbmRzIEV2ZW50RW1pdHRlcjxUPiB7XG4gICAgdHJpZ2dlcihhcmc6IFQpOiB2b2lkO1xuXG4gICAgZ2V0VHJpZ2dlcmVyKCk6IEV2ZW50VHJpZ2dlcmVyPFQ+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50VHJhaXRUcmlnZ2VyPFQ+IGV4dGVuZHMgRXZlbnRUcmFpdDxUPiB7XG4gICAgKGFyZzogVCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRUcmFpdGVkTWV0aG9kPE1ldGhvZFQgZXh0ZW5kcyAoKT0+dm9pZCwgRXZlbnRBcmdzVD4gZXh0ZW5kcyBFdmVudFRyYWl0PEV2ZW50QXJnc1Q+IHtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUaGVuYWJsZTxUPiB7XG4gICAgdGhlbihvblJlc29sdmU6IChyZXN1bHQ6IFQpPT5hbnksIG9uUmVqZWN0PzogKGVycm9yOiBFcnJvcnxhbnkpPT5hbnkpOiBUaGVuYWJsZTxUPjtcbiAgICBjYXRjaChvblJlamVjdDogKGVycm9yOiBFcnJvcnxhbnkpPT5hbnkpOiBUaGVuYWJsZTxUPjtcbn0gXG5cbmV4cG9ydCBjbGFzcyBFdmVudDxUPiBpbXBsZW1lbnRzIEV2ZW50VHJhaXQ8VD4sIFRoZW5hYmxlPFQ+IHtcbiAgICBwcml2YXRlIGxpc3RlbmVyczogRXZlbnRIYW5kbGVyRGVzY3JpcHRvcjxUPltdID0gW107XG4gICAgcHJpdmF0ZSBpc0JlaW5nVHJpZ2dlcmVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIHRyaWdnZXJEZWxlZ2F0ZTogRXZlbnRUcmlnZ2VyZXI8VD4gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBsaXN0ZW5EZWxlZ2F0ZTogRXZlbnRMaXN0ZW5lcjxUPiA9IG51bGw7XG4gICAgcHJpdmF0ZSBtYXRjaERlbGVnYXRlOiBFdmVudE1hdGNoTGlzdGVuZXI8VD4gPSBudWxsO1xuICAgIHByaXZhdGUgbWF0Y2hPbmNlRGVsZWdhdGU6IEV2ZW50TWF0Y2hPbmNlcjxUPiA9IG51bGw7XG4gICAgcHJpdmF0ZSB1bmxpc3RlbkRlbGVnYXRlOiBFdmVudFVubGlzdGVuZXI8VD4gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBvbmNlRGVsZWdhdGU6IEV2ZW50T25jZXI8VD4gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSB3aGVuRGVsZWdhdGU6IEV2ZW50V2hlbmVyPFQ+ID0gbnVsbDtcblxuICAgIHByaXZhdGUgdGhlbkRlbGVnYXRlOiBFdmVudFRoZW5lcjxUPiA9IG51bGw7XG4gICAgcHJpdmF0ZSBjYXRjaERlbGVnYXRlOiBFdmVudENhdGNoZXI8VD4gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBwcm9taXNlOiBQcm9taXNlPFQ+ID0gbnVsbDsgXG4gICAgcHJpdmF0ZSByZXNvbHZlOiAodmFsdWU6IFQpID0+IFQ7XG4gICAgcHJpdmF0ZSBpc0ZpcnN0VHJpZ2dlckRvbmU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHByaXZhdGUgaWRDb3VudGVyOiBudW1iZXIgPSAwO1xuXG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy50cmlnZ2VyRGVsZWdhdGUgPSAoZXZlbnRBcmc6IFQpID0+IHRoaXMudHJpZ2dlcihldmVudEFyZyk7XG4gICAgICAgIHRoaXMubGlzdGVuRGVsZWdhdGUgPSAoLi4uYXJnczogYW55W10pOiB2b2lkID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpc3Rlbi5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5tYXRjaERlbGVnYXRlID0gKC4uLmFyZ3M6IGFueVtdKTogdm9pZCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXRjaC5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5tYXRjaE9uY2VEZWxlZ2F0ZSA9ICguLi5hcmdzOiBhbnlbXSk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2hPbmNlLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICB9OyBcbiAgICAgICAgdGhpcy51bmxpc3RlbkRlbGVnYXRlID0gKC4uLmFyZ3M6IGFueVtdKTogdm9pZCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy51bmxpc3Rlbi5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vbmNlRGVsZWdhdGUgPSAoaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0OiBPYmplY3QgPSBudWxsKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vbmNlKGhhbmRsZXIsIGNvbnRleHQpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLndoZW5EZWxlZ2F0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLndoZW4oKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy50aGVuRGVsZWdhdGUgPSAob25PazogRXZlbnRIYW5kbGVyPFQ+LCBvbkZhaWw6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG9uT2ssIDxhbnk+b25GYWlsKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5jYXRjaERlbGVnYXRlID0gKG9uRmFpbDogRnVuY3Rpb24pID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhdGNoKDxhbnk+b25GYWlsKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmU6IGFueSkgPT4geyB0aGlzLnJlc29sdmUgPSByZXNvbHZlOyB9KTtcbiAgICB9XG4gICAgXG4gICAgbWl4aW4odGFyZ2V0OiBhbnkpOiBFdmVudFRyYWl0PFQ+IHtcbiAgICAgICAgdGFyZ2V0LnRyaWdnZXIgPSB0aGlzLmdldFRyaWdnZXJlcigpO1xuICAgICAgICB0YXJnZXQuZ2V0VHJpZ2dlcmVyID0gKCk9PntcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFRyaWdnZXJlcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGFyZ2V0Lmxpc3RlbiA9IHRoaXMuZ2V0TGlzdGVuZXIoKTtcbiAgICAgICAgdGFyZ2V0Lm1hdGNoID0gdGhpcy5nZXRNYXRjaExpc3RlbmVyKCk7XG4gICAgICAgIHRhcmdldC5tYXRjaE9uY2UgPSB0aGlzLmdldE1hdGNoT25jZXIoKTtcbiAgICAgICAgdGFyZ2V0LnVubGlzdGVuID0gdGhpcy5nZXRVbmxpc3RlbmVyKCk7XG5cbiAgICAgICAgdGFyZ2V0Lm9uY2UgPSB0aGlzLmdldE9uY2VyKCk7XG5cbiAgICAgICAgdGFyZ2V0LndoZW4gPSB0aGlzLmdldFdoZW5lcigpO1xuICAgICAgICB0YXJnZXQudGhlbiA9IHRoaXMuZ2V0VGhlbmVyKCk7XG4gICAgICAgIHRhcmdldC5jYXRjaCAgPXRoaXMuZ2V0Q2F0Y2hlcigpO1xuXG4gICAgICAgIHJldHVybiB0YXJnZXQ7XG4gICAgfVxuXG4gICAgLyoqIFJldHVybnMgYSBjb250ZXh0LWluZGVwZW5kZW50IGNhbGxiYWNrIHRoYXQgdHJpZ2dlcnMgdGhlIGV2ZW50IHdpdGggZ2l2ZW4gYXJndW1lbnQgKi9cbiAgICBnZXRUcmlnZ2VyZXIoKTogRXZlbnRUcmlnZ2VyZXI8VD4geyByZXR1cm4gdGhpcy50cmlnZ2VyRGVsZWdhdGU7IH1cbiAgICBnZXRMaXN0ZW5lcigpOiBFdmVudExpc3RlbmVyPFQ+IHsgcmV0dXJuIHRoaXMubGlzdGVuRGVsZWdhdGU7IH1cbiAgICBnZXRNYXRjaExpc3RlbmVyKCk6IEV2ZW50TWF0Y2hMaXN0ZW5lcjxUPiB7IHJldHVybiB0aGlzLm1hdGNoRGVsZWdhdGU7IH1cbiAgICBnZXRNYXRjaE9uY2VyKCk6IEV2ZW50TWF0Y2hPbmNlcjxUPiB7IHJldHVybiB0aGlzLm1hdGNoT25jZURlbGVnYXRlOyB9XG4gICAgZ2V0VW5saXN0ZW5lcigpOiBFdmVudFVubGlzdGVuZXI8VD4geyByZXR1cm4gdGhpcy51bmxpc3RlbkRlbGVnYXRlOyB9XG4gICAgZ2V0T25jZXIoKTogRXZlbnRPbmNlcjxUPiB7IHJldHVybiB0aGlzLm9uY2VEZWxlZ2F0ZTsgfVxuICAgIGdldFdoZW5lcigpOiBFdmVudFdoZW5lcjxUPiB7IHJldHVybiB0aGlzLndoZW5EZWxlZ2F0ZTsgfVxuICAgIGdldFRoZW5lcigpOiBFdmVudFRoZW5lcjxUPiB7IHJldHVybiB0aGlzLnRoZW5EZWxlZ2F0ZTsgfVxuICAgIGdldENhdGNoZXIoKTogRXZlbnRDYXRjaGVyPFQ+IHsgcmV0dXJuIHRoaXMuY2F0Y2hEZWxlZ2F0ZTsgfVxuXG4gICAgLyoqXG4gICAgICogVHJpZ2dlcnMgdGhlIGV2ZW50IHdpdGggZ2l2ZW4gYXJndW1lbnQsIGludm9raW5nIGFsbCBvZiBpdHMgaGFuZGxlcnMsIGFuZCBpZlxuICAgICAqIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgZm9yIHRoZSBmaXJzdCB0aW1lIC0gcmVtb3ZpbmcgdGhlIG9uY2UgZXZlbnQgaGFuZGxlcnMgYW5kXG4gICAgICogc2F2aW5nIGdpdmVuIGFyZ3VtZW50IGluZXRybmFsbHkgYXMgZmlyc3QgdHJpZ2dlciBhcmd1bWVudC5cbiAgICAgKi9cbiAgICB0cmlnZ2VyKGV2ZW50QXJnPzogVCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5pc0JlaW5nVHJpZ2dlcmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV2ZW50IHRyaWdnZXJlZCBkdXJpbmcgdHJpZ2dlciBoYW5kbGluZyAtIHN1c3BlY3RpbmcgcmVjdXJzaXZlIGV2ZW50LmApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaXNCZWluZ1RyaWdnZXJlZCA9IHRydWU7XG4gICAgICAgIGlmICghdGhpcy5pc0ZpcnN0VHJpZ2dlckRvbmUpIHtcbiAgICAgICAgICAgIHRoaXMuaXNGaXJzdFRyaWdnZXJEb25lID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZShldmVudEFyZyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuc2xpY2UoKS5mb3JFYWNoKChsaXN0ZW5lcikgPT4ge1xuICAgICAgICAgICAgbGV0IGRvQ2FsbCA9IHRydWU7XG4gICAgICAgICAgICBpZiAobGlzdGVuZXIub25seU1hdGNoaW5nKSB7XG4gICAgICAgICAgICAgICAgZG9DYWxsID0gbGlzdGVuZXIubWF0Y2hWYWx1ZSA9PT0gZXZlbnRBcmc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChkb0NhbGwpIHtcbiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIuY29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lci5oYW5kbGVyLmNhbGwobGlzdGVuZXIuY29udGV4dCwgZXZlbnRBcmcpOyBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lci5oYW5kbGVyLmNhbGwobnVsbCwgZXZlbnRBcmcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIub25jZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmlzQmVpbmdUcmlnZ2VyZWQgPSBmYWxzZTtcbiAgICB9ICBcblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBsaXN0ZW5lci4gSWYgb25jZT10cnVlIHRoZW4gYWRkcyBvbmNlIGxpc3RlbmVyIHdoaWNoIG1lYW5zIHRoYXQgbGlzdGVuZXIgd2lsbCBiZSByZW1vdmVkLFxuICAgICAqIHdoZW4gZXZlbnQgdHJpZ2dlcnMgZm9yIHRoZSBmaXJzdCB0aW1lLiBBbHNvIGlmIGV2ZW50IGFsbHJlYWR5IHdhcyB0cmlnZ2VyZWQgZm9yIHRoZSBmaXJzdCB0aW1lXG4gICAgICogd2hlbiB5b3UgY2FsbCAnYWRkKCknIHRoZW4gb25jZSBsaXN0ZW5lciB3aWxsIG5vdCBiZSBhZGRlZCBidXQgaW5zdGVhZCBpbnZva2VkIGltbWlkaWF0ZWx5LFxuICAgICAqIHdpdGggYXJndW1lbnQsIHRoYXQgZXZlbnQgd2FzIHRyaWdnZXJlZCB3aXRoIHRoZSBmaXJzdCB0aW1lLlxuICAgICAqL1xuICAgIGxpc3RlbihoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG4gICAgbGlzdGVuKG5hbWU6IHN0cmluZywgaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuICAgIGxpc3RlbiguLi5hcmdzOiBhbnlbXSk6IG51bWJlciB7XG4gICAgICAgIGxldCBpZDogbnVtYmVyO1xuICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBsZXQgW25hbWUsIGhhbmRsZXIsIGNvbnRleHRdID0gYXJncztcbiAgICAgICAgICAgIGlkID0gdGhpcy5hZGRMaXN0ZW5lcih7IG5hbWUsIGhhbmRsZXIsIGNvbnRleHQgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgW2hhbmRsZXIsIGNvbnRleHRdID0gYXJncztcbiAgICAgICAgICAgIGlkID0gdGhpcy5hZGRMaXN0ZW5lcih7IGhhbmRsZXIsIGNvbnRleHQgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGlkO1xuICAgIH07XG5cbiAgICBtYXRjaCh2YWx1ZTogVCwgaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuICAgIG1hdGNoKHZhbHVlOiBULCBuYW1lOiBzdHJpbmcsIGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcbiAgICBtYXRjaCh2YWx1ZTogVCwgLi4uYXJnczogYW55W10pOiBudW1iZXIge1xuICAgICAgICBsZXQgaWQ6IG51bWJlcjtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgbGV0IFtuYW1lLCBoYW5kbGVyLCBjb250ZXh0XSA9IGFyZ3M7XG4gICAgICAgICAgICBpZCA9IHRoaXMuYWRkTGlzdGVuZXIoeyBuYW1lLCBoYW5kbGVyLCBjb250ZXh0LCBvbmx5TWF0Y2hpbmc6IHRydWUsIG1hdGNoVmFsdWU6IHZhbHVlIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IFtoYW5kbGVyLCBjb250ZXh0XSA9IGFyZ3M7XG4gICAgICAgICAgICBpZCA9IHRoaXMuYWRkTGlzdGVuZXIoeyBoYW5kbGVyLCBjb250ZXh0LCBvbmx5TWF0Y2hpbmc6IHRydWUsIG1hdGNoVmFsdWU6IHZhbHVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpZDtcbiAgICB9O1xuXG4gICAgbWF0Y2hPbmNlKHZhbHVlOiBULCBoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ6IE9iamVjdCA9IG51bGwpOiBudW1iZXIge1xuICAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoeyBjb250ZXh0LCBoYW5kbGVyLCBvbmNlOiB0cnVlLCBvbmx5TWF0Y2hpbmc6IHRydWUsIG1hdGNoVmFsdWU6IHZhbHVlIH0pO1xuICAgIH1cblxuICAgIG9uY2UoaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0OiBPYmplY3QgPSBudWxsKTogbnVtYmVyIHtcbiAgICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHsgY29udGV4dCwgaGFuZGxlciwgb25jZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBsaXN0ZW5lcihzKS4gV2hlbiBubyBjb250ZXh0IGdpdmVuIHJlbW92ZXMgYWxsIGxpc3RlbmVycywgdGhhdCB3ZXJlIGF0dGFjaGVkXG4gICAgICogd2l0aG91dCBhIGNvbnRleHQuIFdoZW4gYSBjb250ZXh0IGlzIGdpdmVuIHJlbW92ZXMgb25seSBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGF0dGFjaGVkIHdpdGhcbiAgICAgKiB0aGF0IGNvbnRleHQgYW5kIGRvZXNuJ3QgcmVtb3ZlIGFueSBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGF0dGFjaGVkIHdpdGhvdXQgYSBjb250ZXh0LlxuICAgICAqL1xuICAgIHVubGlzdGVuKGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG4gICAgdW5saXN0ZW4oY29udGV4dDogT2JqZWN0KTogdm9pZDtcbiAgICB1bmxpc3RlbihuYW1lOiBzdHJpbmcpOiB2b2lkO1xuICAgIHVubGlzdGVuKGlkOiBudW1iZXIpOiB2b2lkO1xuICAgIHVubGlzdGVuKCk6IHZvaWQ7XG4gICAgdW5saXN0ZW4oLi4uYXJnczogYW55W10pOiB2b2lkIHtcbiAgICAgICAgbGV0IG5hbWU6IHN0cmluZyA9IG51bGwsIGNvbnRleHQ6IE9iamVjdCwgaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBpZFRvUmVtb3ZlOiBudW1iZXIgPSBudWxsOyBcbiAgICAgICAgc3dpdGNoIChhcmdzLmxlbmd0aCkge1xuICAgICAgICAgICAgY2FzZSAwOiB0aGlzLmxpc3RlbmVycyA9IFtdOyByZXR1cm47XG4gICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICBuYW1lID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IGFyZ3NbMV07XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBhcmdzWzJdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIGlkVG9SZW1vdmUgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gYXJnc1sxXTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBhcmdzWzFdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBfLmZpbHRlcih0aGlzLmxpc3RlbmVycywgKGhDb25mOiBFdmVudEhhbmRsZXJEZXNjcmlwdG9yPFQ+KSA9PiB7XG4gICAgICAgICAgICBsZXQgZGlmZmVyZW50SGFuZGxlcjogYm9vbGVhbiA9IGhDb25mLmhhbmRsZXIgIT09IGhhbmRsZXI7XG4gICAgICAgICAgICBsZXQgbm9Db250ZXh0R2l2ZW46IGJvb2xlYW4gPSBjb250ZXh0ID09PSBudWxsO1xuICAgICAgICAgICAgbGV0IGNvbmZIYXNOb0NvbnRleHQ6IGJvb2xlYW4gPSAhIWhDb25mLmNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgZGlmZmVyZW50Q29udGV4dDogYm9vbGVhbiA9IGhDb25mLmNvbnRleHQgIT09IGNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgc2FtZU5hbWUgPSBuYW1lICYmIGhDb25mLm5hbWUgJiYgKG5hbWUgPT09IGhDb25mLm5hbWUpO1xuICAgICAgICAgICAgbGV0IGRvbnRSZW1vdmU6IGJvb2xlYW47XG4gICAgICAgICAgICBpZiAoaWRUb1JlbW92ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSBpZFRvUmVtb3ZlICE9PSBoQ29uZi5pZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9ICFzYW1lTmFtZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlmZmVyZW50SGFuZGxlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gbm9Db250ZXh0R2l2ZW4gPyAoIWNvbmZIYXNOb0NvbnRleHQpIDogKGNvbmZIYXNOb0NvbnRleHQgfHwgZGlmZmVyZW50Q29udGV4dCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBkb250UmVtb3ZlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBvbihuYW1lOiBzdHJpbmcsIGg6IEV2ZW50SGFuZGxlcjxUPik6IG51bWJlcjtcbiAgICBvbihoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4pOiBudW1iZXI7XG4gICAgb24obmFtZU9ySGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+fHN0cmluZywgaGFuZGxlck9yTm90aGluZz86IEV2ZW50SGFuZGxlcjxUPik6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmxpc3Rlbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cblxuICAgIG9mZihoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgIG9mZihjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgIG9mZihuYW1lOiBzdHJpbmcpOiB2b2lkO1xuICAgIG9mZihpZDogbnVtYmVyKTogdm9pZDtcbiAgICBvZmYoKTogdm9pZDtcbiAgICBvZmYoYnVsbHNoaXRXVEY/OiBFdmVudEhhbmRsZXI8VD58c3RyaW5nfG51bWJlciwgY29udGV4dD86IE9iamVjdCk6IHZvaWQge1xuICAgICAgICByZXR1cm4gdGhpcy51bmxpc3Rlbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cblxuICAgIHdoZW4oKTogUHJvbWlzZTxUPiB7IHJldHVybiB0aGlzLnByb21pc2U7IH1cbiAgICB0aGVuKG9uT2s6IChyOiBUKT0+IFR8YW55LCBvbkZhaWw/OiAoZTogYW55KT0+VHxhbnkpOiBQcm9taXNlPFQ+IHsgcmV0dXJuIHRoaXMud2hlbigpLnRoZW4ob25Paywgb25GYWlsKTsgfVxuICAgIGFmdGVyKG9uQW55OiAocjogVHxhbnkpPT5UfGFueSk6IFByb21pc2U8VD4geyByZXR1cm4gdGhpcy50aGVuKG9uQW55KS5jYXRjaChvbkFueSk7fVxuICAgIGNhdGNoKG9uRmFpbDogKGU6IGFueSk9PlR8YW55KTogUHJvbWlzZTxUPiB7IHJldHVybiB0aGlzLndoZW4oKS5jYXRjaChvbkZhaWwpOyB9XG5cbiAgICBwaXBlKG90aGVyOiBFdmVudDxUPik6IHZvaWQge1xuICAgICAgICB0aGlzLm9uKG90aGVyLmdldFRyaWdnZXJlcigpKTtcbiAgICB9XG4gICAgdW5waXBlKG90aGVyOiBFdmVudDxUPik6IHZvaWQge1xuICAgICAgICB0aGlzLm9mZihvdGhlci5nZXRUcmlnZ2VyZXIoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcjogRXZlbnRIYW5kbGVyRGVzY3JpcHRvcjxUPik6IHZvaWQge1xuICAgICAgICBsZXQgbGlzdGVuZXJJbmRleCA9IHRoaXMubGlzdGVuZXJzLmluZGV4T2YobGlzdGVuZXIpO1xuICAgICAgICBpZiAobGlzdGVuZXJJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzLnNwbGljZShsaXN0ZW5lckluZGV4LCAxKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYWRkTGlzdGVuZXIob3B0aW9uczogRXZlbnRIYW5kbGVyT3B0aW9uczxUPik6IG51bWJlciB7XG4gICAgICAgIGxldCB7Y29udGV4dCwgaGFuZGxlciwgb25jZSwgb25seU1hdGNoaW5nLCBtYXRjaFZhbHVlfSA9IG9wdGlvbnM7XG4gICAgICAgIHRoaXMuaWRDb3VudGVyKys7XG4gICAgICAgIHRoaXMubGlzdGVuZXJzLnB1c2goe2NvbnRleHQsIGhhbmRsZXIsIG9uY2UsIGlkOiB0aGlzLmlkQ291bnRlciwgb25seU1hdGNoaW5nLCBtYXRjaFZhbHVlfSk7XG4gICAgICAgIHJldHVybiB0aGlzLmlkQ291bnRlcjtcbiAgICB9XG5cbiAgICBzdGF0aWMgZXZlbnQ8RXZlbnRUPigpOiBQcm9wZXJ0eURlY29yYXRvciB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAocHJvdG90eXBlOiBPYmplY3QsIGV2ZW50TmFtZTogc3RyaW5nKTogUHJvcGVydHlEZXNjcmlwdG9yIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGdldCgpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGV2ZW50ID0gbmV3IEV2ZW50PEV2ZW50VD4oKTtcbiAgICAgICAgICAgICAgICAgICAgUmVmbGVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBldmVudE5hbWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBldmVudFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBzdGF0aWMgZW1pdHM8RXZlbnRUPihldmVudE5hbWU6IHN0cmluZykge1xuXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAocHJvdG90eXBlOiBPYmplY3QsIG1ldGhvZE5hbWU6IHN0cmluZywgb3JpZ2luYWw6IFByb3BlcnR5RGVzY3JpcHRvcik6IFByb3BlcnR5RGVzY3JpcHRvciB7XG4gICAgICAgICAgICBsZXQgb3JpZ2luYWxNZXRob2Q6IEZ1bmN0aW9uID0gb3JpZ2luYWwudmFsdWU7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBkZXNjcmlwdG9yID0ge1xuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgd3JpdGVhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB2YWx1ZSguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gb3JpZ2luYWxNZXRob2QuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXNbZXZlbnROYW1lXS50cmlnZ2VyKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiBkZXNjcmlwdG9yO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZW1pdHMobmFtZTogc3RyaW5nKTogTWV0aG9kRGVjb3JhdG9yIHtcbiAgICByZXR1cm4gRXZlbnQuZW1pdHMobmFtZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBldmVudChuYW1lOiBzdHJpbmcpOiBNZXRob2REZWNvcmF0b3Ige1xuICAgIHJldHVybiBFdmVudC5lbWl0cyhuYW1lKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgRXZlbnQ7Il19