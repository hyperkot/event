/// <reference path="../typings/index.d.ts"/>
Object.defineProperty(exports, "__esModule", { value: true });
function _objectMatch(subject, proto, traversalStack = []) {
    switch (typeof proto) {
        case "undefined": return subject === undefined;
        case "number":
        case "boolean":
        case "string":
        case "function":
            return subject === proto;
        case "object":
            let isMatching = true;
            if (traversalStack.length === 0) {
                if ((typeof subject === "string") && (proto instanceof RegExp)) {
                    isMatching = proto.test(subject);
                }
            }
            else {
                if (typeof subject !== "object") {
                    isMatching = false;
                }
                else {
                    if (!proto || !subject)
                        isMatching = !subject && !proto;
                    else if (traversalStack.includes(subject)) {
                        throw new Error("Recursion!");
                    }
                    else {
                        for (let key in proto) {
                            if (proto.hasOwnProperty(key)) {
                                traversalStack.push(subject);
                                isMatching = isMatching && _objectMatch(subject[key], proto[key], traversalStack);
                                traversalStack.pop();
                            }
                        }
                    }
                }
            }
            return isMatching;
        default:
            throw new Error(`Unexpected typeof: ${typeof proto}`);
    }
}
function objectMatch(subject, proto) {
    return _objectMatch(subject, proto);
}
/**
 * Represents an event and provides methods to observe it and to trigger(emit) it.
 */
class EventProperty {
    constructor() {
        this.listeners = [];
        this.isBeingTriggered = false;
        this.firstTriggerPromise = null;
        this.isFirstTriggerDone = false;
        this.idCounter = 0;
        this.firstTriggerPromise = new Promise((resolve, reject) => {
            this.resolveFirstTriggerPromise = resolve;
            this.rejectFirstTriggerPromise = reject;
        });
        this.emit = this.emit.bind(this);
    }
    /**
     * Emits the event with given argument, invoking all of its handlers, and if
     * the event is triggered for the first time - removing the once event handlers and
     * saving given argument internally as first emit argument.
     *
     * The argument is optional, since event can be of void type (`x= new Event<void>()`),
     * but if the event is not of a void type - you should always pass an argument to
     * the emit method.
     */
    emit(eventArg) {
        let resolveFirstTimeTrigger = false;
        let toInvoke;
        if (this.isBeingTriggered) {
            throw new Error(`Event triggered during trigger handling - suspecting recursive event.`);
        }
        this.isBeingTriggered = true;
        if (!this.isFirstTriggerDone) {
            this.isFirstTriggerDone = true;
            resolveFirstTimeTrigger = true;
        }
        toInvoke = this.listeners.slice().filter((listener) => {
            let shouldInvoke = !listener.onlyMatching || objectMatch(eventArg, listener.matchValue);
            if (listener.once) {
                this.removeListener(listener);
            }
            return shouldInvoke;
        });
        this.isBeingTriggered = false;
        toInvoke.forEach((listener) => {
            if (listener.context) {
                listener.handler.call(listener.context, eventArg);
            }
            else {
                listener.handler.call(null, eventArg);
            }
        });
        if (resolveFirstTimeTrigger) {
            this.resolveFirstTriggerPromise(eventArg);
        }
    }
    /**
     * Adds a listener. If once=true then adds once listener which means that listener will be removed,
     * when event triggers for the first time. Also if event already was triggered for the first time
     * when you call 'add()' then once listener will not be added but instead invoked immediately,
     * with argument, that event was triggered with the first time.
     */
    on(handler, context) {
        return this.addListener({ handler, context });
    }
    /**
     * Adds a listener to the event
     */
    once(handler, context = null) {
        return this.addListener({ context, handler, once: true });
    }
    /**
     * Adds a listener, which will be invoked only if the event-argument is deeply-equal to
     * the given value.
     */
    match(value, handler, context) {
        return this.addListener({ handler, context, onlyMatching: true, matchValue: value });
    }
    /**
     * Combines 'match' and 'once' features.
     */
    matchOnce(value, handler, context = null) {
        return this.addListener({
            context,
            handler,
            once: true,
            onlyMatching: true,
            matchValue: value
        });
    }
    off(...args) {
        let context = null, handler = null, idToRemove = null;
        switch (args.length) {
            case 0:
                this.listeners = [];
                return;
            case 1:
                if (EventProperty.isListenerId(args[0])) {
                    idToRemove = args[0];
                }
                else if (typeof args[0] === "function") {
                    handler = args[0];
                    context = null;
                }
                else if (typeof args[0] === "object") {
                    if (args[0] instanceof EventProperty) {
                        this.off(args[0].emit);
                        return;
                    }
                    handler = null;
                    context = args[0];
                }
                else {
                    throw new Error(`Invalid argument: ${typeof args[0]}`);
                }
                break;
            case 2:
                handler = args[0];
                context = args[1];
                break;
            default:
                throw new Error("Unsupported arguments format.");
        }
        this.listeners = this.listeners.filter((hConf) => {
            let differentHandler = hConf.handler !== handler;
            let noHandlerGiven = !handler;
            let noContextGiven = !context;
            let confHasNoContext = !hConf.context;
            let differentContext = hConf.context !== context;
            let dontRemove;
            if (idToRemove !== null) {
                dontRemove = idToRemove !== hConf.id;
            }
            else {
                if (noHandlerGiven) {
                    if (noContextGiven) {
                        throw new Error("Unexpected circumstances.");
                    }
                    else {
                        dontRemove = confHasNoContext || (context !== hConf.context);
                    }
                }
                else {
                    if (differentHandler) {
                        dontRemove = true;
                    }
                    else {
                        if (noContextGiven) {
                            dontRemove = (!confHasNoContext) || (differentHandler);
                        }
                        else {
                            dontRemove = differentContext || differentHandler;
                        }
                    }
                }
            }
            return dontRemove;
        });
    }
    next() {
        return new Promise((resolve, reject) => {
            try {
                this.once(resolve);
            }
            catch (e) {
                reject(e);
            }
        });
    }
    get first() {
        return this.firstTriggerPromise;
    }
    /**
     * Piping the events means that the other event must be triggered(happen) any time
     * this event happens and with exactly the same argument.
     */
    pipe(other) {
        return this.on(other.emit);
    }
    /**
     * Pipe only events with matching argument to destination event-property.
     * @param value
     * @param destination
     * @returns {EventProperty.ListenerId}
     */
    route(value, destination) {
        return this.match(value, destination.emit);
    }
    removeListener(listener) {
        let listenerIndex = this.listeners.indexOf(listener);
        if (listenerIndex !== -1) {
            this.listeners.splice(listenerIndex, 1);
        }
    }
    addListener(options) {
        let { context, handler, once, onlyMatching, matchValue } = options;
        this.idCounter++;
        this.listeners.push({ context, handler, once, id: this.idCounter, onlyMatching, matchValue });
        return this.idCounter;
    }
}
exports.EventProperty = EventProperty;
(function (EventProperty) {
    function isListenerId(id) {
        return typeof id === "number";
    }
    EventProperty.isListenerId = isListenerId;
    function make() {
        let eventProp = new EventProperty();
        let emitter = eventProp;
        return [eventProp, emitter];
    }
    EventProperty.make = make;
    function split() {
        let eventProp = new EventProperty();
        let emitter = eventProp;
        return [eventProp.emit, emitter];
    }
    EventProperty.split = split;
    function splitVoid() {
        let eventProp = new EventProperty.Void();
        let emitter = eventProp;
        return [eventProp.emit, emitter];
    }
    EventProperty.splitVoid = splitVoid;
    class Void extends EventProperty {
        constructor() {
            super();
        }
        emit() { return super.emit(void 0); }
    }
    EventProperty.Void = Void;
    ;
})(EventProperty = exports.EventProperty || (exports.EventProperty = {}));
exports.default = EventProperty;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZXZlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDOztBQUU3QyxzQkFBc0IsT0FBWSxFQUFFLEtBQVUsRUFBRSxpQkFBd0IsRUFBRTtJQUN0RSxNQUFNLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbkIsS0FBSyxXQUFXLEVBQUUsTUFBTSxDQUFDLE9BQU8sS0FBSyxTQUFTLENBQUM7UUFDL0MsS0FBSyxRQUFRLENBQUM7UUFDZCxLQUFLLFNBQVMsQ0FBQztRQUNmLEtBQUssUUFBUSxDQUFDO1FBQ2QsS0FBSyxVQUFVO1lBQ1gsTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLENBQUM7UUFDN0IsS0FBSyxRQUFRO1lBQ1QsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBRXRCLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssWUFBWSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdELFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNyQyxDQUFDO1lBQ0wsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7b0JBQzlCLFVBQVUsR0FBRyxLQUFLLENBQUM7Z0JBQ3ZCLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUM7d0JBQ25CLFVBQVUsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztvQkFDcEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUNsQyxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLEdBQUcsQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUM7NEJBQ3BCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dDQUM1QixjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dDQUM3QixVQUFVLEdBQUcsVUFBVSxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dDQUNsRixjQUFjLENBQUMsR0FBRyxFQUFFLENBQUM7NEJBQ3pCLENBQUM7d0JBQ0wsQ0FBQztvQkFDTCxDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDO1lBQ0QsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUN0QjtZQUNJLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLE9BQU8sS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM5RCxDQUFDO0FBQ0wsQ0FBQztBQUNELHFCQUFxQixPQUFZLEVBQUUsS0FBVTtJQUN6QyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBRUQ7O0dBRUc7QUFDSDtJQVlJO1FBWFEsY0FBUyxHQUF5QyxFQUFFLENBQUM7UUFDckQscUJBQWdCLEdBQVksS0FBSyxDQUFDO1FBRWxDLHdCQUFtQixHQUFlLElBQUksQ0FBQztRQUd2Qyx1QkFBa0IsR0FBWSxLQUFLLENBQUM7UUFFcEMsY0FBUyxHQUE2QixDQUFDLENBQUM7UUFLNUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsT0FBMkIsRUFBRSxNQUF3QjtZQUN6RixJQUFJLENBQUMsMEJBQTBCLEdBQUcsT0FBTyxDQUFDO1lBQzFDLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxNQUFNLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7Ozs7Ozs7T0FRRztJQUNILElBQUksQ0FBQyxRQUFXO1FBQ1osSUFBSSx1QkFBdUIsR0FBWSxLQUFLLENBQUM7UUFDN0MsSUFBSSxRQUE4QyxDQUFDO1FBRW5ELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7WUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx1RUFBdUUsQ0FBQyxDQUFDO1FBQzdGLENBQUM7UUFFRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1FBQzdCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1lBQy9CLHVCQUF1QixHQUFHLElBQUksQ0FBQztRQUNuQyxDQUFDO1FBRUQsUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBNEM7WUFDbEYsSUFBSSxZQUFZLEdBQUcsQ0FBQyxRQUFRLENBQUMsWUFBWSxJQUFJLFdBQVcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3hGLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2xDLENBQUM7WUFDRCxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUM5QixRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBNEM7WUFDMUQsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDdEQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMxQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDSCxFQUFFLENBQUMsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7WUFDMUIsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxFQUFFLENBQUMsT0FBaUMsRUFBRSxPQUFnQjtRQUNsRCxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRDs7T0FFRztJQUNILElBQUksQ0FBQyxPQUFpQyxFQUFFLFVBQWtCLElBQUk7UUFDMUQsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsS0FBZSxFQUFFLE9BQWlDLEVBQUUsT0FBZ0I7UUFDdEUsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDekYsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUyxDQUFDLEtBQVEsRUFBRSxPQUFpQyxFQUFFLFVBQWtCLElBQUk7UUFDeEUsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDcEIsT0FBTztZQUNQLE9BQU87WUFDUCxJQUFJLEVBQUUsSUFBSTtZQUNWLFlBQVksRUFBRSxJQUFJO1lBQ2xCLFVBQVUsRUFBRSxLQUFLO1NBQ3JCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFXRCxHQUFHLENBQUMsR0FBRyxJQUFXO1FBQ2QsSUFBSSxPQUFPLEdBQVcsSUFBSSxFQUN0QixPQUFPLEdBQTZCLElBQUksRUFDeEMsVUFBVSxHQUE2QixJQUFJLENBQUM7UUFDaEQsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDbEIsS0FBSyxDQUFDO2dCQUNGLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO2dCQUNwQixNQUFNLENBQUM7WUFDWCxLQUFLLENBQUM7Z0JBQ0YsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3RDLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLENBQUM7Z0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2xCLE9BQU8sR0FBRyxJQUFJLENBQUM7Z0JBQ25CLENBQUM7Z0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7b0JBQ3JDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxhQUFhLENBQUMsQ0FBQyxDQUFDO3dCQUNuQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDdkIsTUFBTSxDQUFDO29CQUNYLENBQUM7b0JBQ0QsT0FBTyxHQUFHLElBQUksQ0FBQztvQkFDZixPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE1BQU0sSUFBSSxLQUFLLENBQUMscUJBQXFCLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDM0QsQ0FBQztnQkFDRCxLQUFLLENBQUM7WUFDVixLQUFLLENBQUM7Z0JBQ0YsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEIsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEIsS0FBSyxDQUFDO1lBQ1Y7Z0JBQ0ksTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBeUM7WUFDN0UsSUFBSSxnQkFBZ0IsR0FBWSxLQUFLLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQztZQUMxRCxJQUFJLGNBQWMsR0FBWSxDQUFDLE9BQU8sQ0FBQztZQUN2QyxJQUFJLGNBQWMsR0FBWSxDQUFDLE9BQU8sQ0FBQztZQUN2QyxJQUFJLGdCQUFnQixHQUFZLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUMvQyxJQUFJLGdCQUFnQixHQUFZLEtBQUssQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDO1lBQzFELElBQUksVUFBbUIsQ0FBQztZQUV4QixFQUFFLENBQUMsQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdEIsVUFBVSxHQUFHLFVBQVUsS0FBSyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3pDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO29CQUNqQixFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO3dCQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7b0JBQ2pELENBQUM7b0JBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ0osVUFBVSxHQUFHLGdCQUFnQixJQUFJLENBQUMsT0FBTyxLQUFLLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDakUsQ0FBQztnQkFDTCxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQzt3QkFDbkIsVUFBVSxHQUFHLElBQUksQ0FBQztvQkFDdEIsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDSixFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDOzRCQUNqQixVQUFVLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO3dCQUMzRCxDQUFDO3dCQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNKLFVBQVUsR0FBRyxnQkFBZ0IsSUFBSSxnQkFBZ0IsQ0FBQzt3QkFDdEQsQ0FBQztvQkFDTCxDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDO1lBQ0QsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUN0QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxJQUFJO1FBQ0EsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBdUIsRUFBRSxNQUF3QjtZQUNqRSxJQUFJLENBQUM7Z0JBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN2QixDQUFDO1lBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDVCxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDZCxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ0wsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSSxDQUFDLEtBQXVCO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsS0FBZSxFQUFFLFdBQTZCO1FBQ2hELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVPLGNBQWMsQ0FBQyxRQUE0QztRQUMvRCxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyRCxFQUFFLENBQUMsQ0FBQyxhQUFhLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1QyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFdBQVcsQ0FBQyxPQUF3QztRQUN4RCxJQUFJLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBQyxHQUFHLE9BQU8sQ0FBQztRQUNqRSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFDLENBQUMsQ0FBQztRQUM1RixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0NBQ0o7QUEvTkQsc0NBK05DO0FBRUQsV0FBaUIsYUFBYTtJQVcxQixzQkFBNkIsRUFBTztRQUNoQyxNQUFNLENBQUMsT0FBTyxFQUFFLEtBQUssUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUFGZSwwQkFBWSxlQUUzQixDQUFBO0lBMEZEO1FBQ0ksSUFBSSxTQUFTLEdBQUcsSUFBSSxhQUFhLEVBQUssQ0FBQztRQUN2QyxJQUFJLE9BQU8sR0FBNkIsU0FBUyxDQUFDO1FBQ2xELE1BQU0sQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBSmUsa0JBQUksT0FJbkIsQ0FBQTtJQUVEO1FBQ0ksSUFBSSxTQUFTLEdBQUcsSUFBSSxhQUFhLEVBQUssQ0FBQztRQUN2QyxJQUFJLE9BQU8sR0FBNkIsU0FBUyxDQUFDO1FBQ2xELE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUplLG1CQUFLLFFBSXBCLENBQUE7SUFFRDtRQUNJLElBQUksU0FBUyxHQUFHLElBQUksYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pDLElBQUksT0FBTyxHQUFnQyxTQUFTLENBQUM7UUFDckQsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBSmUsdUJBQVMsWUFJeEIsQ0FBQTtJQUVELFVBQWtCLFNBQVEsYUFBbUI7UUFDekM7WUFDSSxLQUFLLEVBQUUsQ0FBQztRQUNaLENBQUM7UUFDRCxJQUFJLEtBQUssTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDeEM7SUFMWSxrQkFBSSxPQUtoQixDQUFBO0lBQUEsQ0FBQztBQUNOLENBQUMsRUEvSGdCLGFBQWEsR0FBYixxQkFBYSxLQUFiLHFCQUFhLFFBK0g3QjtBQUVELGtCQUFlLGFBQWEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL2luZGV4LmQudHNcIi8+XG5cbmZ1bmN0aW9uIF9vYmplY3RNYXRjaChzdWJqZWN0OiBhbnksIHByb3RvOiBhbnksIHRyYXZlcnNhbFN0YWNrOiBhbnlbXSA9IFtdKTogYm9vbGVhbiB7XG4gICAgc3dpdGNoICh0eXBlb2YgcHJvdG8pIHtcbiAgICAgICAgY2FzZSBcInVuZGVmaW5lZFwiOiByZXR1cm4gc3ViamVjdCA9PT0gdW5kZWZpbmVkO1xuICAgICAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgICAgIGNhc2UgXCJib29sZWFuXCI6XG4gICAgICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICAgICAgY2FzZSBcImZ1bmN0aW9uXCI6XG4gICAgICAgICAgICByZXR1cm4gc3ViamVjdCA9PT0gcHJvdG87XG4gICAgICAgIGNhc2UgXCJvYmplY3RcIjpcbiAgICAgICAgICAgIGxldCBpc01hdGNoaW5nID0gdHJ1ZTtcblxuICAgICAgICAgICAgaWYgKHRyYXZlcnNhbFN0YWNrLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmICgodHlwZW9mIHN1YmplY3QgPT09IFwic3RyaW5nXCIpICYmIChwcm90byBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNNYXRjaGluZyA9IHByb3RvLnRlc3Qoc3ViamVjdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHN1YmplY3QgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNNYXRjaGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcHJvdG8gfHwgIXN1YmplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICBpc01hdGNoaW5nID0gIXN1YmplY3QgJiYgIXByb3RvO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0cmF2ZXJzYWxTdGFjay5pbmNsdWRlcyhzdWJqZWN0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUmVjdXJzaW9uIVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiBwcm90bykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm90by5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYXZlcnNhbFN0YWNrLnB1c2goc3ViamVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzTWF0Y2hpbmcgPSBpc01hdGNoaW5nICYmIF9vYmplY3RNYXRjaChzdWJqZWN0W2tleV0sIHByb3RvW2tleV0sIHRyYXZlcnNhbFN0YWNrKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhdmVyc2FsU3RhY2sucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGlzTWF0Y2hpbmc7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZW9mOiAke3R5cGVvZiBwcm90b31gKTtcbiAgICB9XG59XG5mdW5jdGlvbiBvYmplY3RNYXRjaChzdWJqZWN0OiBhbnksIHByb3RvOiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gX29iamVjdE1hdGNoKHN1YmplY3QsIHByb3RvKTtcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIGFuIGV2ZW50IGFuZCBwcm92aWRlcyBtZXRob2RzIHRvIG9ic2VydmUgaXQgYW5kIHRvIHRyaWdnZXIoZW1pdCkgaXQuXG4gKi9cbmV4cG9ydCBjbGFzcyBFdmVudFByb3BlcnR5PFQ+IGltcGxlbWVudHMgRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+IHtcbiAgICBwcml2YXRlIGxpc3RlbmVyczogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPltdID0gW107XG4gICAgcHJpdmF0ZSBpc0JlaW5nVHJpZ2dlcmVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIGZpcnN0VHJpZ2dlclByb21pc2U6IFByb21pc2U8VD4gPSBudWxsO1xuICAgIHByaXZhdGUgcmVzb2x2ZUZpcnN0VHJpZ2dlclByb21pc2U6ICh2YWx1ZTogVCkgPT4gYW55O1xuICAgIHByaXZhdGUgcmVqZWN0Rmlyc3RUcmlnZ2VyUHJvbWlzZTogKHZhbHVlOiBhbnkpID0+IGFueTtcbiAgICBwcml2YXRlIGlzRmlyc3RUcmlnZ2VyRG9uZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBpZENvdW50ZXI6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCA9IDA7XG5cblxuICAgIGNvbnN0cnVjdG9yKCkge1xuXG4gICAgICAgIHRoaXMuZmlyc3RUcmlnZ2VyUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlOiAodmFsdWU6IFQpID0+IHZvaWQsIHJlamVjdDogKGU6IGFueSkgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlRmlyc3RUcmlnZ2VyUHJvbWlzZSA9IHJlc29sdmU7XG4gICAgICAgICAgICB0aGlzLnJlamVjdEZpcnN0VHJpZ2dlclByb21pc2UgPSByZWplY3Q7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZW1pdCA9IHRoaXMuZW1pdC5iaW5kKHRoaXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEVtaXRzIHRoZSBldmVudCB3aXRoIGdpdmVuIGFyZ3VtZW50LCBpbnZva2luZyBhbGwgb2YgaXRzIGhhbmRsZXJzLCBhbmQgaWZcbiAgICAgKiB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGZvciB0aGUgZmlyc3QgdGltZSAtIHJlbW92aW5nIHRoZSBvbmNlIGV2ZW50IGhhbmRsZXJzIGFuZFxuICAgICAqIHNhdmluZyBnaXZlbiBhcmd1bWVudCBpbnRlcm5hbGx5IGFzIGZpcnN0IGVtaXQgYXJndW1lbnQuXG4gICAgICogXG4gICAgICogVGhlIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBzaW5jZSBldmVudCBjYW4gYmUgb2Ygdm9pZCB0eXBlIChgeD0gbmV3IEV2ZW50PHZvaWQ+KClgKSxcbiAgICAgKiBidXQgaWYgdGhlIGV2ZW50IGlzIG5vdCBvZiBhIHZvaWQgdHlwZSAtIHlvdSBzaG91bGQgYWx3YXlzIHBhc3MgYW4gYXJndW1lbnQgdG9cbiAgICAgKiB0aGUgZW1pdCBtZXRob2QuXG4gICAgICovXG4gICAgZW1pdChldmVudEFyZzogVCk6IHZvaWQge1xuICAgICAgICBsZXQgcmVzb2x2ZUZpcnN0VGltZVRyaWdnZXI6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAgICAgbGV0IHRvSW52b2tlOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+W107XG5cbiAgICAgICAgaWYgKHRoaXMuaXNCZWluZ1RyaWdnZXJlZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFdmVudCB0cmlnZ2VyZWQgZHVyaW5nIHRyaWdnZXIgaGFuZGxpbmcgLSBzdXNwZWN0aW5nIHJlY3Vyc2l2ZSBldmVudC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaXNCZWluZ1RyaWdnZXJlZCA9IHRydWU7XG4gICAgICAgIGlmICghdGhpcy5pc0ZpcnN0VHJpZ2dlckRvbmUpIHtcbiAgICAgICAgICAgIHRoaXMuaXNGaXJzdFRyaWdnZXJEb25lID0gdHJ1ZTtcbiAgICAgICAgICAgIHJlc29sdmVGaXJzdFRpbWVUcmlnZ2VyID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRvSW52b2tlID0gdGhpcy5saXN0ZW5lcnMuc2xpY2UoKS5maWx0ZXIoKGxpc3RlbmVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+KSA9PiB7XG4gICAgICAgICAgICBsZXQgc2hvdWxkSW52b2tlID0gIWxpc3RlbmVyLm9ubHlNYXRjaGluZyB8fCBvYmplY3RNYXRjaChldmVudEFyZywgbGlzdGVuZXIubWF0Y2hWYWx1ZSk7XG4gICAgICAgICAgICBpZiAobGlzdGVuZXIub25jZSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHNob3VsZEludm9rZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuaXNCZWluZ1RyaWdnZXJlZCA9IGZhbHNlO1xuICAgICAgICB0b0ludm9rZS5mb3JFYWNoKChsaXN0ZW5lcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPikgPT4ge1xuICAgICAgICAgICAgaWYgKGxpc3RlbmVyLmNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICBsaXN0ZW5lci5oYW5kbGVyLmNhbGwobGlzdGVuZXIuY29udGV4dCwgZXZlbnRBcmcpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsaXN0ZW5lci5oYW5kbGVyLmNhbGwobnVsbCwgZXZlbnRBcmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHJlc29sdmVGaXJzdFRpbWVUcmlnZ2VyKSB7XG4gICAgICAgICAgICB0aGlzLnJlc29sdmVGaXJzdFRyaWdnZXJQcm9taXNlKGV2ZW50QXJnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBsaXN0ZW5lci4gSWYgb25jZT10cnVlIHRoZW4gYWRkcyBvbmNlIGxpc3RlbmVyIHdoaWNoIG1lYW5zIHRoYXQgbGlzdGVuZXIgd2lsbCBiZSByZW1vdmVkLFxuICAgICAqIHdoZW4gZXZlbnQgdHJpZ2dlcnMgZm9yIHRoZSBmaXJzdCB0aW1lLiBBbHNvIGlmIGV2ZW50IGFscmVhZHkgd2FzIHRyaWdnZXJlZCBmb3IgdGhlIGZpcnN0IHRpbWVcbiAgICAgKiB3aGVuIHlvdSBjYWxsICdhZGQoKScgdGhlbiBvbmNlIGxpc3RlbmVyIHdpbGwgbm90IGJlIGFkZGVkIGJ1dCBpbnN0ZWFkIGludm9rZWQgaW1tZWRpYXRlbHksXG4gICAgICogd2l0aCBhcmd1bWVudCwgdGhhdCBldmVudCB3YXMgdHJpZ2dlcmVkIHdpdGggdGhlIGZpcnN0IHRpbWUuXG4gICAgICovXG4gICAgb24oaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoeyBoYW5kbGVyLCBjb250ZXh0IH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBsaXN0ZW5lciB0byB0aGUgZXZlbnRcbiAgICAgKi9cbiAgICBvbmNlKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dDogT2JqZWN0ID0gbnVsbCk6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHsgY29udGV4dCwgaGFuZGxlciwgb25jZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbGlzdGVuZXIsIHdoaWNoIHdpbGwgYmUgaW52b2tlZCBvbmx5IGlmIHRoZSBldmVudC1hcmd1bWVudCBpcyBkZWVwbHktZXF1YWwgdG9cbiAgICAgKiB0aGUgZ2l2ZW4gdmFsdWUuXG4gICAgICovXG4gICAgbWF0Y2godmFsdWU6IFR8UmVnRXhwLCBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7IGhhbmRsZXIsIGNvbnRleHQsIG9ubHlNYXRjaGluZzogdHJ1ZSwgbWF0Y2hWYWx1ZTogdmFsdWUgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29tYmluZXMgJ21hdGNoJyBhbmQgJ29uY2UnIGZlYXR1cmVzLlxuICAgICAqL1xuICAgIG1hdGNoT25jZSh2YWx1ZTogVCwgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0OiBPYmplY3QgPSBudWxsKTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHtcbiAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgIGhhbmRsZXIsXG4gICAgICAgICAgICAgb25jZTogdHJ1ZSxcbiAgICAgICAgICAgICBvbmx5TWF0Y2hpbmc6IHRydWUsXG4gICAgICAgICAgICAgbWF0Y2hWYWx1ZTogdmFsdWVcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhIGxpc3RlbmVyKHMpLiBXaGVuIG5vIGNvbnRleHQgZ2l2ZW4gcmVtb3ZlcyBhbGwgbGlzdGVuZXJzIHRoYXQgd2VyZSBhdHRhY2hlZFxuICAgICAqIHdpdGhvdXQgYSBjb250ZXh0LiBXaGVuIGEgY29udGV4dCBpcyBnaXZlbiByZW1vdmVzIG9ubHkgbGlzdGVuZXJzIHRoYXQgd2VyZSBhdHRhY2hlZCB3aXRoXG4gICAgICogdGhhdCBjb250ZXh0IGFuZCBkb2Vzbid0IHJlbW92ZSBhbnkgbGlzdGVuZXJzIHRoYXQgd2VyZSBhdHRhY2hlZCB3aXRob3V0IGEgY29udGV4dC5cbiAgICAgKi9cbiAgICBvZmYoaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICBvZmYoY29udGV4dDogT2JqZWN0KTogdm9pZDtcbiAgICBvZmYoaWQ6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCk6IHZvaWQ7XG4gICAgb2ZmKGRlc3RpbmF0aW9uOiBFdmVudFByb3BlcnR5PFQ+KTogdm9pZDtcbiAgICBvZmYoKTogdm9pZDtcbiAgICBvZmYoLi4uYXJnczogYW55W10pOiB2b2lkIHtcbiAgICAgICAgbGV0IGNvbnRleHQ6IE9iamVjdCA9IG51bGwsXG4gICAgICAgICAgICBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4gPSBudWxsLFxuICAgICAgICAgICAgaWRUb1JlbW92ZTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkID0gbnVsbDtcbiAgICAgICAgc3dpdGNoIChhcmdzLmxlbmd0aCkge1xuICAgICAgICAgICAgY2FzZSAwOiAvLyBObyBhcmd1bWVudHMgLSBjbGVhciBhbGwgbGlzdGVuZXJzIFxuICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzID0gW107XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgY2FzZSAxOlxuICAgICAgICAgICAgICAgIGlmIChFdmVudFByb3BlcnR5LmlzTGlzdGVuZXJJZChhcmdzWzBdKSkge1xuICAgICAgICAgICAgICAgICAgICBpZFRvUmVtb3ZlID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBudWxsO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3NbMF0gPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3NbMF0gaW5zdGFuY2VvZiBFdmVudFByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9mZihhcmdzWzBdLmVtaXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJndW1lbnQ6ICR7dHlwZW9mIGFyZ3NbMF19YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBhcmdzWzFdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCBhcmd1bWVudHMgZm9ybWF0LlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnMuZmlsdGVyKChoQ29uZjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPikgPT4ge1xuICAgICAgICAgICAgbGV0IGRpZmZlcmVudEhhbmRsZXI6IGJvb2xlYW4gPSBoQ29uZi5oYW5kbGVyICE9PSBoYW5kbGVyO1xuICAgICAgICAgICAgbGV0IG5vSGFuZGxlckdpdmVuOiBib29sZWFuID0gIWhhbmRsZXI7XG4gICAgICAgICAgICBsZXQgbm9Db250ZXh0R2l2ZW46IGJvb2xlYW4gPSAhY29udGV4dDtcbiAgICAgICAgICAgIGxldCBjb25mSGFzTm9Db250ZXh0OiBib29sZWFuID0gIWhDb25mLmNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgZGlmZmVyZW50Q29udGV4dDogYm9vbGVhbiA9IGhDb25mLmNvbnRleHQgIT09IGNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgZG9udFJlbW92ZTogYm9vbGVhbjtcblxuICAgICAgICAgICAgaWYgKGlkVG9SZW1vdmUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gaWRUb1JlbW92ZSAhPT0gaENvbmYuaWQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChub0hhbmRsZXJHaXZlbikge1xuICAgICAgICAgICAgICAgICAgICBpZiAobm9Db250ZXh0R2l2ZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVuZXhwZWN0ZWQgY2lyY3Vtc3RhbmNlcy5cIik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gY29uZkhhc05vQ29udGV4dCB8fCAoY29udGV4dCAhPT0gaENvbmYuY29udGV4dCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlmZmVyZW50SGFuZGxlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9Db250ZXh0R2l2ZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gKCFjb25mSGFzTm9Db250ZXh0KSB8fCAoZGlmZmVyZW50SGFuZGxlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSBkaWZmZXJlbnRDb250ZXh0IHx8IGRpZmZlcmVudEhhbmRsZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9udFJlbW92ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbmV4dCgpOiBQcm9taXNlPFR8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmU6IChhOiBUKSA9PiB2b2lkLCByZWplY3Q6IChlOiBhbnkpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbmNlKHJlc29sdmUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0IGZpcnN0KCk6IFByb21pc2U8VHx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpcnN0VHJpZ2dlclByb21pc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGlwaW5nIHRoZSBldmVudHMgbWVhbnMgdGhhdCB0aGUgb3RoZXIgZXZlbnQgbXVzdCBiZSB0cmlnZ2VyZWQoaGFwcGVuKSBhbnkgdGltZVxuICAgICAqIHRoaXMgZXZlbnQgaGFwcGVucyBhbmQgd2l0aCBleGFjdGx5IHRoZSBzYW1lIGFyZ3VtZW50LlxuICAgICAqL1xuICAgIHBpcGUob3RoZXI6IEV2ZW50UHJvcGVydHk8VD4pOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICByZXR1cm4gdGhpcy5vbihvdGhlci5lbWl0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQaXBlIG9ubHkgZXZlbnRzIHdpdGggbWF0Y2hpbmcgYXJndW1lbnQgdG8gZGVzdGluYXRpb24gZXZlbnQtcHJvcGVydHkuXG4gICAgICogQHBhcmFtIHZhbHVlXG4gICAgICogQHBhcmFtIGRlc3RpbmF0aW9uXG4gICAgICogQHJldHVybnMge0V2ZW50UHJvcGVydHkuTGlzdGVuZXJJZH1cbiAgICAgKi9cbiAgICByb3V0ZSh2YWx1ZTogVHxSZWdFeHAsIGRlc3RpbmF0aW9uOiBFdmVudFByb3BlcnR5PFQ+KTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2godmFsdWUsIGRlc3RpbmF0aW9uLmVtaXQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXIobGlzdGVuZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD4pOiB2b2lkIHtcbiAgICAgICAgbGV0IGxpc3RlbmVySW5kZXggPSB0aGlzLmxpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKTtcbiAgICAgICAgaWYgKGxpc3RlbmVySW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVycy5zcGxpY2UobGlzdGVuZXJJbmRleCwgMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZExpc3RlbmVyKG9wdGlvbnM6IEV2ZW50UHJvcGVydHkuSGFuZGxlck9wdGlvbnM8VD4pOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICBsZXQge2NvbnRleHQsIGhhbmRsZXIsIG9uY2UsIG9ubHlNYXRjaGluZywgbWF0Y2hWYWx1ZX0gPSBvcHRpb25zO1xuICAgICAgICB0aGlzLmlkQ291bnRlcisrO1xuICAgICAgICB0aGlzLmxpc3RlbmVycy5wdXNoKHtjb250ZXh0LCBoYW5kbGVyLCBvbmNlLCBpZDogdGhpcy5pZENvdW50ZXIsIG9ubHlNYXRjaGluZywgbWF0Y2hWYWx1ZX0pO1xuICAgICAgICByZXR1cm4gdGhpcy5pZENvdW50ZXI7XG4gICAgfVxufVxuXG5leHBvcnQgbmFtZXNwYWNlIEV2ZW50UHJvcGVydHkge1xuXG4gICAgLyoqXG4gICAgICogVGhlIGNhbGxiYWNrIGZvcm1hdCB1c2VkIGZvciBhZGRpbmcgbGlzdGVuZXJzIHRvIGV2ZW50LXByb3BlcnRpZXMuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBIYW5kbGVyPFQ+IHtcbiAgICAgICAgKGV2ZW50QXJnOiBUKTogdm9pZDtcbiAgICB9XG5cbiAgICBleHBvcnQgdHlwZSBMaXN0ZW5lcklkID0gbnVtYmVyO1xuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGlzTGlzdGVuZXJJZChpZDogYW55KSB7XG4gICAgICAgIHJldHVybiB0eXBlb2YgaWQgPT09IFwibnVtYmVyXCI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhlIGZ1bGwgY29uZmlndXJhdGlvbiBmb3IgYSBzcGVjaWZpYyBldmVudC1oYW5kbGVyLiBJdCBjb250cm9scyB0aGUgd2F5XG4gICAgICogdGhlIHJlbGV2YW50IGV2ZW50LWhhbmRsZXIgZnVuY3Rpb24gaXMgaW52b2tlZC5cbiAgICAgKi9cbiAgICBleHBvcnQgaW50ZXJmYWNlIEhhbmRsZXJPcHRpb25zPFQ+IHtcbiAgICAgICAgLyoqIFRoZSBhY3R1YWwgaGFuZGxlciBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgb2NjdXJzLiAqL1xuICAgICAgICBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD47XG5cbiAgICAgICAgLyoqIElmIHRoaXMgZmxhZyBpcyBzZXQgLSB0aGUgZXZlbnQgaGFuZGxlciB3aWxsIHJlbW92ZSBpdHNlbGYgZnJvbSB0aGUgZXZlbnRcbiAgICAgICAgIGFmdGVyIGZpcnN0IGludm9jYXRpb24uICovXG4gICAgICAgIG9uY2U/OiBib29sZWFuO1xuXG4gICAgICAgIC8qKiBJZiB0aGlzIGZpZWxkIGlzIHNwZWNpZmllZCwgdGhlbiBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhhdCBjb250ZXh0LiAqL1xuICAgICAgICBjb250ZXh0PzogT2JqZWN0O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBbHdheXMgdXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIGZvbGxvd2luZyBwYXJhbWV0ZXIgJ21hdGNoVmFsdWUnIGFuZCBpcyBhXG4gICAgICAgICAqIGZsYWcsIHdoaWNoIG1lYW5zKGlmIHNldCkgdGhhdCBvbmx5IGV2ZW50IGludm9jYXRpb25zIHdpdGggYXJndW1lbnQgZXF1YWxcbiAgICAgICAgICogdG8gdGhhdCBwcmVkZWZpbmVkICdtYXRjaFZhbHVlJyBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uLlxuICAgICAgICAgKiBCYXNpY2FsbHkgdGhpcyBpcyBhIHNob3J0aGFuZCBmb3IgdGhlIGNvZGUgbGlrZSB0aGlzOlxuICAgICAgICAgKlxuICAgICAgICAgKiAgZXZlbnQubGlzdGVuKChhcmcpID0+IHtcbiAgICAgICAgICogICAgICBpZihhcmcgPT09IG1hdGNoVmFsdWUpKSBldmVudC5jYWxsSGFuZGxlcigpO1xuICAgICAgICAgKiB9KTtcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge1t0eXBlXX1cbiAgICAgICAgICovXG4gICAgICAgIG9ubHlNYXRjaGluZz86IGJvb2xlYW47XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSB2YWx1ZSwgdG8gYmUgbWF0Y2hlZCBpZiB0aGUgJ29ubHlNYXRjaGluZycgZmxhZyBpcyBzZXQuXG4gICAgICAgICAqIEB0eXBlIHtbdHlwZV19XG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaFZhbHVlPzogVHxSZWdFeHA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyB0aGUgb2JqZWN0IHdoaWNoIHJlcHJlc2VudHMgYW4gZXhpc3RpbmcgaGFuZGxlciBpbnRlcm5hbGx5IGluIEV2ZW50IG9iamVjdC5cbiAgICAgKi9cbiAgICBleHBvcnQgaW50ZXJmYWNlIEhhbmRsZXJEZXNjcmlwdG9yPFQ+IGV4dGVuZHMgSGFuZGxlck9wdGlvbnM8VD4ge1xuICAgICAgICBpZDogTGlzdGVuZXJJZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVudC1wcm9wZXJ0eSBpbnRlcmZhY2Ugd2l0aG91dCB0aGUgJ2VtaXQnIG1ldGhvZC5cbiAgICAgKi9cbiAgICBleHBvcnQgaW50ZXJmYWNlIEVtaXR0ZXI8VD4ge1xuICAgICAgICAvKipcbiAgICAgICAgICogQWRkIGV2ZW50IGhhbmRsZXIgdG8gdGhpcyBldmVudC4gT3B0aW9uYWxseSBwYXNzIGEgY29udGV4dCBpbiBzZWNvbmQgYXJndW1lbnQgLVxuICAgICAgICAgKiB0aGVuIHdoZW4gdHJpZ2dlcmVkIHRoaXMgIGV2ZW50IHdpbGwgY2FsbCB0aGUgJ2gnIGhhbmRsZXIgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dC5cbiAgICAgICAgICovXG4gICAgICAgIG9uKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IExpc3RlbmVySWQ7XG5cbiAgICAgICAgb25jZShoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBMaXN0ZW5lcklkO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBZGQgZXZlbnQgaGFuZGxlciB0byB0aGlzIGV2ZW50LCB3aGljaCB3aWxsIGJlIGNhbGxlZCBvbmx5IHdoZW4gZXZlbnQgaXMgdHJpZ2dlcmVkXG4gICAgICAgICAqIHdpdGggdmFsdWUsIHdoaWNoIGlzIGV4YWN0bHkoPT09KSB0aGUgc2FtZSBhcyB0aGUgb25lIHlvdSBwYXNzIHRvIHRoZSBtYXRjaFxuICAgICAgICAgKiBtZXRob2QgYXMgZmlyc3QgYXJndW1lbnRcbiAgICAgICAgICovXG4gICAgICAgIG1hdGNoKHZhbHVlOiBUfFJlZ0V4cCwgaDogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogTGlzdGVuZXJJZDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQWRkcyBhbiBldmVudCBoYW5kbGVyLlxuICAgICAgICAgKiBDb21iaW5lcyB0aGUgJ29uY2UnIGFuZCB0aGUgJ21hdGNoJyBiZWhhdmlvdXJzLlxuICAgICAgICAgKi9cbiAgICAgICAgbWF0Y2hPbmNlKHZhbHVlOiBUfFJlZ0V4cCwgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogTGlzdGVuZXJJZDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQW4gYWxpYXMgZm9yIHVubGlzdGVuXG4gICAgICAgICAqL1xuICAgICAgICBvZmYoaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICAgICAgb2ZmKGNvbnRleHQ6IE9iamVjdCk6IHZvaWQ7XG4gICAgICAgIG9mZihpZDogTGlzdGVuZXJJZCk6IHZvaWQ7XG4gICAgICAgIG9mZihkZXN0aW5hdGlvbjogRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+KTogdm9pZDtcbiAgICAgICAgb2ZmKCk6IHZvaWQ7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFBpcGluZyB0aGUgZXZlbnQgdG8gYW5vdGhlciBvbmUgbWVhbnMgdGhhdCB3aGVuZXZlciB0aGUgZmlyc3Qgb25lIGlzIHRyaWdnZXJlZCAtIHRoZVxuICAgICAgICAgKiBzZWNvbmQgb25lIGlzIHRyaWdnZXJlZCBhdXRvbWF0aWNhbGx5IHdpdGggZXhhY3RseSB0aGUgc2FtZSBhcmd1bWVudFxuICAgICAgICAgKi9cbiAgICAgICAgcGlwZShkZXN0aW5hdGlvbjogRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+KTogTGlzdGVuZXJJZDtcbiAgICAgICAgcm91dGUodmFsdWU6IFR8UmVnRXhwLCBkZXN0aW5hdGlvbjogRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+KTogTGlzdGVuZXJJZDtcblxuICAgICAgICBmaXJzdDogUHJvbWlzZTxUPjtcbiAgICAgICAgbmV4dCgpOiBQcm9taXNlPFQ+O1xuICAgIH1cblxuICAgIGV4cG9ydCBmdW5jdGlvbiBtYWtlPFQ+KCk6IFtFdmVudFByb3BlcnR5PFQ+LCBFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD5dIHtcbiAgICAgICAgbGV0IGV2ZW50UHJvcCA9IG5ldyBFdmVudFByb3BlcnR5PFQ+KCk7XG4gICAgICAgIGxldCBlbWl0dGVyID0gPEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPj5ldmVudFByb3A7XG4gICAgICAgIHJldHVybiBbZXZlbnRQcm9wLCBlbWl0dGVyXTtcbiAgICB9XG5cbiAgICBleHBvcnQgZnVuY3Rpb24gc3BsaXQ8VD4oKTogWyhhcmc6IFQpID0+IHZvaWQsIEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPl0ge1xuICAgICAgICBsZXQgZXZlbnRQcm9wID0gbmV3IEV2ZW50UHJvcGVydHk8VD4oKTtcbiAgICAgICAgbGV0IGVtaXR0ZXIgPSA8RXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+PmV2ZW50UHJvcDtcbiAgICAgICAgcmV0dXJuIFtldmVudFByb3AuZW1pdCwgZW1pdHRlcl07XG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIHNwbGl0Vm9pZCgpOiBbKCkgPT4gdm9pZCwgRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPHZvaWQ+XSB7XG4gICAgICAgIGxldCBldmVudFByb3AgPSBuZXcgRXZlbnRQcm9wZXJ0eS5Wb2lkKCk7XG4gICAgICAgIGxldCBlbWl0dGVyID0gPEV2ZW50UHJvcGVydHkuRW1pdHRlcjx2b2lkPj5ldmVudFByb3A7XG4gICAgICAgIHJldHVybiBbZXZlbnRQcm9wLmVtaXQsIGVtaXR0ZXJdO1xuICAgIH1cblxuICAgIGV4cG9ydCBjbGFzcyBWb2lkIGV4dGVuZHMgRXZlbnRQcm9wZXJ0eTx2b2lkPiB7XG4gICAgICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgfVxuICAgICAgICBlbWl0KCkgeyByZXR1cm4gc3VwZXIuZW1pdCh2b2lkIDApOyB9XG4gICAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgRXZlbnRQcm9wZXJ0eTsiXX0=