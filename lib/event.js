/// <reference path="../typings/index.d.ts"/>
Object.defineProperty(exports, "__esModule", { value: true });
function _objectMatch(subject, proto, traversalStack = []) {
    switch (typeof proto) {
        case "undefined": return subject === undefined;
        case "number":
        case "boolean":
        case "string":
        case "function":
            return subject === proto;
        case "object":
            let isMatching = true;
            if (traversalStack.length === 0) {
                if ((typeof subject === "string") && (proto instanceof RegExp)) {
                    isMatching = proto.test(subject);
                }
            }
            else {
                if (typeof subject !== "object") {
                    isMatching = false;
                }
                else {
                    if (!proto || !subject)
                        isMatching = !subject && !proto;
                    else if (traversalStack.includes(subject)) {
                        throw new Error("Recursion!");
                    }
                    else {
                        for (let key in proto) {
                            if (proto.hasOwnProperty(key)) {
                                traversalStack.push(subject);
                                isMatching = isMatching && _objectMatch(subject[key], proto[key], traversalStack);
                                traversalStack.pop();
                            }
                        }
                    }
                }
            }
            return isMatching;
        default:
            throw new Error(`Unexpected typeof: ${typeof proto}`);
    }
}
function objectMatch(subject, proto) {
    return _objectMatch(subject, proto);
}
/**
 * Represents an event and provides methods to observe it and to trigger(emit) it.
 */
class EventProperty {
    constructor() {
        this.listeners = [];
        this.isBeingTriggered = false;
        this.firstTriggerPromise = null;
        this.isFirstTriggerDone = false;
        this.idCounter = 0;
        this.firstTriggerPromise = new Promise((resolve, reject) => {
            this.resolveFirstTriggerPromise = resolve;
            this.rejectFirstTriggerPromise = reject;
        });
        this.emit = this.emit.bind(this);
    }
    /**
     * Emits the event with given argument, invoking all of its handlers, and if
     * the event is triggered for the first time - removing the once event handlers and
     * saving given argument internally as first emit argument.
     *
     * The argument is optional, since event can be of void type (`x= new Event<void>()`),
     * but if the event is not of a void type - you should always pass an argument to
     * the emit method.
     */
    emit(eventArg) {
        let resolveFirstTimeTrigger = false;
        let toInvoke;
        if (this.isBeingTriggered) {
            throw new Error(`Event triggered during trigger handling - suspecting recursive event.`);
        }
        this.isBeingTriggered = true;
        if (!this.isFirstTriggerDone) {
            this.isFirstTriggerDone = true;
            resolveFirstTimeTrigger = true;
        }
        toInvoke = this.listeners.slice().filter((listener) => {
            let shouldInvoke = !listener.onlyMatching || objectMatch(eventArg, listener.matchValue);
            if (listener.once) {
                this.removeListener(listener);
            }
            return shouldInvoke;
        });
        this.isBeingTriggered = false;
        toInvoke.forEach((listener) => {
            if (listener.context) {
                listener.handler.call(listener.context, eventArg);
            }
            else {
                listener.handler.call(null, eventArg);
            }
        });
        if (resolveFirstTimeTrigger) {
            this.resolveFirstTriggerPromise(eventArg);
        }
    }
    /**
     * Adds a listener. If once=true then adds once listener which means that listener will be removed,
     * when event triggers for the first time. Also if event already was triggered for the first time
     * when you call 'add()' then once listener will not be added but instead invoked immediately,
     * with argument, that event was triggered with the first time.
     */
    on(handler, context) {
        return this.addListener({ handler, context });
    }
    /**
     * Adds a listener to the event
     */
    once(handler, context = null) {
        return this.addListener({ context, handler, once: true });
    }
    /**
     * Adds a listener, which will be invoked only if the event-argument is deeply-equal to
     * the given value.
     */
    match(value, handler, context) {
        return this.addListener({ handler, context, onlyMatching: true, matchValue: value });
    }
    /**
     * Combines 'match' and 'once' features.
     */
    matchOnce(value, handler, context = null) {
        return this.addListener({
            context,
            handler,
            once: true,
            onlyMatching: true,
            matchValue: value
        });
    }
    off(...args) {
        let context = null, handler = null, idToRemove = null;
        switch (args.length) {
            case 0:
                this.listeners = [];
                return;
            case 1:
                if (EventProperty.isListenerId(args[0])) {
                    idToRemove = args[0];
                }
                else if (typeof args[0] === "function") {
                    handler = args[0];
                    context = null;
                }
                else if (typeof args[0] === "object") {
                    if (args[0] instanceof EventProperty) {
                        this.off(args[0].emit);
                        return;
                    }
                    handler = null;
                    context = args[0];
                }
                else {
                    throw new Error(`Invalid argument: ${typeof args[0]}`);
                }
                break;
            case 2:
                handler = args[0];
                context = args[1];
                break;
            default:
                throw new Error("Unsupported arguments format.");
        }
        this.listeners = this.listeners.filter((hConf) => {
            let differentHandler = hConf.handler !== handler;
            let noHandlerGiven = !handler;
            let noContextGiven = !context;
            let confHasNoContext = !hConf.context;
            let differentContext = hConf.context !== context;
            let dontRemove;
            if (idToRemove !== null) {
                dontRemove = idToRemove !== hConf.id;
            }
            else {
                if (noHandlerGiven) {
                    if (noContextGiven) {
                        throw new Error("Unexpected circumstances.");
                    }
                    else {
                        dontRemove = confHasNoContext || (context !== hConf.context);
                    }
                }
                else {
                    if (differentHandler) {
                        dontRemove = true;
                    }
                    else {
                        if (noContextGiven) {
                            dontRemove = (!confHasNoContext) || (differentHandler);
                        }
                        else {
                            dontRemove = differentContext || differentHandler;
                        }
                    }
                }
            }
            return dontRemove;
        });
    }
    next() {
        return new Promise((resolve, reject) => {
            try {
                this.once(resolve);
            }
            catch (e) {
                reject(e);
            }
        });
    }
    first() {
        return this.firstTriggerPromise;
    }
    /**
     * Piping the events means that the other event must be triggered(happen) any time
     * this event happens and with exactly the same argument.
     */
    pipe(other) {
        return this.on(other.emit);
    }
    /**
     * Pipe only events with matching argument to destination event-property.
     * @param value
     * @param destination
     * @returns {EventProperty.ListenerId}
     */
    route(value, destination) {
        return this.match(value, destination.emit);
    }
    removeListener(listener) {
        let listenerIndex = this.listeners.indexOf(listener);
        if (listenerIndex !== -1) {
            this.listeners.splice(listenerIndex, 1);
        }
    }
    addListener(options) {
        let { context, handler, once, onlyMatching, matchValue } = options;
        this.idCounter++;
        this.listeners.push({ context, handler, once, id: this.idCounter, onlyMatching, matchValue });
        return this.idCounter;
    }
}
exports.EventProperty = EventProperty;
(function (EventProperty) {
    function isListenerId(id) {
        return typeof id === "number";
    }
    EventProperty.isListenerId = isListenerId;
    function make() {
        let eventProp = new EventProperty();
        let emitter = eventProp;
        return [eventProp, emitter];
    }
    EventProperty.make = make;
})(EventProperty = exports.EventProperty || (exports.EventProperty = {}));
exports.default = EventProperty;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZXZlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDOztBQUU3QyxzQkFBc0IsT0FBWSxFQUFFLEtBQVUsRUFBRSxpQkFBd0IsRUFBRTtJQUN0RSxNQUFNLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbkIsS0FBSyxXQUFXLEVBQUUsTUFBTSxDQUFDLE9BQU8sS0FBSyxTQUFTLENBQUM7UUFDL0MsS0FBSyxRQUFRLENBQUM7UUFDZCxLQUFLLFNBQVMsQ0FBQztRQUNmLEtBQUssUUFBUSxDQUFDO1FBQ2QsS0FBSyxVQUFVO1lBQ1gsTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLENBQUM7UUFDN0IsS0FBSyxRQUFRO1lBQ1QsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBRXRCLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssWUFBWSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdELFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNyQyxDQUFDO1lBQ0wsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7b0JBQzlCLFVBQVUsR0FBRyxLQUFLLENBQUM7Z0JBQ3ZCLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUM7d0JBQ25CLFVBQVUsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztvQkFDcEMsSUFBSSxDQUFDLEVBQUUs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QUksU0FBUyxHQUFHLElBQUksYUFBYSxFQUFLLENBQUM7UUFDdkMsSUFBSSxPQUFPLEdBQTZCLFNBQVMsQ0FBQztRQUNsRCxNQUFNLENBQUMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUplLGtCQUFJLE9BSW5CLENBQUE7QUFDTCxDQUFDLEVBM0dnQixhQUFhLEdBQWIscUJBQWEsS0FBYixxQkFBYSxRQTJHN0I7QUFRRCxrQkFBZSxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9pbmRleC5kLnRzXCIvPlxuXG5mdW5jdGlvbiBfb2JqZWN0TWF0Y2goc3ViamVjdDogYW55LCBwcm90bzogYW55LCB0cmF2ZXJzYWxTdGFjazogYW55W10gPSBbXSk6IGJvb2xlYW4ge1xuICAgIHN3aXRjaCAodHlwZW9mIHByb3RvKSB7XG4gICAgICAgIGNhc2UgXCJ1bmRlZmluZWRcIjogcmV0dXJuIHN1YmplY3QgPT09IHVuZGVmaW5lZDtcbiAgICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIGNhc2UgXCJmdW5jdGlvblwiOlxuICAgICAgICAgICAgcmV0dXJuIHN1YmplY3QgPT09IHByb3RvO1xuICAgICAgICBjYXNlIFwib2JqZWN0XCI6XG4gICAgICAgICAgICBsZXQgaXNNYXRjaGluZyA9IHRydWU7XG5cbiAgICAgICAgICAgIGlmICh0cmF2ZXJzYWxTdGFjay5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZiBzdWJqZWN0ID09PSBcInN0cmluZ1wiKSAmJiAocHJvdG8gaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTWF0Y2hpbmcgPSBwcm90by50ZXN0KHN1YmplY3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdWJqZWN0ICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTWF0Y2hpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3RvIHx8ICFzdWJqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgaXNNYXRjaGluZyA9ICFzdWJqZWN0ICYmICFwcm90bztcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHJhdmVyc2FsU3RhY2suaW5jbHVkZXMoc3ViamVjdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlY3Vyc2lvbiFcIik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gcHJvdG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvdG8uaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzYWxTdGFjay5wdXNoKHN1YmplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc01hdGNoaW5nID0gaXNNYXRjaGluZyAmJiBfb2JqZWN0TWF0Y2goc3ViamVjdFtrZXldLCBwcm90b1trZXldLCB0cmF2ZXJzYWxTdGFjayk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYXZlcnNhbFN0YWNrLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBpc01hdGNoaW5nO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGVvZjogJHt0eXBlb2YgcHJvdG99YCk7XG4gICAgfVxufVxuZnVuY3Rpb24gb2JqZWN0TWF0Y2goc3ViamVjdDogYW55LCBwcm90bzogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIF9vYmplY3RNYXRjaChzdWJqZWN0LCBwcm90byk7XG59XG5cbi8qKlxuICogUmVwcmVzZW50cyBhbiBldmVudCBhbmQgcHJvdmlkZXMgbWV0aG9kcyB0byBvYnNlcnZlIGl0IGFuZCB0byB0cmlnZ2VyKGVtaXQpIGl0LlxuICovXG5leHBvcnQgY2xhc3MgRXZlbnRQcm9wZXJ0eTxUPiBpbXBsZW1lbnRzIEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPiB7XG4gICAgcHJpdmF0ZSBsaXN0ZW5lcnM6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD5bXSA9IFtdO1xuICAgIHByaXZhdGUgaXNCZWluZ1RyaWdnZXJlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBmaXJzdFRyaWdnZXJQcm9taXNlOiBQcm9taXNlPFQ+ID0gbnVsbDtcbiAgICBwcml2YXRlIHJlc29sdmVGaXJzdFRyaWdnZXJQcm9taXNlOiAodmFsdWU6IFQpID0+IGFueTtcbiAgICBwcml2YXRlIHJlamVjdEZpcnN0VHJpZ2dlclByb21pc2U6ICh2YWx1ZTogYW55KSA9PiBhbnk7XG4gICAgcHJpdmF0ZSBpc0ZpcnN0VHJpZ2dlckRvbmU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHByaXZhdGUgaWRDb3VudGVyOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQgPSAwO1xuXG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcblxuICAgICAgICB0aGlzLmZpcnN0VHJpZ2dlclByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKHZhbHVlOiBUKSA9PiB2b2lkLCByZWplY3Q6IChlOiBhbnkpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZUZpcnN0VHJpZ2dlclByb21pc2UgPSByZXNvbHZlO1xuICAgICAgICAgICAgdGhpcy5yZWplY3RGaXJzdFRyaWdnZXJQcm9taXNlID0gcmVqZWN0O1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVtaXQgPSB0aGlzLmVtaXQuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBFbWl0cyB0aGUgZXZlbnQgd2l0aCBnaXZlbiBhcmd1bWVudCwgaW52b2tpbmcgYWxsIG9mIGl0cyBoYW5kbGVycywgYW5kIGlmXG4gICAgICogdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBmb3IgdGhlIGZpcnN0IHRpbWUgLSByZW1vdmluZyB0aGUgb25jZSBldmVudCBoYW5kbGVycyBhbmRcbiAgICAgKiBzYXZpbmcgZ2l2ZW4gYXJndW1lbnQgaW50ZXJuYWxseSBhcyBmaXJzdCBlbWl0IGFyZ3VtZW50LlxuICAgICAqIFxuICAgICAqIFRoZSBhcmd1bWVudCBpcyBvcHRpb25hbCwgc2luY2UgZXZlbnQgY2FuIGJlIG9mIHZvaWQgdHlwZSAoYHg9IG5ldyBFdmVudDx2b2lkPigpYCksXG4gICAgICogYnV0IGlmIHRoZSBldmVudCBpcyBub3Qgb2YgYSB2b2lkIHR5cGUgLSB5b3Ugc2hvdWxkIGFsd2F5cyBwYXNzIGFuIGFyZ3VtZW50IHRvXG4gICAgICogdGhlIGVtaXQgbWV0aG9kLlxuICAgICAqL1xuICAgIGVtaXQoZXZlbnRBcmc/OiBUKTogdm9pZCB7XG4gICAgICAgIGxldCByZXNvbHZlRmlyc3RUaW1lVHJpZ2dlcjogYm9vbGVhbiA9IGZhbHNlO1xuICAgICAgICBsZXQgdG9JbnZva2U6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD5bXTtcblxuICAgICAgICBpZiAodGhpcy5pc0JlaW5nVHJpZ2dlcmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV2ZW50IHRyaWdnZXJlZCBkdXJpbmcgdHJpZ2dlciBoYW5kbGluZyAtIHN1c3BlY3RpbmcgcmVjdXJzaXZlIGV2ZW50LmApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pc0JlaW5nVHJpZ2dlcmVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKCF0aGlzLmlzRmlyc3RUcmlnZ2VyRG9uZSkge1xuICAgICAgICAgICAgdGhpcy5pc0ZpcnN0VHJpZ2dlckRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgcmVzb2x2ZUZpcnN0VGltZVRyaWdnZXIgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgdG9JbnZva2UgPSB0aGlzLmxpc3RlbmVycy5zbGljZSgpLmZpbHRlcigobGlzdGVuZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD4pID0+IHtcbiAgICAgICAgICAgIGxldCBzaG91bGRJbnZva2UgPSAhbGlzdGVuZXIub25seU1hdGNoaW5nIHx8IG9iamVjdE1hdGNoKGV2ZW50QXJnLCBsaXN0ZW5lci5tYXRjaFZhbHVlKTtcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lci5vbmNlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gc2hvdWxkSW52b2tlO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5pc0JlaW5nVHJpZ2dlcmVkID0gZmFsc2U7XG4gICAgICAgIHRvSW52b2tlLmZvckVhY2goKGxpc3RlbmVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+KSA9PiB7XG4gICAgICAgICAgICBpZiAobGlzdGVuZXIuY29udGV4dCkge1xuICAgICAgICAgICAgICAgIGxpc3RlbmVyLmhhbmRsZXIuY2FsbChsaXN0ZW5lci5jb250ZXh0LCBldmVudEFyZyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxpc3RlbmVyLmhhbmRsZXIuY2FsbChudWxsLCBldmVudEFyZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAocmVzb2x2ZUZpcnN0VGltZVRyaWdnZXIpIHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZUZpcnN0VHJpZ2dlclByb21pc2UoZXZlbnRBcmcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGxpc3RlbmVyLiBJZiBvbmNlPXRydWUgdGhlbiBhZGRzIG9uY2UgbGlzdGVuZXIgd2hpY2ggbWVhbnMgdGhhdCBsaXN0ZW5lciB3aWxsIGJlIHJlbW92ZWQsXG4gICAgICogd2hlbiBldmVudCB0cmlnZ2VycyBmb3IgdGhlIGZpcnN0IHRpbWUuIEFsc28gaWYgZXZlbnQgYWxyZWFkeSB3YXMgdHJpZ2dlcmVkIGZvciB0aGUgZmlyc3QgdGltZVxuICAgICAqIHdoZW4geW91IGNhbGwgJ2FkZCgpJyB0aGVuIG9uY2UgbGlzdGVuZXIgd2lsbCBub3QgYmUgYWRkZWQgYnV0IGluc3RlYWQgaW52b2tlZCBpbW1lZGlhdGVseSxcbiAgICAgKiB3aXRoIGFyZ3VtZW50LCB0aGF0IGV2ZW50IHdhcyB0cmlnZ2VyZWQgd2l0aCB0aGUgZmlyc3QgdGltZS5cbiAgICAgKi9cbiAgICBvbihoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7IGhhbmRsZXIsIGNvbnRleHQgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGxpc3RlbmVyIHRvIHRoZSBldmVudFxuICAgICAqL1xuICAgIG9uY2UoaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0OiBPYmplY3QgPSBudWxsKTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoeyBjb250ZXh0LCBoYW5kbGVyLCBvbmNlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBsaXN0ZW5lciwgd2hpY2ggd2lsbCBiZSBpbnZva2VkIG9ubHkgaWYgdGhlIGV2ZW50LWFyZ3VtZW50IGlzIGRlZXBseS1lcXVhbCB0b1xuICAgICAqIHRoZSBnaXZlbiB2YWx1ZS5cbiAgICAgKi9cbiAgICBtYXRjaCh2YWx1ZTogVHxSZWdFeHAsIGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHsgaGFuZGxlciwgY29udGV4dCwgb25seU1hdGNoaW5nOiB0cnVlLCBtYXRjaFZhbHVlOiB2YWx1ZSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb21iaW5lcyAnbWF0Y2gnIGFuZCAnb25jZScgZmVhdHVyZXMuXG4gICAgICovXG4gICAgbWF0Y2hPbmNlKHZhbHVlOiBULCBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ6IE9iamVjdCA9IG51bGwpOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoe1xuICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgaGFuZGxlcixcbiAgICAgICAgICAgICBvbmNlOiB0cnVlLFxuICAgICAgICAgICAgIG9ubHlNYXRjaGluZzogdHJ1ZSxcbiAgICAgICAgICAgICBtYXRjaFZhbHVlOiB2YWx1ZVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGEgbGlzdGVuZXIocykuIFdoZW4gbm8gY29udGV4dCBnaXZlbiByZW1vdmVzIGFsbCBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGF0dGFjaGVkXG4gICAgICogd2l0aG91dCBhIGNvbnRleHQuIFdoZW4gYSBjb250ZXh0IGlzIGdpdmVuIHJlbW92ZXMgb25seSBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGF0dGFjaGVkIHdpdGhcbiAgICAgKiB0aGF0IGNvbnRleHQgYW5kIGRvZXNuJ3QgcmVtb3ZlIGFueSBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGF0dGFjaGVkIHdpdGhvdXQgYSBjb250ZXh0LlxuICAgICAqL1xuICAgIG9mZihoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgIG9mZihjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgIG9mZihpZDogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkKTogdm9pZDtcbiAgICBvZmYoZGVzdGluYXRpb246IEV2ZW50UHJvcGVydHk8VD4pOiB2b2lkO1xuICAgIG9mZigpOiB2b2lkO1xuICAgIG9mZiguLi5hcmdzOiBhbnlbXSk6IHZvaWQge1xuICAgICAgICBsZXQgY29udGV4dDogT2JqZWN0ID0gbnVsbCxcbiAgICAgICAgICAgIGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiA9IG51bGwsXG4gICAgICAgICAgICBpZFRvUmVtb3ZlOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQgPSBudWxsO1xuICAgICAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICBjYXNlIDA6IC8vIE5vIGFyZ3VtZW50cyAtIGNsZWFyIGFsbCBsaXN0ZW5lcnMgXG4gICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBbXTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgaWYgKEV2ZW50UHJvcGVydHkuaXNMaXN0ZW5lcklkKGFyZ3NbMF0pKSB7XG4gICAgICAgICAgICAgICAgICAgIGlkVG9SZW1vdmUgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3NbMF0gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGw7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXJnc1swXSBpbnN0YW5jZW9mIEV2ZW50UHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub2ZmKGFyZ3NbMF0uZW1pdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBhcmd1bWVudDogJHt0eXBlb2YgYXJnc1swXX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICAgICAgaGFuZGxlciA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgY29udGV4dCA9IGFyZ3NbMV07XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVuc3VwcG9ydGVkIGFyZ3VtZW50cyBmb3JtYXQuXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVycy5maWx0ZXIoKGhDb25mOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+KSA9PiB7XG4gICAgICAgICAgICBsZXQgZGlmZmVyZW50SGFuZGxlcjogYm9vbGVhbiA9IGhDb25mLmhhbmRsZXIgIT09IGhhbmRsZXI7XG4gICAgICAgICAgICBsZXQgbm9IYW5kbGVyR2l2ZW46IGJvb2xlYW4gPSAhaGFuZGxlcjtcbiAgICAgICAgICAgIGxldCBub0NvbnRleHRHaXZlbjogYm9vbGVhbiA9ICFjb250ZXh0O1xuICAgICAgICAgICAgbGV0IGNvbmZIYXNOb0NvbnRleHQ6IGJvb2xlYW4gPSAhaENvbmYuY29udGV4dDtcbiAgICAgICAgICAgIGxldCBkaWZmZXJlbnRDb250ZXh0OiBib29sZWFuID0gaENvbmYuY29udGV4dCAhPT0gY29udGV4dDtcbiAgICAgICAgICAgIGxldCBkb250UmVtb3ZlOiBib29sZWFuO1xuXG4gICAgICAgICAgICBpZiAoaWRUb1JlbW92ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSBpZFRvUmVtb3ZlICE9PSBoQ29uZi5pZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKG5vSGFuZGxlckdpdmVuKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub0NvbnRleHRHaXZlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5leHBlY3RlZCBjaXJjdW1zdGFuY2VzLlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSBjb25mSGFzTm9Db250ZXh0IHx8IChjb250ZXh0ICE9PSBoQ29uZi5jb250ZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaWZmZXJlbnRIYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub0NvbnRleHRHaXZlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSAoIWNvbmZIYXNOb0NvbnRleHQpIHx8IChkaWZmZXJlbnRIYW5kbGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IGRpZmZlcmVudENvbnRleHQgfHwgZGlmZmVyZW50SGFuZGxlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBkb250UmVtb3ZlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZXh0KCk6IFByb21pc2U8VHx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKGE6IFQpID0+IHZvaWQsIHJlamVjdDogKGU6IGFueSkgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uY2UocmVzb2x2ZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmaXJzdCgpOiBQcm9taXNlPFR8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5maXJzdFRyaWdnZXJQcm9taXNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBpcGluZyB0aGUgZXZlbnRzIG1lYW5zIHRoYXQgdGhlIG90aGVyIGV2ZW50IG11c3QgYmUgdHJpZ2dlcmVkKGhhcHBlbikgYW55IHRpbWVcbiAgICAgKiB0aGlzIGV2ZW50IGhhcHBlbnMgYW5kIHdpdGggZXhhY3RseSB0aGUgc2FtZSBhcmd1bWVudC5cbiAgICAgKi9cbiAgICBwaXBlKG90aGVyOiBFdmVudFByb3BlcnR5PFQ+KTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub24ob3RoZXIuZW1pdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGlwZSBvbmx5IGV2ZW50cyB3aXRoIG1hdGNoaW5nIGFyZ3VtZW50IHRvIGRlc3RpbmF0aW9uIGV2ZW50LXByb3BlcnR5LlxuICAgICAqIEBwYXJhbSB2YWx1ZVxuICAgICAqIEBwYXJhbSBkZXN0aW5hdGlvblxuICAgICAqIEByZXR1cm5zIHtFdmVudFByb3BlcnR5Lkxpc3RlbmVySWR9XG4gICAgICovXG4gICAgcm91dGUodmFsdWU6IFR8UmVnRXhwLCBkZXN0aW5hdGlvbjogRXZlbnRQcm9wZXJ0eTxUPik6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCB7XG4gICAgICAgIHJldHVybiB0aGlzLm1hdGNoKHZhbHVlLCBkZXN0aW5hdGlvbi5lbWl0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+KTogdm9pZCB7XG4gICAgICAgIGxldCBsaXN0ZW5lckluZGV4ID0gdGhpcy5saXN0ZW5lcnMuaW5kZXhPZihsaXN0ZW5lcik7XG4gICAgICAgIGlmIChsaXN0ZW5lckluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMuc3BsaWNlKGxpc3RlbmVySW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRMaXN0ZW5lcihvcHRpb25zOiBFdmVudFByb3BlcnR5LkhhbmRsZXJPcHRpb25zPFQ+KTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgbGV0IHtjb250ZXh0LCBoYW5kbGVyLCBvbmNlLCBvbmx5TWF0Y2hpbmcsIG1hdGNoVmFsdWV9ID0gb3B0aW9ucztcbiAgICAgICAgdGhpcy5pZENvdW50ZXIrKztcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMucHVzaCh7Y29udGV4dCwgaGFuZGxlciwgb25jZSwgaWQ6IHRoaXMuaWRDb3VudGVyLCBvbmx5TWF0Y2hpbmcsIG1hdGNoVmFsdWV9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaWRDb3VudGVyO1xuICAgIH1cbn1cblxuZXhwb3J0IG5hbWVzcGFjZSBFdmVudFByb3BlcnR5IHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBjYWxsYmFjayBmb3JtYXQgdXNlZCBmb3IgYWRkaW5nIGxpc3RlbmVycyB0byBldmVudC1wcm9wZXJ0aWVzLlxuICAgICAqL1xuICAgIGV4cG9ydCBpbnRlcmZhY2UgSGFuZGxlcjxUPiB7XG4gICAgICAgIChldmVudEFyZzogVCk6IHZvaWQ7XG4gICAgfVxuXG4gICAgZXhwb3J0IHR5cGUgTGlzdGVuZXJJZCA9IG51bWJlcjtcblxuICAgIGV4cG9ydCBmdW5jdGlvbiBpc0xpc3RlbmVySWQoaWQ6IGFueSkge1xuICAgICAgICByZXR1cm4gdHlwZW9mIGlkID09PSBcIm51bWJlclwiO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBmdWxsIGNvbmZpZ3VyYXRpb24gZm9yIGEgc3BlY2lmaWMgZXZlbnQtaGFuZGxlci4gSXQgY29udHJvbHMgdGhlIHdheVxuICAgICAqIHRoZSByZWxldmFudCBldmVudC1oYW5kbGVyIGZ1bmN0aW9uIGlzIGludm9rZWQuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBIYW5kbGVyT3B0aW9uczxUPiB7XG4gICAgICAgIC8qKiBUaGUgYWN0dWFsIGhhbmRsZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50IG9jY3Vycy4gKi9cbiAgICAgICAgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+O1xuXG4gICAgICAgIC8qKiBJZiB0aGlzIGZsYWcgaXMgc2V0IC0gdGhlIGV2ZW50IGhhbmRsZXIgd2lsbCByZW1vdmUgaXRzZWxmIGZyb20gdGhlIGV2ZW50XG4gICAgICAgICBhZnRlciBmaXJzdCBpbnZvY2F0aW9uLiAqL1xuICAgICAgICBvbmNlPzogYm9vbGVhbjtcblxuICAgICAgICAvKiogSWYgdGhpcyBmaWVsZCBpcyBzcGVjaWZpZWQsIHRoZW4gaGFuZGxlciB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoYXQgY29udGV4dC4gKi9cbiAgICAgICAgY29udGV4dD86IE9iamVjdDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQWx3YXlzIHVzZWQgaW4gY29tYmluYXRpb24gd2l0aCBmb2xsb3dpbmcgcGFyYW1ldGVyICdtYXRjaFZhbHVlJyBhbmQgaXMgYVxuICAgICAgICAgKiBmbGFnLCB3aGljaCBtZWFucyhpZiBzZXQpIHRoYXQgb25seSBldmVudCBpbnZvY2F0aW9ucyB3aXRoIGFyZ3VtZW50IGVxdWFsXG4gICAgICAgICAqIHRvIHRoYXQgcHJlZGVmaW5lZCAnbWF0Y2hWYWx1ZScgc2hvdWxkIGJlIHBhc3NlZCB0byB0aGUgaGFuZGxlciBmdW5jdGlvbi5cbiAgICAgICAgICogQmFzaWNhbGx5IHRoaXMgaXMgYSBzaG9ydGhhbmQgZm9yIHRoZSBjb2RlIGxpa2UgdGhpczpcbiAgICAgICAgICpcbiAgICAgICAgICogIGV2ZW50Lmxpc3RlbigoYXJnKSA9PiB7XG4gICAgICAgICAqICAgICAgaWYoYXJnID09PSBtYXRjaFZhbHVlKSkgZXZlbnQuY2FsbEhhbmRsZXIoKTtcbiAgICAgICAgICogfSk7XG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtbdHlwZV19XG4gICAgICAgICAqL1xuICAgICAgICBvbmx5TWF0Y2hpbmc/OiBib29sZWFuO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGUgdmFsdWUsIHRvIGJlIG1hdGNoZWQgaWYgdGhlICdvbmx5TWF0Y2hpbmcnIGZsYWcgaXMgc2V0LlxuICAgICAgICAgKiBAdHlwZSB7W3R5cGVdfVxuICAgICAgICAgKi9cbiAgICAgICAgbWF0Y2hWYWx1ZT86IFR8UmVnRXhwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgaXMgdGhlIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGFuIGV4aXN0aW5nIGhhbmRsZXIgaW50ZXJuYWxseSBpbiBFdmVudCBvYmplY3QuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBIYW5kbGVyRGVzY3JpcHRvcjxUPiBleHRlbmRzIEhhbmRsZXJPcHRpb25zPFQ+IHtcbiAgICAgICAgaWQ6IExpc3RlbmVySWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQW4gZXZlbnQtcHJvcGVydHkgaW50ZXJmYWNlIHdpdGhvdXQgdGhlICdlbWl0JyBtZXRob2QuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBFbWl0dGVyPFQ+IHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFkZCBldmVudCBoYW5kbGVyIHRvIHRoaXMgZXZlbnQuIE9wdGlvbmFsbHkgcGFzcyBhIGNvbnRleHQgaW4gc2Vjb25kIGFyZ3VtZW50IC1cbiAgICAgICAgICogdGhlbiB3aGVuIHRyaWdnZXJlZCB0aGlzICBldmVudCB3aWxsIGNhbGwgdGhlICdoJyBoYW5kbGVyIHdpdGggdGhlIGdpdmVuIGNvbnRleHQuXG4gICAgICAgICAqL1xuICAgICAgICBvbihoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBMaXN0ZW5lcklkO1xuXG4gICAgICAgIG9uY2UoaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogTGlzdGVuZXJJZDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQWRkIGV2ZW50IGhhbmRsZXIgdG8gdGhpcyBldmVudCwgd2hpY2ggd2lsbCBiZSBjYWxsZWQgb25seSB3aGVuIGV2ZW50IGlzIHRyaWdnZXJlZFxuICAgICAgICAgKiB3aXRoIHZhbHVlLCB3aGljaCBpcyBleGFjdGx5KD09PSkgdGhlIHNhbWUgYXMgdGhlIG9uZSB5b3UgcGFzcyB0byB0aGUgbWF0Y2hcbiAgICAgICAgICogbWV0aG9kIGFzIGZpcnN0IGFyZ3VtZW50XG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaCh2YWx1ZTogVCwgaDogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogTGlzdGVuZXJJZDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQWRkcyBhbiBldmVudCBoYW5kbGVyLlxuICAgICAgICAgKiBDb21iaW5lcyB0aGUgJ29uY2UnIGFuZCB0aGUgJ21hdGNoJyBiZWhhdmlvdXJzLlxuICAgICAgICAgKi9cbiAgICAgICAgbWF0Y2hPbmNlKHZhbHVlOiBULCBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBMaXN0ZW5lcklkO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBbiBhbGlhcyBmb3IgdW5saXN0ZW5cbiAgICAgICAgICovXG4gICAgICAgIG9mZihoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgICAgICBvZmYoY29udGV4dDogT2JqZWN0KTogdm9pZDtcbiAgICAgICAgb2ZmKGlkOiBMaXN0ZW5lcklkKTogdm9pZDtcbiAgICAgICAgb2ZmKGRlc3RpbmF0aW9uOiBFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD4pOiB2b2lkO1xuICAgICAgICBvZmYoKTogdm9pZDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUGlwaW5nIHRoZSBldmVudCB0byBhbm90aGVyIG9uZSBtZWFucyB0aGF0IHdoZW5ldmVyIHRoZSBmaXJzdCBvbmUgaXMgdHJpZ2dlcmVkIC0gdGhlXG4gICAgICAgICAqIHNlY29uZCBvbmUgaXMgdHJpZ2dlcmVkIGF1dG9tYXRpY2FsbHkgd2l0aCBleGFjdGx5IHRoZSBzYW1lIGFyZ3VtZW50XG4gICAgICAgICAqL1xuICAgICAgICBwaXBlKGRlc3RpbmF0aW9uOiBFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD4pOiBMaXN0ZW5lcklkO1xuXG4gICAgICAgIGZpcnN0KCk6IFByb21pc2U8VD47XG4gICAgICAgIG5leHQoKTogUHJvbWlzZTxUPjtcbiAgICB9XG5cbiAgICBleHBvcnQgZnVuY3Rpb24gbWFrZTxUPigpOiBbRXZlbnRQcm9wZXJ0eTxUPiwgRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+XSB7XG4gICAgICAgIGxldCBldmVudFByb3AgPSBuZXcgRXZlbnRQcm9wZXJ0eTxUPigpO1xuICAgICAgICBsZXQgZW1pdHRlciA9IDxFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD4+ZXZlbnRQcm9wO1xuICAgICAgICByZXR1cm4gW2V2ZW50UHJvcCwgZW1pdHRlcl07XG4gICAgfVxufVxuXG5leHBvcnQgdHlwZSBWb2lkRXZlbnQgPSBFdmVudFByb3BlcnR5PHZvaWQ+O1xuZXhwb3J0IHR5cGUgTnVtYmVyRXZlbnQgPSBFdmVudFByb3BlcnR5PG51bWJlcj47XG5leHBvcnQgdHlwZSBTdHJpbmdFdmVudCA9IEV2ZW50UHJvcGVydHk8c3RyaW5nPjtcbmV4cG9ydCB0eXBlIE9iamVjdEV2ZW50ID0gRXZlbnRQcm9wZXJ0eTxPYmplY3Q+O1xuZXhwb3J0IHR5cGUgQW55RXZlbnQgPSBFdmVudFByb3BlcnR5PGFueT47XG5cbmV4cG9ydCBkZWZhdWx0IEV2ZW50UHJvcGVydHk7Il19