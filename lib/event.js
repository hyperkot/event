/// <reference path="../typings/index.d.ts"/>
Object.defineProperty(exports, "__esModule", { value: true });
function _objectMatch(subject, proto, traversalStack = []) {
    switch (typeof proto) {
        case "undefined": return subject === undefined;
        case "number":
        case "boolean":
        case "string":
        case "function":
            return subject === proto;
        case "object":
            let isMatching = true;
            if (traversalStack.length === 0) {
                if ((typeof subject === "string") && (proto instanceof RegExp)) {
                    isMatching = proto.test(subject);
                }
            }
            else {
                if (typeof subject !== "object") {
                    isMatching = false;
                }
                else {
                    if (!proto || !subject)
                        isMatching = !subject && !proto;
                    else if (traversalStack.includes(subject)) {
                        throw new Error("Recursion!");
                    }
                    else {
                        for (let key in proto) {
                            if (proto.hasOwnProperty(key)) {
                                traversalStack.push(subject);
                                isMatching = isMatching && _objectMatch(subject[key], proto[key], traversalStack);
                                traversalStack.pop();
                            }
                        }
                    }
                }
            }
            return isMatching;
        default:
            throw new Error(`Unexpected typeof: ${typeof proto}`);
    }
}
function objectMatch(subject, proto) {
    return _objectMatch(subject, proto);
}
/**
 * Represents an event and provides methods to observe it and to trigger(emit) it.
 */
class EventProperty {
    constructor() {
        this.listeners = [];
        this.isBeingTriggered = false;
        this.firstTriggerPromise = null;
        this.isFirstTriggerDone = false;
        this.idCounter = 0;
        this.firstTriggerPromise = new Promise((resolve, reject) => {
            this.resolveFirstTriggerPromise = resolve;
            this.rejectFirstTriggerPromise = reject;
        });
        this.emit = this.emit.bind(this);
    }
    /**
     * Emits the event with given argument, invoking all of its handlers, and if
     * the event is triggered for the first time - removing the once event handlers and
     * saving given argument internally as first emit argument.
     *
     * The argument is optional, since event can be of void type (`x= new Event<void>()`),
     * but if the event is not of a void type - you should always pass an argument to
     * the emit method.
     */
    emit(eventArg) {
        let resolveFirstTimeTrigger = false;
        let toInvoke;
        if (this.isBeingTriggered) {
            throw new Error(`Event triggered during trigger handling - suspecting recursive event.`);
        }
        this.isBeingTriggered = true;
        if (!this.isFirstTriggerDone) {
            this.isFirstTriggerDone = true;
            resolveFirstTimeTrigger = true;
        }
        toInvoke = this.listeners.slice().filter((listener) => {
            let shouldInvoke = !listener.onlyMatching || objectMatch(eventArg, listener.matchValue);
            if (listener.once) {
                this.removeListener(listener);
            }
            return shouldInvoke;
        });
        this.isBeingTriggered = false;
        toInvoke.forEach((listener) => {
            if (listener.context) {
                listener.handler.call(listener.context, eventArg);
            }
            else {
                listener.handler.call(null, eventArg);
            }
        });
        if (resolveFirstTimeTrigger) {
            this.resolveFirstTriggerPromise(eventArg);
        }
    }
    /**
     * Adds a listener. If once=true then adds once listener which means that listener will be removed,
     * when event triggers for the first time. Also if event already was triggered for the first time
     * when you call 'add()' then once listener will not be added but instead invoked immediately,
     * with argument, that event was triggered with the first time.
     */
    on(handler, context) {
        return this.addListener({ handler, context });
    }
    /**
     * Adds a listener to the event
     */
    once(handler, context = null) {
        return this.addListener({ context, handler, once: true });
    }
    /**
     * Adds a listener, which will be invoked only if the event-argument is deeply-equal to
     * the given value.
     */
    match(value, handler, context) {
        return this.addListener({ handler, context, onlyMatching: true, matchValue: value });
    }
    /**
     * Combines 'match' and 'once' features.
     */
    matchOnce(value, handler, context = null) {
        return this.addListener({
            context,
            handler,
            once: true,
            onlyMatching: true,
            matchValue: value
        });
    }
    off(...args) {
        let context = null, handler = null, idToRemove = null;
        switch (args.length) {
            case 0:
                this.listeners = [];
                return;
            case 1:
                if (EventProperty.isListenerId(args[0])) {
                    idToRemove = args[0];
                }
                else if (typeof args[0] === "function") {
                    handler = args[0];
                    context = null;
                }
                else if (typeof args[0] === "object") {
                    if (args[0] instanceof EventProperty) {
                        this.off(args[0].emit);
                        return;
                    }
                    handler = null;
                    context = args[0];
                }
                else {
                    throw new Error(`Invalid argument: ${typeof args[0]}`);
                }
                break;
            case 2:
                handler = args[0];
                context = args[1];
                break;
            default:
                throw new Error("Unsupported arguments format.");
        }
        this.listeners = this.listeners.filter((hConf) => {
            let differentHandler = hConf.handler !== handler;
            let noHandlerGiven = !handler;
            let noContextGiven = !context;
            let confHasNoContext = !hConf.context;
            let differentContext = hConf.context !== context;
            let dontRemove;
            if (idToRemove !== null) {
                dontRemove = idToRemove !== hConf.id;
            }
            else {
                if (noHandlerGiven) {
                    if (noContextGiven) {
                        throw new Error("Unexpected circumstances.");
                    }
                    else {
                        dontRemove = confHasNoContext || (context !== hConf.context);
                    }
                }
                else {
                    if (differentHandler) {
                        dontRemove = true;
                    }
                    else {
                        if (noContextGiven) {
                            dontRemove = (!confHasNoContext) || (differentHandler);
                        }
                        else {
                            dontRemove = differentContext || differentHandler;
                        }
                    }
                }
            }
            return dontRemove;
        });
    }
    next() {
        return new Promise((resolve, reject) => {
            try {
                this.once(resolve);
            }
            catch (e) {
                reject(e);
            }
        });
    }
    first() {
        return this.firstTriggerPromise;
    }
    /**
     * Piping the events means that the other event must be triggered(happen) any time
     * this event happens and with exactly the same argument.
     */
    pipe(other) {
        return this.on(other.emit);
    }
    /**
     * Pipe only events with matching argument to destination event-property.
     * @param value
     * @param destination
     * @returns {EventProperty.ListenerId}
     */
    route(value, destination) {
        return this.match(value, destination.emit);
    }
    removeListener(listener) {
        let listenerIndex = this.listeners.indexOf(listener);
        if (listenerIndex !== -1) {
            this.listeners.splice(listenerIndex, 1);
        }
    }
    addListener(options) {
        let { context, handler, once, onlyMatching, matchValue } = options;
        this.idCounter++;
        this.listeners.push({ context, handler, once, id: this.idCounter, onlyMatching, matchValue });
        return this.idCounter;
    }
}
exports.EventProperty = EventProperty;
(function (EventProperty) {
    function isListenerId(id) {
        return typeof id === "number";
    }
    EventProperty.isListenerId = isListenerId;
    function make() {
        let eventProp = new EventProperty();
        let emitter = eventProp;
        return [eventProp, emitter];
    }
    EventProperty.make = make;
    function split() {
        let eventProp = new EventProperty();
        let emitter = eventProp;
        return [eventProp.emit, emitter];
    }
    EventProperty.split = split;
    function splitVoid() {
        let eventProp = new EventProperty.Void();
        let emitter = eventProp;
        return [eventProp.emit, emitter];
    }
    EventProperty.splitVoid = splitVoid;
    class Void extends EventProperty {
        constructor() {
            super();
        }
        emit() { return super.emit(void 0); }
    }
    EventProperty.Void = Void;
    ;
})(EventProperty = exports.EventProperty || (exports.EventProperty = {}));
exports.default = EventProperty;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZXZlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDOztBQUU3QyxzQkFBc0IsT0FBWSxFQUFFLEtBQVUsRUFBRSxpQkFBd0IsRUFBRTtJQUN0RSxNQUFNLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbkIsS0FBSyxXQUFXLEVBQUUsTUFBTSxDQUFDLE9BQU8sS0FBSyxTQUFTLENBQUM7UUFDL0MsS0FBSyxRQUFRLENBQUM7UUFDZCxLQUFLLFNBQVMsQ0FBQztRQUNmLEtBQUssUUFBUSxDQUFDO1FBQ2QsS0FBSyxVQUFVO1lBQ1gsTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLENBQUM7UUFDN0IsS0FBSyxRQUFRO1lBQ1QsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBRXRCLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssWUFBWSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdELFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNyQyxDQUFDO1lBQ0wsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7b0JBQzlCLFVBQVUsR0FBRyxLQUFLLENBQUM7Z0JBQ3ZCLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUM7d0JBQ25CLFVBQVUsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztvQkFDcEMsSUFBSSxDQUFDLEVBQUUs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QUksU0FBUyxHQUFHLElBQUksYUFBYSxFQUFLLENBQUM7UUFDdkMsSUFBSSxPQUFPLEdBQTZCLFNBQVMsQ0FBQztRQUNsRCxNQUFNLENBQUMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUplLGtCQUFJLE9BSW5CLENBQUE7SUFFRDtRQUNJLElBQUksU0FBUyxHQUFHLElBQUksYUFBYSxFQUFLLENBQUM7UUFDdkMsSUFBSSxPQUFPLEdBQTZCLFNBQVMsQ0FBQztRQUNsRCxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFKZSxtQkFBSyxRQUlwQixDQUFBO0lBRUQ7UUFDSSxJQUFJLFNBQVMsR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN6QyxJQUFJLE9BQU8sR0FBZ0MsU0FBUyxDQUFDO1FBQ3JELE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUplLHVCQUFTLFlBSXhCLENBQUE7SUFFRCxVQUFrQixTQUFRLGFBQW1CO1FBQ3pDO1lBQ0ksS0FBSyxFQUFFLENBQUM7UUFDWixDQUFDO1FBQ0QsSUFBSSxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3hDO0lBTFksa0JBQUksT0FLaEIsQ0FBQTtJQUFBLENBQUM7QUFDTixDQUFDLEVBOUhnQixhQUFhLEdBQWIscUJBQWEsS0FBYixxQkFBYSxRQThIN0I7QUFFRCxrQkFBZSxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9pbmRleC5kLnRzXCIvPlxuXG5mdW5jdGlvbiBfb2JqZWN0TWF0Y2goc3ViamVjdDogYW55LCBwcm90bzogYW55LCB0cmF2ZXJzYWxTdGFjazogYW55W10gPSBbXSk6IGJvb2xlYW4ge1xuICAgIHN3aXRjaCAodHlwZW9mIHByb3RvKSB7XG4gICAgICAgIGNhc2UgXCJ1bmRlZmluZWRcIjogcmV0dXJuIHN1YmplY3QgPT09IHVuZGVmaW5lZDtcbiAgICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIGNhc2UgXCJmdW5jdGlvblwiOlxuICAgICAgICAgICAgcmV0dXJuIHN1YmplY3QgPT09IHByb3RvO1xuICAgICAgICBjYXNlIFwib2JqZWN0XCI6XG4gICAgICAgICAgICBsZXQgaXNNYXRjaGluZyA9IHRydWU7XG5cbiAgICAgICAgICAgIGlmICh0cmF2ZXJzYWxTdGFjay5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZiBzdWJqZWN0ID09PSBcInN0cmluZ1wiKSAmJiAocHJvdG8gaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTWF0Y2hpbmcgPSBwcm90by50ZXN0KHN1YmplY3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdWJqZWN0ICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTWF0Y2hpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3RvIHx8ICFzdWJqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgaXNNYXRjaGluZyA9ICFzdWJqZWN0ICYmICFwcm90bztcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHJhdmVyc2FsU3RhY2suaW5jbHVkZXMoc3ViamVjdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlY3Vyc2lvbiFcIik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gcHJvdG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvdG8uaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzYWxTdGFjay5wdXNoKHN1YmplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc01hdGNoaW5nID0gaXNNYXRjaGluZyAmJiBfb2JqZWN0TWF0Y2goc3ViamVjdFtrZXldLCBwcm90b1trZXldLCB0cmF2ZXJzYWxTdGFjayk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYXZlcnNhbFN0YWNrLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBpc01hdGNoaW5nO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGVvZjogJHt0eXBlb2YgcHJvdG99YCk7XG4gICAgfVxufVxuZnVuY3Rpb24gb2JqZWN0TWF0Y2goc3ViamVjdDogYW55LCBwcm90bzogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIF9vYmplY3RNYXRjaChzdWJqZWN0LCBwcm90byk7XG59XG5cbi8qKlxuICogUmVwcmVzZW50cyBhbiBldmVudCBhbmQgcHJvdmlkZXMgbWV0aG9kcyB0byBvYnNlcnZlIGl0IGFuZCB0byB0cmlnZ2VyKGVtaXQpIGl0LlxuICovXG5leHBvcnQgY2xhc3MgRXZlbnRQcm9wZXJ0eTxUPiBpbXBsZW1lbnRzIEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPiB7XG4gICAgcHJpdmF0ZSBsaXN0ZW5lcnM6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD5bXSA9IFtdO1xuICAgIHByaXZhdGUgaXNCZWluZ1RyaWdnZXJlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBmaXJzdFRyaWdnZXJQcm9taXNlOiBQcm9taXNlPFQ+ID0gbnVsbDtcbiAgICBwcml2YXRlIHJlc29sdmVGaXJzdFRyaWdnZXJQcm9taXNlOiAodmFsdWU6IFQpID0+IGFueTtcbiAgICBwcml2YXRlIHJlamVjdEZpcnN0VHJpZ2dlclByb21pc2U6ICh2YWx1ZTogYW55KSA9PiBhbnk7XG4gICAgcHJpdmF0ZSBpc0ZpcnN0VHJpZ2dlckRvbmU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHByaXZhdGUgaWRDb3VudGVyOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQgPSAwO1xuXG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcblxuICAgICAgICB0aGlzLmZpcnN0VHJpZ2dlclByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKHZhbHVlOiBUKSA9PiB2b2lkLCByZWplY3Q6IChlOiBhbnkpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZUZpcnN0VHJpZ2dlclByb21pc2UgPSByZXNvbHZlO1xuICAgICAgICAgICAgdGhpcy5yZWplY3RGaXJzdFRyaWdnZXJQcm9taXNlID0gcmVqZWN0O1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVtaXQgPSB0aGlzLmVtaXQuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBFbWl0cyB0aGUgZXZlbnQgd2l0aCBnaXZlbiBhcmd1bWVudCwgaW52b2tpbmcgYWxsIG9mIGl0cyBoYW5kbGVycywgYW5kIGlmXG4gICAgICogdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBmb3IgdGhlIGZpcnN0IHRpbWUgLSByZW1vdmluZyB0aGUgb25jZSBldmVudCBoYW5kbGVycyBhbmRcbiAgICAgKiBzYXZpbmcgZ2l2ZW4gYXJndW1lbnQgaW50ZXJuYWxseSBhcyBmaXJzdCBlbWl0IGFyZ3VtZW50LlxuICAgICAqIFxuICAgICAqIFRoZSBhcmd1bWVudCBpcyBvcHRpb25hbCwgc2luY2UgZXZlbnQgY2FuIGJlIG9mIHZvaWQgdHlwZSAoYHg9IG5ldyBFdmVudDx2b2lkPigpYCksXG4gICAgICogYnV0IGlmIHRoZSBldmVudCBpcyBub3Qgb2YgYSB2b2lkIHR5cGUgLSB5b3Ugc2hvdWxkIGFsd2F5cyBwYXNzIGFuIGFyZ3VtZW50IHRvXG4gICAgICogdGhlIGVtaXQgbWV0aG9kLlxuICAgICAqL1xuICAgIGVtaXQoZXZlbnRBcmc6IFQpOiB2b2lkIHtcbiAgICAgICAgbGV0IHJlc29sdmVGaXJzdFRpbWVUcmlnZ2VyOiBib29sZWFuID0gZmFsc2U7XG4gICAgICAgIGxldCB0b0ludm9rZTogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPltdO1xuXG4gICAgICAgIGlmICh0aGlzLmlzQmVpbmdUcmlnZ2VyZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXZlbnQgdHJpZ2dlcmVkIGR1cmluZyB0cmlnZ2VyIGhhbmRsaW5nIC0gc3VzcGVjdGluZyByZWN1cnNpdmUgZXZlbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmlzQmVpbmdUcmlnZ2VyZWQgPSB0cnVlO1xuICAgICAgICBpZiAoIXRoaXMuaXNGaXJzdFRyaWdnZXJEb25lKSB7XG4gICAgICAgICAgICB0aGlzLmlzRmlyc3RUcmlnZ2VyRG9uZSA9IHRydWU7XG4gICAgICAgICAgICByZXNvbHZlRmlyc3RUaW1lVHJpZ2dlciA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICB0b0ludm9rZSA9IHRoaXMubGlzdGVuZXJzLnNsaWNlKCkuZmlsdGVyKChsaXN0ZW5lcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPikgPT4ge1xuICAgICAgICAgICAgbGV0IHNob3VsZEludm9rZSA9ICFsaXN0ZW5lci5vbmx5TWF0Y2hpbmcgfHwgb2JqZWN0TWF0Y2goZXZlbnRBcmcsIGxpc3RlbmVyLm1hdGNoVmFsdWUpO1xuICAgICAgICAgICAgaWYgKGxpc3RlbmVyLm9uY2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzaG91bGRJbnZva2U7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmlzQmVpbmdUcmlnZ2VyZWQgPSBmYWxzZTtcbiAgICAgICAgdG9JbnZva2UuZm9yRWFjaCgobGlzdGVuZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD4pID0+IHtcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lci5jb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgbGlzdGVuZXIuaGFuZGxlci5jYWxsKGxpc3RlbmVyLmNvbnRleHQsIGV2ZW50QXJnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGlzdGVuZXIuaGFuZGxlci5jYWxsKG51bGwsIGV2ZW50QXJnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChyZXNvbHZlRmlyc3RUaW1lVHJpZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlRmlyc3RUcmlnZ2VyUHJvbWlzZShldmVudEFyZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbGlzdGVuZXIuIElmIG9uY2U9dHJ1ZSB0aGVuIGFkZHMgb25jZSBsaXN0ZW5lciB3aGljaCBtZWFucyB0aGF0IGxpc3RlbmVyIHdpbGwgYmUgcmVtb3ZlZCxcbiAgICAgKiB3aGVuIGV2ZW50IHRyaWdnZXJzIGZvciB0aGUgZmlyc3QgdGltZS4gQWxzbyBpZiBldmVudCBhbHJlYWR5IHdhcyB0cmlnZ2VyZWQgZm9yIHRoZSBmaXJzdCB0aW1lXG4gICAgICogd2hlbiB5b3UgY2FsbCAnYWRkKCknIHRoZW4gb25jZSBsaXN0ZW5lciB3aWxsIG5vdCBiZSBhZGRlZCBidXQgaW5zdGVhZCBpbnZva2VkIGltbWVkaWF0ZWx5LFxuICAgICAqIHdpdGggYXJndW1lbnQsIHRoYXQgZXZlbnQgd2FzIHRyaWdnZXJlZCB3aXRoIHRoZSBmaXJzdCB0aW1lLlxuICAgICAqL1xuICAgIG9uKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHsgaGFuZGxlciwgY29udGV4dCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbGlzdGVuZXIgdG8gdGhlIGV2ZW50XG4gICAgICovXG4gICAgb25jZShoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ6IE9iamVjdCA9IG51bGwpOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7IGNvbnRleHQsIGhhbmRsZXIsIG9uY2U6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGxpc3RlbmVyLCB3aGljaCB3aWxsIGJlIGludm9rZWQgb25seSBpZiB0aGUgZXZlbnQtYXJndW1lbnQgaXMgZGVlcGx5LWVxdWFsIHRvXG4gICAgICogdGhlIGdpdmVuIHZhbHVlLlxuICAgICAqL1xuICAgIG1hdGNoKHZhbHVlOiBUfFJlZ0V4cCwgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoeyBoYW5kbGVyLCBjb250ZXh0LCBvbmx5TWF0Y2hpbmc6IHRydWUsIG1hdGNoVmFsdWU6IHZhbHVlIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbWJpbmVzICdtYXRjaCcgYW5kICdvbmNlJyBmZWF0dXJlcy5cbiAgICAgKi9cbiAgICBtYXRjaE9uY2UodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dDogT2JqZWN0ID0gbnVsbCk6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCB7XG4gICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7XG4gICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICBoYW5kbGVyLFxuICAgICAgICAgICAgIG9uY2U6IHRydWUsXG4gICAgICAgICAgICAgb25seU1hdGNoaW5nOiB0cnVlLFxuICAgICAgICAgICAgIG1hdGNoVmFsdWU6IHZhbHVlXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBsaXN0ZW5lcihzKS4gV2hlbiBubyBjb250ZXh0IGdpdmVuIHJlbW92ZXMgYWxsIGxpc3RlbmVycyB0aGF0IHdlcmUgYXR0YWNoZWRcbiAgICAgKiB3aXRob3V0IGEgY29udGV4dC4gV2hlbiBhIGNvbnRleHQgaXMgZ2l2ZW4gcmVtb3ZlcyBvbmx5IGxpc3RlbmVycyB0aGF0IHdlcmUgYXR0YWNoZWQgd2l0aFxuICAgICAqIHRoYXQgY29udGV4dCBhbmQgZG9lc24ndCByZW1vdmUgYW55IGxpc3RlbmVycyB0aGF0IHdlcmUgYXR0YWNoZWQgd2l0aG91dCBhIGNvbnRleHQuXG4gICAgICovXG4gICAgb2ZmKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG4gICAgb2ZmKGNvbnRleHQ6IE9iamVjdCk6IHZvaWQ7XG4gICAgb2ZmKGlkOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQpOiB2b2lkO1xuICAgIG9mZihkZXN0aW5hdGlvbjogRXZlbnRQcm9wZXJ0eTxUPik6IHZvaWQ7XG4gICAgb2ZmKCk6IHZvaWQ7XG4gICAgb2ZmKC4uLmFyZ3M6IGFueVtdKTogdm9pZCB7XG4gICAgICAgIGxldCBjb250ZXh0OiBPYmplY3QgPSBudWxsLFxuICAgICAgICAgICAgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+ID0gbnVsbCxcbiAgICAgICAgICAgIGlkVG9SZW1vdmU6IEV2ZW50UHJvcGVydHkuTGlzdGVuZXJJZCA9IG51bGw7XG4gICAgICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNhc2UgMDogLy8gTm8gYXJndW1lbnRzIC0gY2xlYXIgYWxsIGxpc3RlbmVycyBcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IFtdO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICBpZiAoRXZlbnRQcm9wZXJ0eS5pc0xpc3RlbmVySWQoYXJnc1swXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWRUb1JlbW92ZSA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcmdzWzBdIGluc3RhbmNlb2YgRXZlbnRQcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vZmYoYXJnc1swXS5lbWl0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGFyZ3VtZW50OiAke3R5cGVvZiBhcmdzWzBdfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgICAgICBoYW5kbGVyID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICBjb250ZXh0ID0gYXJnc1sxXTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWQgYXJndW1lbnRzIGZvcm1hdC5cIik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxpc3RlbmVycyA9IHRoaXMubGlzdGVuZXJzLmZpbHRlcigoaENvbmY6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD4pID0+IHtcbiAgICAgICAgICAgIGxldCBkaWZmZXJlbnRIYW5kbGVyOiBib29sZWFuID0gaENvbmYuaGFuZGxlciAhPT0gaGFuZGxlcjtcbiAgICAgICAgICAgIGxldCBub0hhbmRsZXJHaXZlbjogYm9vbGVhbiA9ICFoYW5kbGVyO1xuICAgICAgICAgICAgbGV0IG5vQ29udGV4dEdpdmVuOiBib29sZWFuID0gIWNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgY29uZkhhc05vQ29udGV4dDogYm9vbGVhbiA9ICFoQ29uZi5jb250ZXh0O1xuICAgICAgICAgICAgbGV0IGRpZmZlcmVudENvbnRleHQ6IGJvb2xlYW4gPSBoQ29uZi5jb250ZXh0ICE9PSBjb250ZXh0O1xuICAgICAgICAgICAgbGV0IGRvbnRSZW1vdmU6IGJvb2xlYW47XG5cbiAgICAgICAgICAgIGlmIChpZFRvUmVtb3ZlICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IGlkVG9SZW1vdmUgIT09IGhDb25mLmlkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAobm9IYW5kbGVyR2l2ZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vQ29udGV4dEdpdmVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmV4cGVjdGVkIGNpcmN1bXN0YW5jZXMuXCIpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IGNvbmZIYXNOb0NvbnRleHQgfHwgKGNvbnRleHQgIT09IGhDb25mLmNvbnRleHQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRpZmZlcmVudEhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vQ29udGV4dEdpdmVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9ICghY29uZkhhc05vQ29udGV4dCkgfHwgKGRpZmZlcmVudEhhbmRsZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gZGlmZmVyZW50Q29udGV4dCB8fCBkaWZmZXJlbnRIYW5kbGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGRvbnRSZW1vdmU7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG5leHQoKTogUHJvbWlzZTxUfHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlOiAoYTogVCkgPT4gdm9pZCwgcmVqZWN0OiAoZTogYW55KSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMub25jZShyZXNvbHZlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGZpcnN0KCk6IFByb21pc2U8VHx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpcnN0VHJpZ2dlclByb21pc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGlwaW5nIHRoZSBldmVudHMgbWVhbnMgdGhhdCB0aGUgb3RoZXIgZXZlbnQgbXVzdCBiZSB0cmlnZ2VyZWQoaGFwcGVuKSBhbnkgdGltZVxuICAgICAqIHRoaXMgZXZlbnQgaGFwcGVucyBhbmQgd2l0aCBleGFjdGx5IHRoZSBzYW1lIGFyZ3VtZW50LlxuICAgICAqL1xuICAgIHBpcGUob3RoZXI6IEV2ZW50UHJvcGVydHk8VD4pOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICByZXR1cm4gdGhpcy5vbihvdGhlci5lbWl0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQaXBlIG9ubHkgZXZlbnRzIHdpdGggbWF0Y2hpbmcgYXJndW1lbnQgdG8gZGVzdGluYXRpb24gZXZlbnQtcHJvcGVydHkuXG4gICAgICogQHBhcmFtIHZhbHVlXG4gICAgICogQHBhcmFtIGRlc3RpbmF0aW9uXG4gICAgICogQHJldHVybnMge0V2ZW50UHJvcGVydHkuTGlzdGVuZXJJZH1cbiAgICAgKi9cbiAgICByb3V0ZSh2YWx1ZTogVHxSZWdFeHAsIGRlc3RpbmF0aW9uOiBFdmVudFByb3BlcnR5PFQ+KTogRXZlbnRQcm9wZXJ0eS5MaXN0ZW5lcklkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2godmFsdWUsIGRlc3RpbmF0aW9uLmVtaXQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXIobGlzdGVuZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlckRlc2NyaXB0b3I8VD4pOiB2b2lkIHtcbiAgICAgICAgbGV0IGxpc3RlbmVySW5kZXggPSB0aGlzLmxpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKTtcbiAgICAgICAgaWYgKGxpc3RlbmVySW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVycy5zcGxpY2UobGlzdGVuZXJJbmRleCwgMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZExpc3RlbmVyKG9wdGlvbnM6IEV2ZW50UHJvcGVydHkuSGFuZGxlck9wdGlvbnM8VD4pOiBFdmVudFByb3BlcnR5Lkxpc3RlbmVySWQge1xuICAgICAgICBsZXQge2NvbnRleHQsIGhhbmRsZXIsIG9uY2UsIG9ubHlNYXRjaGluZywgbWF0Y2hWYWx1ZX0gPSBvcHRpb25zO1xuICAgICAgICB0aGlzLmlkQ291bnRlcisrO1xuICAgICAgICB0aGlzLmxpc3RlbmVycy5wdXNoKHtjb250ZXh0LCBoYW5kbGVyLCBvbmNlLCBpZDogdGhpcy5pZENvdW50ZXIsIG9ubHlNYXRjaGluZywgbWF0Y2hWYWx1ZX0pO1xuICAgICAgICByZXR1cm4gdGhpcy5pZENvdW50ZXI7XG4gICAgfVxufVxuXG5leHBvcnQgbmFtZXNwYWNlIEV2ZW50UHJvcGVydHkge1xuXG4gICAgLyoqXG4gICAgICogVGhlIGNhbGxiYWNrIGZvcm1hdCB1c2VkIGZvciBhZGRpbmcgbGlzdGVuZXJzIHRvIGV2ZW50LXByb3BlcnRpZXMuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBIYW5kbGVyPFQ+IHtcbiAgICAgICAgKGV2ZW50QXJnOiBUKTogdm9pZDtcbiAgICB9XG5cbiAgICBleHBvcnQgdHlwZSBMaXN0ZW5lcklkID0gbnVtYmVyO1xuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGlzTGlzdGVuZXJJZChpZDogYW55KSB7XG4gICAgICAgIHJldHVybiB0eXBlb2YgaWQgPT09IFwibnVtYmVyXCI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhlIGZ1bGwgY29uZmlndXJhdGlvbiBmb3IgYSBzcGVjaWZpYyBldmVudC1oYW5kbGVyLiBJdCBjb250cm9scyB0aGUgd2F5XG4gICAgICogdGhlIHJlbGV2YW50IGV2ZW50LWhhbmRsZXIgZnVuY3Rpb24gaXMgaW52b2tlZC5cbiAgICAgKi9cbiAgICBleHBvcnQgaW50ZXJmYWNlIEhhbmRsZXJPcHRpb25zPFQ+IHtcbiAgICAgICAgLyoqIFRoZSBhY3R1YWwgaGFuZGxlciBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgb2NjdXJzLiAqL1xuICAgICAgICBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD47XG5cbiAgICAgICAgLyoqIElmIHRoaXMgZmxhZyBpcyBzZXQgLSB0aGUgZXZlbnQgaGFuZGxlciB3aWxsIHJlbW92ZSBpdHNlbGYgZnJvbSB0aGUgZXZlbnRcbiAgICAgICAgIGFmdGVyIGZpcnN0IGludm9jYXRpb24uICovXG4gICAgICAgIG9uY2U/OiBib29sZWFuO1xuXG4gICAgICAgIC8qKiBJZiB0aGlzIGZpZWxkIGlzIHNwZWNpZmllZCwgdGhlbiBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhhdCBjb250ZXh0LiAqL1xuICAgICAgICBjb250ZXh0PzogT2JqZWN0O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBbHdheXMgdXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIGZvbGxvd2luZyBwYXJhbWV0ZXIgJ21hdGNoVmFsdWUnIGFuZCBpcyBhXG4gICAgICAgICAqIGZsYWcsIHdoaWNoIG1lYW5zKGlmIHNldCkgdGhhdCBvbmx5IGV2ZW50IGludm9jYXRpb25zIHdpdGggYXJndW1lbnQgZXF1YWxcbiAgICAgICAgICogdG8gdGhhdCBwcmVkZWZpbmVkICdtYXRjaFZhbHVlJyBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uLlxuICAgICAgICAgKiBCYXNpY2FsbHkgdGhpcyBpcyBhIHNob3J0aGFuZCBmb3IgdGhlIGNvZGUgbGlrZSB0aGlzOlxuICAgICAgICAgKlxuICAgICAgICAgKiAgZXZlbnQubGlzdGVuKChhcmcpID0+IHtcbiAgICAgICAgICogICAgICBpZihhcmcgPT09IG1hdGNoVmFsdWUpKSBldmVudC5jYWxsSGFuZGxlcigpO1xuICAgICAgICAgKiB9KTtcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge1t0eXBlXX1cbiAgICAgICAgICovXG4gICAgICAgIG9ubHlNYXRjaGluZz86IGJvb2xlYW47XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSB2YWx1ZSwgdG8gYmUgbWF0Y2hlZCBpZiB0aGUgJ29ubHlNYXRjaGluZycgZmxhZyBpcyBzZXQuXG4gICAgICAgICAqIEB0eXBlIHtbdHlwZV19XG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaFZhbHVlPzogVHxSZWdFeHA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyB0aGUgb2JqZWN0IHdoaWNoIHJlcHJlc2VudHMgYW4gZXhpc3RpbmcgaGFuZGxlciBpbnRlcm5hbGx5IGluIEV2ZW50IG9iamVjdC5cbiAgICAgKi9cbiAgICBleHBvcnQgaW50ZXJmYWNlIEhhbmRsZXJEZXNjcmlwdG9yPFQ+IGV4dGVuZHMgSGFuZGxlck9wdGlvbnM8VD4ge1xuICAgICAgICBpZDogTGlzdGVuZXJJZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVudC1wcm9wZXJ0eSBpbnRlcmZhY2Ugd2l0aG91dCB0aGUgJ2VtaXQnIG1ldGhvZC5cbiAgICAgKi9cbiAgICBleHBvcnQgaW50ZXJmYWNlIEVtaXR0ZXI8VD4ge1xuICAgICAgICAvKipcbiAgICAgICAgICogQWRkIGV2ZW50IGhhbmRsZXIgdG8gdGhpcyBldmVudC4gT3B0aW9uYWxseSBwYXNzIGEgY29udGV4dCBpbiBzZWNvbmQgYXJndW1lbnQgLVxuICAgICAgICAgKiB0aGVuIHdoZW4gdHJpZ2dlcmVkIHRoaXMgIGV2ZW50IHdpbGwgY2FsbCB0aGUgJ2gnIGhhbmRsZXIgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dC5cbiAgICAgICAgICovXG4gICAgICAgIG9uKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IExpc3RlbmVySWQ7XG5cbiAgICAgICAgb25jZShoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBMaXN0ZW5lcklkO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBZGQgZXZlbnQgaGFuZGxlciB0byB0aGlzIGV2ZW50LCB3aGljaCB3aWxsIGJlIGNhbGxlZCBvbmx5IHdoZW4gZXZlbnQgaXMgdHJpZ2dlcmVkXG4gICAgICAgICAqIHdpdGggdmFsdWUsIHdoaWNoIGlzIGV4YWN0bHkoPT09KSB0aGUgc2FtZSBhcyB0aGUgb25lIHlvdSBwYXNzIHRvIHRoZSBtYXRjaFxuICAgICAgICAgKiBtZXRob2QgYXMgZmlyc3QgYXJndW1lbnRcbiAgICAgICAgICovXG4gICAgICAgIG1hdGNoKHZhbHVlOiBULCBoOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBMaXN0ZW5lcklkO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBZGRzIGFuIGV2ZW50IGhhbmRsZXIuXG4gICAgICAgICAqIENvbWJpbmVzIHRoZSAnb25jZScgYW5kIHRoZSAnbWF0Y2gnIGJlaGF2aW91cnMuXG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaE9uY2UodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IExpc3RlbmVySWQ7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFuIGFsaWFzIGZvciB1bmxpc3RlblxuICAgICAgICAgKi9cbiAgICAgICAgb2ZmKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG4gICAgICAgIG9mZihjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgICAgICBvZmYoaWQ6IExpc3RlbmVySWQpOiB2b2lkO1xuICAgICAgICBvZmYoZGVzdGluYXRpb246IEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPik6IHZvaWQ7XG4gICAgICAgIG9mZigpOiB2b2lkO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQaXBpbmcgdGhlIGV2ZW50IHRvIGFub3RoZXIgb25lIG1lYW5zIHRoYXQgd2hlbmV2ZXIgdGhlIGZpcnN0IG9uZSBpcyB0cmlnZ2VyZWQgLSB0aGVcbiAgICAgICAgICogc2Vjb25kIG9uZSBpcyB0cmlnZ2VyZWQgYXV0b21hdGljYWxseSB3aXRoIGV4YWN0bHkgdGhlIHNhbWUgYXJndW1lbnRcbiAgICAgICAgICovXG4gICAgICAgIHBpcGUoZGVzdGluYXRpb246IEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPik6IExpc3RlbmVySWQ7XG5cbiAgICAgICAgZmlyc3QoKTogUHJvbWlzZTxUPjtcbiAgICAgICAgbmV4dCgpOiBQcm9taXNlPFQ+O1xuICAgIH1cblxuICAgIGV4cG9ydCBmdW5jdGlvbiBtYWtlPFQ+KCk6IFtFdmVudFByb3BlcnR5PFQ+LCBFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD5dIHtcbiAgICAgICAgbGV0IGV2ZW50UHJvcCA9IG5ldyBFdmVudFByb3BlcnR5PFQ+KCk7XG4gICAgICAgIGxldCBlbWl0dGVyID0gPEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPj5ldmVudFByb3A7XG4gICAgICAgIHJldHVybiBbZXZlbnRQcm9wLCBlbWl0dGVyXTtcbiAgICB9XG5cbiAgICBleHBvcnQgZnVuY3Rpb24gc3BsaXQ8VD4oKTogWyhhcmc6IFQpID0+IHZvaWQsIEV2ZW50UHJvcGVydHkuRW1pdHRlcjxUPl0ge1xuICAgICAgICBsZXQgZXZlbnRQcm9wID0gbmV3IEV2ZW50UHJvcGVydHk8VD4oKTtcbiAgICAgICAgbGV0IGVtaXR0ZXIgPSA8RXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+PmV2ZW50UHJvcDtcbiAgICAgICAgcmV0dXJuIFtldmVudFByb3AuZW1pdCwgZW1pdHRlcl07XG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIHNwbGl0Vm9pZCgpOiBbKCkgPT4gdm9pZCwgRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPHZvaWQ+XSB7XG4gICAgICAgIGxldCBldmVudFByb3AgPSBuZXcgRXZlbnRQcm9wZXJ0eS5Wb2lkKCk7XG4gICAgICAgIGxldCBlbWl0dGVyID0gPEV2ZW50UHJvcGVydHkuRW1pdHRlcjx2b2lkPj5ldmVudFByb3A7XG4gICAgICAgIHJldHVybiBbZXZlbnRQcm9wLmVtaXQsIGVtaXR0ZXJdO1xuICAgIH1cblxuICAgIGV4cG9ydCBjbGFzcyBWb2lkIGV4dGVuZHMgRXZlbnRQcm9wZXJ0eTx2b2lkPiB7XG4gICAgICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgfVxuICAgICAgICBlbWl0KCkgeyByZXR1cm4gc3VwZXIuZW1pdCh2b2lkIDApOyB9XG4gICAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgRXZlbnRQcm9wZXJ0eTsiXX0=