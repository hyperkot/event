/// <reference path="../typings/index.d.ts"/>
Object.defineProperty(exports, "__esModule", { value: true });
function _objectMatch(subject, proto, traversalStack = []) {
    switch (typeof proto) {
        case "undefined": return subject === undefined;
        case "number":
        case "boolean":
        case "string":
        case "function":
            return subject === proto;
        case "object":
            let isMatching = true;
            if (typeof subject !== "object")
                return false;
            if (!proto || !subject)
                return !subject && !proto;
            if (traversalStack.includes(subject)) {
                throw new Error("Recursion!");
            }
            for (let key in proto) {
                if (proto.hasOwnProperty(key)) {
                    traversalStack.push(subject);
                    isMatching = isMatching && _objectMatch(subject[key], proto[key], traversalStack);
                    traversalStack.pop();
                }
            }
            return isMatching;
        default:
            throw new Error(`Unexpected typeof: ${typeof proto}`);
    }
}
function objectMatch(subject, proto) {
    return _objectMatch(subject, proto);
}
/**
 * Represents an event and provides methods to observe it and to trigger it.
 */
class EventProperty {
    constructor() {
        this.listeners = [];
        this.isBeingTriggered = false;
        this.firstTriggerPromise = null;
        this.isFirstTriggerDone = false;
        this.idCounter = 0;
        this.firstTriggerPromise = new Promise((resolve, reject) => {
            this.resolveFirstTriggerPromise = resolve;
            this.rejectFirstTriggerPromise = reject;
        });
        this.trigger = this.trigger.bind(this);
    }
    /**
     * Triggers the event with given argument, invoking all of its handlers, and if
     * the event is triggered for the first time - removing the once event handlers and
     * saving given argument inertnally as first trigger argument.
     *
     * The argument is optional, since event can be of void type (`x= new Event<void>()`),
     * but if the event is not of a void type - you should allways pass an argument to
     * the trigger method.
     *
     * Trigger method returns a promise, which is resolved() whe all results of calling
     * callbacks are resolved.
     */
    trigger(eventArg) {
        if (this.isBeingTriggered) {
            throw new Error(`Event triggered during trigger handling - suspecting recursive event.`);
        }
        this.isBeingTriggered = true;
        if (!this.isFirstTriggerDone) {
            this.isFirstTriggerDone = true;
            this.resolveFirstTriggerPromise(eventArg);
        }
        return Promise.all(this.listeners.slice().map((listener) => {
            let doCall = true;
            let cbReturn;
            if (listener.onlyMatching) {
                doCall = objectMatch(eventArg, listener.matchValue);
            }
            if (doCall) {
                if (listener.context) {
                    cbReturn = listener.handler.call(listener.context, eventArg);
                }
                else {
                    cbReturn = listener.handler.call(null, eventArg);
                }
                if (listener.once) {
                    this.removeListener(listener);
                }
                if (!(cbReturn instanceof Promise))
                    cbReturn = Promise.resolve(cbReturn);
            }
            else {
                cbReturn = Promise.resolve();
            }
            return cbReturn;
        })).then(() => {
            this.isBeingTriggered = false;
        });
    }
    /**
     * Adds a listener. If once=true then adds once listener which means that listener will be removed,
     * when event triggers for the first time. Also if event already was triggered for the first time
     * when you call 'add()' then once listener will not be added but instead invoked immidiately,
     * with argument, that event was triggered with the first time.
     */
    on(handler, context) {
        return this.addListener({ handler, context });
    }
    /**
     * Adds a listener to the event
     */
    once(handler, context = null) {
        return this.addListener({ context, handler, once: true });
    }
    /**
     * Adds a listener, which will be invoked only if the event-argument is deeply-equal to
     * the given value.
     */
    match(value, handler, context) {
        return this.addListener({ handler, context, onlyMatching: true, matchValue: value });
    }
    /**
     * Combines 'match' and 'once' features.
     */
    matchOnce(value, handler, context = null) {
        return this.addListener({
            context,
            handler,
            once: true,
            onlyMatching: true,
            matchValue: value
        });
    }
    off(...args) {
        let context = null, handler = null, idToRemove = null;
        switch (args.length) {
            case 0:
                this.listeners = [];
                return;
            case 1:
                if (typeof args[0] === "number") {
                    idToRemove = args[0];
                }
                else if (typeof args[0] === "function") {
                    handler = args[0];
                    context = null;
                }
                else if (typeof args[0] === "object") {
                    handler = null;
                    context = args[0];
                }
                else {
                    throw new Error(`Invalid argument: ${typeof args[0]}`);
                }
                break;
            case 2:
                handler = args[0];
                context = args[1];
                break;
            default:
                throw new Error("Unsupported arguments format.");
        }
        this.listeners = this.listeners.filter((hConf) => {
            let differentHandler = hConf.handler !== handler;
            let noHandlerGiven = !handler;
            let noContextGiven = !context;
            let confHasNoContext = !hConf.context;
            let differentContext = hConf.context !== context;
            let dontRemove;
            if (idToRemove !== null) {
                dontRemove = idToRemove !== hConf.id;
            }
            else {
                if (noHandlerGiven) {
                    if (noContextGiven) {
                        throw new Error("Unexpected circumstances.");
                    }
                    else {
                        dontRemove = confHasNoContext || (context !== hConf.context);
                    }
                }
                else {
                    if (differentHandler) {
                        dontRemove = true;
                    }
                    else {
                        if (noContextGiven) {
                            dontRemove = (!confHasNoContext) || (differentHandler);
                        }
                        else {
                            dontRemove = differentContext || differentHandler;
                        }
                    }
                }
            }
            return dontRemove;
        });
    }
    next() {
        return new Promise((resolve, reject) => {
            try {
                this.once(resolve);
            }
            catch (e) {
                reject(e);
            }
        });
    }
    first() {
        return this.firstTriggerPromise;
    }
    /**
     * Piping the events means that the other event must be triggered(happen) any time
     * this event happens and with exactly the same argument.
     */
    pipe(other) {
        this.on(other.trigger);
    }
    unpipe(other) {
        this.off(other.trigger);
    }
    removeListener(listener) {
        let listenerIndex = this.listeners.indexOf(listener);
        if (listenerIndex !== -1) {
            this.listeners.splice(listenerIndex, 1);
        }
    }
    addListener(options) {
        let { context, handler, once, onlyMatching, matchValue } = options;
        this.idCounter++;
        this.listeners.push({ context, handler, once, id: this.idCounter, onlyMatching, matchValue });
        return this.idCounter;
    }
}
exports.EventProperty = EventProperty;
exports.default = EventProperty;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZXZlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDOztBQUU3QyxzQkFBc0IsT0FBWSxFQUFFLEtBQVUsRUFBRSxpQkFBd0IsRUFBRTtJQUN0RSxNQUFNLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbkIsS0FBSyxXQUFXLEVBQUUsTUFBTSxDQUFDLE9BQU8sS0FBSyxTQUFTLENBQUM7UUFDL0MsS0FBSyxRQUFRLENBQUM7UUFDZCxLQUFLLFNBQVMsQ0FBQztRQUNmLEtBQUssUUFBUSxDQUFDO1FBQ2QsS0FBSyxVQUFVO1lBQ1gsTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLENBQUM7UUFDN0IsS0FBSyxRQUFRO1lBQ1QsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBRXRCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQztnQkFBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1lBQzlDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNsRCxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNsQyxDQUFDO1lBQ0QsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDcEIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzVCLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQzdCLFVBQVUsR0FBRyxVQUFVLElBQUksWUFBWSxDQUFD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LFNBQVMsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzVDLENBQUM7SUFDTCxDQUFDO0lBRU8sV0FBVyxDQUFDLE9BQXdDO1FBQ3hELElBQUksRUFBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFDLEdBQUcsT0FBTyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUMsQ0FBQyxDQUFDO1FBQzVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQzFCLENBQUM7Q0FDSjtBQXZORCxzQ0F1TkM7QUFFRCxrQkFBZSxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9pbmRleC5kLnRzXCIvPlxuXG5mdW5jdGlvbiBfb2JqZWN0TWF0Y2goc3ViamVjdDogYW55LCBwcm90bzogYW55LCB0cmF2ZXJzYWxTdGFjazogYW55W10gPSBbXSk6IGJvb2xlYW4ge1xuICAgIHN3aXRjaCAodHlwZW9mIHByb3RvKSB7XG4gICAgICAgIGNhc2UgXCJ1bmRlZmluZWRcIjogcmV0dXJuIHN1YmplY3QgPT09IHVuZGVmaW5lZDtcbiAgICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIGNhc2UgXCJmdW5jdGlvblwiOlxuICAgICAgICAgICAgcmV0dXJuIHN1YmplY3QgPT09IHByb3RvO1xuICAgICAgICBjYXNlIFwib2JqZWN0XCI6XG4gICAgICAgICAgICBsZXQgaXNNYXRjaGluZyA9IHRydWU7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3ViamVjdCAhPT0gXCJvYmplY3RcIikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKCFwcm90byB8fCAhc3ViamVjdCkgcmV0dXJuICFzdWJqZWN0ICYmICFwcm90bztcbiAgICAgICAgICAgIGlmICh0cmF2ZXJzYWxTdGFjay5pbmNsdWRlcyhzdWJqZWN0KSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlY3Vyc2lvbiFcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gcHJvdG8pIHtcbiAgICAgICAgICAgICAgICBpZiAocHJvdG8uaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzYWxTdGFjay5wdXNoKHN1YmplY3QpO1xuICAgICAgICAgICAgICAgICAgICBpc01hdGNoaW5nID0gaXNNYXRjaGluZyAmJiBfb2JqZWN0TWF0Y2goc3ViamVjdFtrZXldLCBwcm90b1trZXldLCB0cmF2ZXJzYWxTdGFjayk7XG4gICAgICAgICAgICAgICAgICAgIHRyYXZlcnNhbFN0YWNrLnBvcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBpc01hdGNoaW5nO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGVvZjogJHt0eXBlb2YgcHJvdG99YCk7XG4gICAgfVxufVxuZnVuY3Rpb24gb2JqZWN0TWF0Y2goc3ViamVjdDogYW55LCBwcm90bzogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIF9vYmplY3RNYXRjaChzdWJqZWN0LCBwcm90byk7XG59XG5cblxuZXhwb3J0IG5hbWVzcGFjZSBFdmVudFByb3BlcnR5IHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBjYWxsYmFjayBmb3JtYXQgdXNlZCBmb3IgYWRkaW5nIGxpc3RlbmVycyB0byBldmVudC1wcm9wZXJ0aWVzLlxuICAgICAqL1xuICAgIGV4cG9ydCBpbnRlcmZhY2UgSGFuZGxlcjxUPiB7XG4gICAgICAgIChldmVudEFyZzogVCk6IHZvaWR8UHJvbWlzZTxhbnk+O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBmdWxsIGNvbmZpZ3VyYXRpb24gZm9yIGEgc3BlY2lmaWMgZXZlbnQtaGFuZGxlci4gSXQgY29udHJvbHMgdGhlIHdheVxuICAgICAqIHRoZSByZWxldmFudCBldmVudC1oYW5kbGVyIGZ1bmN0aW9uIGlzIGludm9rZWQuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBIYW5kbGVyT3B0aW9uczxUPiB7XG4gICAgICAgIC8qKiBUaGUgYWN0dWFsIGhhbmRsZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50IG9jY3Vycy4gKi9cbiAgICAgICAgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+O1xuXG4gICAgICAgIC8qKiBJZiB0aGlzIGZsYWcgaXMgc2V0IC0gdGhlIGV2ZW50IGhhbmRsZXIgd2lsbCByZW1vdmUgaXRzZWxmIGZyb20gdGhlIGV2ZW50XG4gICAgICAgIGFmdGVyIGZpcnN0IGludm9jYXRpb24uICovXG4gICAgICAgIG9uY2U/OiBib29sZWFuO1xuXG4gICAgICAgIC8qKiBJZiB0aGlzIGZpZWxkIGlzIHNwZWNpZmllZCwgdGhlbiBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhhdCBjb250ZXh0LiAqL1xuICAgICAgICBjb250ZXh0PzogT2JqZWN0O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBbHdheXMgdXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIGZvbGxvd2luZyBwYXJhbWV0ZXIgJ21hdGNoVmFsdWUnIGFuZCBpcyBhXG4gICAgICAgICAqIGZsYWcsIHdoaWNoIG1lYW5zKGlmIHNldCkgdGhhdCBvbmx5IGV2ZW50IGludm9jYXRpb25zIHdpdGggYXJndW1lbnQgZXF1YWxcbiAgICAgICAgICogdG8gdGhhdCBwcmVkZWZpbmVkICdtYXRjaFZhbHVlJyBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uLlxuICAgICAgICAgKiBCYXNpY2FsbHkgdGhpcyBpcyBhIHNob3J0aGFuZCBmb3IgdGhlIGNvZGUgbGlrZSB0aGlzOlxuICAgICAgICAgKlxuICAgICAgICAgKiAgZXZlbnQubGlzdGVuKChhcmcpID0+IHtcbiAgICAgICAgICogICAgICBpZihhcmcgPT09IG1hdGNoVmFsdWUpKSBldmVudC5jYWxsSGFuZGxlcigpO1xuICAgICAgICAgKiB9KTsgICAgICAgIFxuICAgICAgICAgKiBcbiAgICAgICAgICogQHR5cGUge1t0eXBlXX1cbiAgICAgICAgICovXG4gICAgICAgIG9ubHlNYXRjaGluZz86IGJvb2xlYW47XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSB2YWx1ZSwgdG8gYmUgbWF0Y2hlZCBpZiB0aGUgJ29ubHlNYXRjaGluZycgZmxhZyBpcyBzZXQuXG4gICAgICAgICAqIEB0eXBlIHtbdHlwZV19XG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaFZhbHVlPzogVDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGlzIHRoZSBvYmplY3Qgd2hpY2ggcmVwcmVzZW50cyBhbiBleGlzdGluZyBoYW5kbGVyIGludGVybmFsbHkgaW4gRXZlbnQgb2JqZWN0LlxuICAgICAqL1xuICAgIGV4cG9ydCBpbnRlcmZhY2UgSGFuZGxlckRlc2NyaXB0b3I8VD4gZXh0ZW5kcyBIYW5kbGVyT3B0aW9uczxUPiB7XG4gICAgICAgIGlkOiBudW1iZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQW4gZXZlbnQtcHJvcGVydHkgaW50ZXJmYWNlIHdpdGhvdXQgdGhlICd0cmlnZ2VyJyBtZXRob2QuXG4gICAgICovXG4gICAgZXhwb3J0IGludGVyZmFjZSBFbWl0dGVyPFQ+IHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFkZCBldmVudCBoYW5kbGVyIHRvIHRoaXMgZXZlbnQuIE9wdGlvbmFsbHkgcGFzcyBhIGNvbnRleHQgaW4gc2Vjb25kIGFyZ3VtZW50IC0gXG4gICAgICAgICAqIHRoZW4gd2hlbiB0cmlnZ2VyZWQgdGhpcyAgZXZlbnQgd2lsbCBjYWxsIHRoZSAnaCcgaGFuZGxlciB3aXRoIHRoZSBnaXZlbiBjb250ZXh0LlxuICAgICAgICAgKi9cbiAgICAgICAgb24oaDogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuXG4gICAgICAgIG9uY2UoaDogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBZGQgZXZlbnQgaGFuZGxlciB0byB0aGlzIGV2ZW50LCB3aGljaCB3aWxsIGJlIGNhbGxlZCBvbmx5IHdoZW4gZXZlbnQgaXMgdHJpZ2dlcmVkXG4gICAgICAgICAqIHdpdGggdmFsdWUsIHdoaWNoIGlzIGV4YWN0bHkoPT09KSB0aGUgc2FtZSBhcyB0aGUgb25lIHlvdSBwYXNzIHRvIHRoZSBtYXRjaCBcbiAgICAgICAgICogbWV0aG9kIGFzIGZpcnN0IGFyZ3VtZW50XG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaCh2YWx1ZTogVCwgaDogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBZGRzIGFuIGV2ZW50IGhhbmRsZXIuXG4gICAgICAgICAqIENvbWJpbmVzIHRoZSAnb25jZScgYW5kIHRoZSAnbWF0Y2gnIGJlaGF2aW91cnMuXG4gICAgICAgICAqL1xuICAgICAgICBtYXRjaE9uY2UodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQW4gYWxpYXMgZm9yIHVubGlzdGVuXG4gICAgICAgICAqL1xuICAgICAgICBvZmYoaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICAgICAgb2ZmKGNvbnRleHQ6IE9iamVjdCk6IHZvaWQ7XG4gICAgICAgIG9mZihpZDogbnVtYmVyKTogdm9pZDtcbiAgICAgICAgb2ZmKCk6IHZvaWQ7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFBpcGluZyB0aGUgZXZlbnQgdG8gYW5vdGhlciBvbmUgbWVhbnMgdGhhdCB3aGVuZXZlciB0aGUgZmlyc3Qgb25lIGlzIHRyaWdnZXJlZCAtIHRoZVxuICAgICAgICAgKiBzZWNvbmQgb25lIGlzIHRyaWdnZXJlZCBhdXRvbWF0aWNhbGx5IHdpdGggZXhhY3RseSB0aGUgc2FtZSBhcmd1bWVudFxuICAgICAgICAgKi9cbiAgICAgICAgcGlwZShvdGhlcjogRXZlbnRQcm9wZXJ0eS5FbWl0dGVyPFQ+KTogdm9pZDtcbiAgICAgICAgdW5waXBlKG90aGVyOiBFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD4pOiB2b2lkO1xuXG4gICAgICAgIGZpcnN0KCk6IFByb21pc2U8VD47XG4gICAgICAgIG5leHQoKTogUHJvbWlzZTxUPjtcbiAgICB9XG59XG5cblxuXG5cblxuXG4vKipcbiAqIFJlcHJlc2VudHMgYW4gZXZlbnQgYW5kIHByb3ZpZGVzIG1ldGhvZHMgdG8gb2JzZXJ2ZSBpdCBhbmQgdG8gdHJpZ2dlciBpdC5cbiAqL1xuZXhwb3J0IGNsYXNzIEV2ZW50UHJvcGVydHk8VD4gaW1wbGVtZW50cyBFdmVudFByb3BlcnR5LkVtaXR0ZXI8VD4ge1xuICAgIHByaXZhdGUgbGlzdGVuZXJzOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+W10gPSBbXTtcbiAgICBwcml2YXRlIGlzQmVpbmdUcmlnZ2VyZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHByaXZhdGUgZmlyc3RUcmlnZ2VyUHJvbWlzZTogUHJvbWlzZTxUPiA9IG51bGw7XG4gICAgcHJpdmF0ZSByZXNvbHZlRmlyc3RUcmlnZ2VyUHJvbWlzZTogKHZhbHVlOiBUKSA9PiBhbnk7XG4gICAgcHJpdmF0ZSByZWplY3RGaXJzdFRyaWdnZXJQcm9taXNlOiAodmFsdWU6IGFueSkgPT4gYW55O1xuICAgIHByaXZhdGUgaXNGaXJzdFRyaWdnZXJEb25lOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIGlkQ291bnRlcjogbnVtYmVyID0gMDtcblxuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICAgICAgdGhpcy5maXJzdFRyaWdnZXJQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmU6ICh2YWx1ZTogVCkgPT4gdm9pZCwgcmVqZWN0OiAoZTogYW55KSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlc29sdmVGaXJzdFRyaWdnZXJQcm9taXNlID0gcmVzb2x2ZTtcbiAgICAgICAgICAgIHRoaXMucmVqZWN0Rmlyc3RUcmlnZ2VyUHJvbWlzZSA9IHJlamVjdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy50cmlnZ2VyID0gdGhpcy50cmlnZ2VyLmJpbmQodGhpcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJpZ2dlcnMgdGhlIGV2ZW50IHdpdGggZ2l2ZW4gYXJndW1lbnQsIGludm9raW5nIGFsbCBvZiBpdHMgaGFuZGxlcnMsIGFuZCBpZlxuICAgICAqIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgZm9yIHRoZSBmaXJzdCB0aW1lIC0gcmVtb3ZpbmcgdGhlIG9uY2UgZXZlbnQgaGFuZGxlcnMgYW5kXG4gICAgICogc2F2aW5nIGdpdmVuIGFyZ3VtZW50IGluZXJ0bmFsbHkgYXMgZmlyc3QgdHJpZ2dlciBhcmd1bWVudC5cbiAgICAgKiBcbiAgICAgKiBUaGUgYXJndW1lbnQgaXMgb3B0aW9uYWwsIHNpbmNlIGV2ZW50IGNhbiBiZSBvZiB2b2lkIHR5cGUgKGB4PSBuZXcgRXZlbnQ8dm9pZD4oKWApLFxuICAgICAqIGJ1dCBpZiB0aGUgZXZlbnQgaXMgbm90IG9mIGEgdm9pZCB0eXBlIC0geW91IHNob3VsZCBhbGx3YXlzIHBhc3MgYW4gYXJndW1lbnQgdG9cbiAgICAgKiB0aGUgdHJpZ2dlciBtZXRob2QuXG4gICAgICogXG4gICAgICogVHJpZ2dlciBtZXRob2QgcmV0dXJucyBhIHByb21pc2UsIHdoaWNoIGlzIHJlc29sdmVkKCkgd2hlIGFsbCByZXN1bHRzIG9mIGNhbGxpbmdcbiAgICAgKiBjYWxsYmFja3MgYXJlIHJlc29sdmVkLlxuICAgICAqL1xuICAgIHRyaWdnZXIoZXZlbnRBcmc/OiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICh0aGlzLmlzQmVpbmdUcmlnZ2VyZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXZlbnQgdHJpZ2dlcmVkIGR1cmluZyB0cmlnZ2VyIGhhbmRsaW5nIC0gc3VzcGVjdGluZyByZWN1cnNpdmUgZXZlbnQuYCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc0JlaW5nVHJpZ2dlcmVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKCF0aGlzLmlzRmlyc3RUcmlnZ2VyRG9uZSkge1xuICAgICAgICAgICAgdGhpcy5pc0ZpcnN0VHJpZ2dlckRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlRmlyc3RUcmlnZ2VyUHJvbWlzZShldmVudEFyZyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHRoaXMubGlzdGVuZXJzLnNsaWNlKCkubWFwKChsaXN0ZW5lcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPikgPT4ge1xuICAgICAgICAgICAgbGV0IGRvQ2FsbCA9IHRydWU7XG4gICAgICAgICAgICBsZXQgY2JSZXR1cm46IFByb21pc2U8YW55PiB8IHZvaWQ7XG4gICAgICAgICAgICBpZiAobGlzdGVuZXIub25seU1hdGNoaW5nKSB7XG4gICAgICAgICAgICAgICAgZG9DYWxsID0gb2JqZWN0TWF0Y2goZXZlbnRBcmcsIGxpc3RlbmVyLm1hdGNoVmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRvQ2FsbCkge1xuICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lci5jb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNiUmV0dXJuID0gbGlzdGVuZXIuaGFuZGxlci5jYWxsKGxpc3RlbmVyLmNvbnRleHQsIGV2ZW50QXJnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjYlJldHVybiA9IGxpc3RlbmVyLmhhbmRsZXIuY2FsbChudWxsLCBldmVudEFyZyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lci5vbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIShjYlJldHVybiBpbnN0YW5jZW9mIFByb21pc2UpKSBjYlJldHVybiA9IFByb21pc2UucmVzb2x2ZShjYlJldHVybik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNiUmV0dXJuID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gY2JSZXR1cm47XG4gICAgICAgIH0pKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaXNCZWluZ1RyaWdnZXJlZCA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbGlzdGVuZXIuIElmIG9uY2U9dHJ1ZSB0aGVuIGFkZHMgb25jZSBsaXN0ZW5lciB3aGljaCBtZWFucyB0aGF0IGxpc3RlbmVyIHdpbGwgYmUgcmVtb3ZlZCxcbiAgICAgKiB3aGVuIGV2ZW50IHRyaWdnZXJzIGZvciB0aGUgZmlyc3QgdGltZS4gQWxzbyBpZiBldmVudCBhbHJlYWR5IHdhcyB0cmlnZ2VyZWQgZm9yIHRoZSBmaXJzdCB0aW1lXG4gICAgICogd2hlbiB5b3UgY2FsbCAnYWRkKCknIHRoZW4gb25jZSBsaXN0ZW5lciB3aWxsIG5vdCBiZSBhZGRlZCBidXQgaW5zdGVhZCBpbnZva2VkIGltbWlkaWF0ZWx5LFxuICAgICAqIHdpdGggYXJndW1lbnQsIHRoYXQgZXZlbnQgd2FzIHRyaWdnZXJlZCB3aXRoIHRoZSBmaXJzdCB0aW1lLlxuICAgICAqL1xuICAgIG9uKGhhbmRsZXI6IEV2ZW50UHJvcGVydHkuSGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHsgaGFuZGxlciwgY29udGV4dCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbGlzdGVuZXIgdG8gdGhlIGV2ZW50XG4gICAgICovXG4gICAgb25jZShoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ6IE9iamVjdCA9IG51bGwpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7IGNvbnRleHQsIGhhbmRsZXIsIG9uY2U6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGxpc3RlbmVyLCB3aGljaCB3aWxsIGJlIGludm9rZWQgb25seSBpZiB0aGUgZXZlbnQtYXJndW1lbnQgaXMgZGVlcGx5LWVxdWFsIHRvXG4gICAgICogdGhlIGdpdmVuIHZhbHVlLlxuICAgICAqL1xuICAgIG1hdGNoKHZhbHVlOiBULCBoYW5kbGVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7IGhhbmRsZXIsIGNvbnRleHQsIG9ubHlNYXRjaGluZzogdHJ1ZSwgbWF0Y2hWYWx1ZTogdmFsdWUgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29tYmluZXMgJ21hdGNoJyBhbmQgJ29uY2UnIGZlYXR1cmVzLlxuICAgICAqL1xuICAgIG1hdGNoT25jZSh2YWx1ZTogVCwgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0OiBPYmplY3QgPSBudWxsKTogbnVtYmVyIHtcbiAgICAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHtcbiAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgIGhhbmRsZXIsXG4gICAgICAgICAgICAgb25jZTogdHJ1ZSxcbiAgICAgICAgICAgICBvbmx5TWF0Y2hpbmc6IHRydWUsXG4gICAgICAgICAgICAgbWF0Y2hWYWx1ZTogdmFsdWVcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhIGxpc3RlbmVyKHMpLiBXaGVuIG5vIGNvbnRleHQgZ2l2ZW4gcmVtb3ZlcyBhbGwgbGlzdGVuZXJzIHRoYXQgd2VyZSBhdHRhY2hlZFxuICAgICAqIHdpdGhvdXQgYSBjb250ZXh0LiBXaGVuIGEgY29udGV4dCBpcyBnaXZlbiByZW1vdmVzIG9ubHkgbGlzdGVuZXJzIHRoYXQgd2VyZSBhdHRhY2hlZCB3aXRoXG4gICAgICogdGhhdCBjb250ZXh0IGFuZCBkb2Vzbid0IHJlbW92ZSBhbnkgbGlzdGVuZXJzIHRoYXQgd2VyZSBhdHRhY2hlZCB3aXRob3V0IGEgY29udGV4dC5cbiAgICAgKi9cbiAgICBvZmYoaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICBvZmYoY29udGV4dDogT2JqZWN0KTogdm9pZDtcbiAgICBvZmYoaWQ6IG51bWJlcik6IHZvaWQ7XG4gICAgb2ZmKCk6IHZvaWQ7XG4gICAgb2ZmKC4uLmFyZ3M6IGFueVtdKTogdm9pZCB7XG4gICAgICAgIGxldCBjb250ZXh0OiBPYmplY3QgPSBudWxsLFxuICAgICAgICAgICAgaGFuZGxlcjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyPFQ+ID0gbnVsbCxcbiAgICAgICAgICAgIGlkVG9SZW1vdmU6IG51bWJlciA9IG51bGw7XG4gICAgICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNhc2UgMDogLy8gTm8gYXJndW1lbnRzIC0gY2xlYXIgYWxsIGxpc3RlbmVycyBcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IFtdO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWRUb1JlbW92ZSA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJndW1lbnQ6ICR7dHlwZW9mIGFyZ3NbMF19YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBhcmdzWzFdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCBhcmd1bWVudHMgZm9ybWF0LlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnMuZmlsdGVyKChoQ29uZjogRXZlbnRQcm9wZXJ0eS5IYW5kbGVyRGVzY3JpcHRvcjxUPikgPT4ge1xuICAgICAgICAgICAgbGV0IGRpZmZlcmVudEhhbmRsZXI6IGJvb2xlYW4gPSBoQ29uZi5oYW5kbGVyICE9PSBoYW5kbGVyO1xuICAgICAgICAgICAgbGV0IG5vSGFuZGxlckdpdmVuOiBib29sZWFuID0gIWhhbmRsZXI7XG4gICAgICAgICAgICBsZXQgbm9Db250ZXh0R2l2ZW46IGJvb2xlYW4gPSAhY29udGV4dDtcbiAgICAgICAgICAgIGxldCBjb25mSGFzTm9Db250ZXh0OiBib29sZWFuID0gIWhDb25mLmNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgZGlmZmVyZW50Q29udGV4dDogYm9vbGVhbiA9IGhDb25mLmNvbnRleHQgIT09IGNvbnRleHQ7XG4gICAgICAgICAgICBsZXQgZG9udFJlbW92ZTogYm9vbGVhbjtcblxuICAgICAgICAgICAgaWYgKGlkVG9SZW1vdmUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gaWRUb1JlbW92ZSAhPT0gaENvbmYuaWQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChub0hhbmRsZXJHaXZlbikge1xuICAgICAgICAgICAgICAgICAgICBpZiAobm9Db250ZXh0R2l2ZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVuZXhwZWN0ZWQgY2lyY3Vtc3RhbmNlcy5cIik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gY29uZkhhc05vQ29udGV4dCB8fCAoY29udGV4dCAhPT0gaENvbmYuY29udGV4dCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlmZmVyZW50SGFuZGxlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9Db250ZXh0R2l2ZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gKCFjb25mSGFzTm9Db250ZXh0KSB8fCAoZGlmZmVyZW50SGFuZGxlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSBkaWZmZXJlbnRDb250ZXh0IHx8IGRpZmZlcmVudEhhbmRsZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9udFJlbW92ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbmV4dCgpOiBQcm9taXNlPFR8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmU6IChhOiBUKSA9PiB2b2lkLCByZWplY3Q6IChlOiBhbnkpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbmNlKHJlc29sdmUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZmlyc3QoKTogUHJvbWlzZTxUfHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlyc3RUcmlnZ2VyUHJvbWlzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQaXBpbmcgdGhlIGV2ZW50cyBtZWFucyB0aGF0IHRoZSBvdGhlciBldmVudCBtdXN0IGJlIHRyaWdnZXJlZChoYXBwZW4pIGFueSB0aW1lXG4gICAgICogdGhpcyBldmVudCBoYXBwZW5zIGFuZCB3aXRoIGV4YWN0bHkgdGhlIHNhbWUgYXJndW1lbnQuXG4gICAgICovXG4gICAgcGlwZShvdGhlcjogRXZlbnRQcm9wZXJ0eTxUPik6IHZvaWQge1xuICAgICAgICB0aGlzLm9uKG90aGVyLnRyaWdnZXIpO1xuICAgIH1cblxuICAgIHVucGlwZShvdGhlcjogRXZlbnRQcm9wZXJ0eTxUPik6IHZvaWQge1xuICAgICAgICB0aGlzLm9mZihvdGhlci50cmlnZ2VyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyOiBFdmVudFByb3BlcnR5LkhhbmRsZXJEZXNjcmlwdG9yPFQ+KTogdm9pZCB7XG4gICAgICAgIGxldCBsaXN0ZW5lckluZGV4ID0gdGhpcy5saXN0ZW5lcnMuaW5kZXhPZihsaXN0ZW5lcik7XG4gICAgICAgIGlmIChsaXN0ZW5lckluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMuc3BsaWNlKGxpc3RlbmVySW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRMaXN0ZW5lcihvcHRpb25zOiBFdmVudFByb3BlcnR5LkhhbmRsZXJPcHRpb25zPFQ+KTogbnVtYmVyIHtcbiAgICAgICAgbGV0IHtjb250ZXh0LCBoYW5kbGVyLCBvbmNlLCBvbmx5TWF0Y2hpbmcsIG1hdGNoVmFsdWV9ID0gb3B0aW9ucztcbiAgICAgICAgdGhpcy5pZENvdW50ZXIrKztcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMucHVzaCh7Y29udGV4dCwgaGFuZGxlciwgb25jZSwgaWQ6IHRoaXMuaWRDb3VudGVyLCBvbmx5TWF0Y2hpbmcsIG1hdGNoVmFsdWV9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaWRDb3VudGVyO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRXZlbnRQcm9wZXJ0eTsiXX0=