/// <reference path="../typings/index.d.ts"/>
const _ = require("lodash");
class Event {
    constructor() {
        this.listeners = [];
        this.isBeingTriggered = false;
        this.triggerDelegate = null;
        this.listenDelegate = null;
        this.matchDelegate = null;
        this.matchOnceDelegate = null;
        this.unlistenDelegate = null;
        this.onceDelegate = null;
        this.whenDelegate = null;
        this.thenDelegate = null;
        this.catchDelegate = null;
        this.promise = null;
        this.isFirstTriggerDone = false;
        this.idCounter = 0;
        this.triggerDelegate = (eventArg) => this.trigger(eventArg);
        this.listenDelegate = (...args) => {
            return this.listen.apply(this, args);
        };
        this.matchDelegate = (...args) => {
            return this.match.apply(this, args);
        };
        this.matchOnceDelegate = (...args) => {
            return this.matchOnce.apply(this, args);
        };
        this.unlistenDelegate = (...args) => {
            return this.unlisten.apply(this, args);
        };
        this.onceDelegate = (handler, context = null) => {
            return this.once(handler, context);
        };
        this.whenDelegate = () => {
            return this.when();
        };
        this.thenDelegate = (onOk, onFail) => {
            return this.then(onOk, onFail);
        };
        this.catchDelegate = (onFail) => {
            return this.catch(onFail);
        };
        this.promise = new Promise((resolve) => { this.resolve = resolve; });
    }
    mixin(target) {
        target.trigger = this.getTriggerer();
        target.getTriggerer = () => {
            return this.getTriggerer();
        };
        target.listen = this.getListener();
        target.match = this.getMatchListener();
        target.matchOnce = this.getMatchOncer();
        target.unlisten = this.getUnlistener();
        target.once = this.getOncer();
        target.when = this.getWhener();
        target.then = this.getThener();
        target.catch = this.getCatcher();
        return target;
    }
    /** Returns a context-independent callback that triggers the event with given argument */
    getTriggerer() { return this.triggerDelegate; }
    getListener() { return this.listenDelegate; }
    getMatchListener() { return this.matchDelegate; }
    getMatchOncer() { return this.matchOnceDelegate; }
    getUnlistener() { return this.unlistenDelegate; }
    getOncer() { return this.onceDelegate; }
    getWhener() { return this.whenDelegate; }
    getThener() { return this.thenDelegate; }
    getCatcher() { return this.catchDelegate; }
    /**
     * Triggers the event with given argument, invoking all of its handlers, and if
     * the event is triggered for the first time - removing the once event handlers and
     * saving given argument inetrnally as first trigger argument.
     */
    trigger(eventArg) {
        if (this.isBeingTriggered) {
            throw new Error(`Event triggered during trigger handling - suspecting recursive event.`);
        }
        this.isBeingTriggered = true;
        if (!this.isFirstTriggerDone) {
            this.isFirstTriggerDone = true;
            this.resolve(eventArg);
        }
        this.listeners.slice().forEach((listener) => {
            let doCall = true;
            if (listener.onlyMatching) {
                doCall = listener.matchValue === eventArg;
            }
            if (doCall) {
                if (listener.context) {
                    listener.handler.call(listener.context, eventArg);
                }
                else {
                    listener.handler.call(null, eventArg);
                }
                if (listener.once) {
                    this.removeListener(listener);
                }
            }
        });
        this.isBeingTriggered = false;
    }
    listen(...args) {
        let id;
        if (typeof args[0] === 'string') {
            let [name, handler, context] = args;
            id = this.addListener({ name, handler, context });
        }
        else {
            let [handler, context] = args;
            id = this.addListener({ handler, context });
        }
        return id;
    }
    ;
    match(value, ...args) {
        let id;
        if (typeof args[0] === 'string') {
            let [name, handler, context] = args;
            id = this.addListener({ name, handler, context, onlyMatching: true, matchValue: value });
        }
        else {
            let [handler, context] = args;
            id = this.addListener({ handler, context, onlyMatching: true, matchValue: value });
        }
        return id;
    }
    ;
    matchOnce(value, handler, context = null) {
        return this.addListener({ context, handler, once: true, onlyMatching: true, matchValue: value });
    }
    once(handler, context = null) {
        return this.addListener({ context, handler, once: true });
    }
    unlisten(...args) {
        let name = null, context, handler, idToRemove = null;
        switch (args.length) {
            case 0:
                this.listeners = [];
                return;
            case 1:
                if (typeof args[0] === 'string') {
                    name = args[0];
                    handler = args[1];
                    context = args[2];
                }
                else if (typeof args[0] === 'number') {
                    idToRemove = args[0];
                }
                else {
                    handler = args[0];
                    context = args[1];
                }
                ;
                break;
            case 2:
                handler = args[0];
                context = args[1];
                break;
        }
        this.listeners = _.filter(this.listeners, (hConf) => {
            let differentHandler = hConf.handler !== handler;
            let noContextGiven = context === null;
            let confHasNoContext = !!hConf.context;
            let differentContext = hConf.context !== context;
            let sameName = name && hConf.name && (name === hConf.name);
            let dontRemove;
            if (idToRemove !== null) {
                dontRemove = idToRemove !== hConf.id;
            }
            else {
                if (name) {
                    dontRemove = !sameName;
                }
                else {
                    if (differentHandler) {
                        dontRemove = true;
                    }
                    else {
                        dontRemove = noContextGiven ? (!confHasNoContext) : (confHasNoContext || differentContext);
                    }
                }
            }
            return dontRemove;
        });
    }
    on(nameOrHandler, handlerOrNothing) {
        return this.listen.apply(this, arguments);
    }
    off(bullshitWTF, context) {
        return this.unlisten.apply(this, arguments);
    }
    when() { return this.promise; }
    then(onOk, onFail) { return this.when().then(onOk, onFail); }
    after(onAny) { return this.then(onAny).catch(onAny); }
    catch(onFail) { return this.when().catch(onFail); }
    pipe(other) {
        this.on(other.getTriggerer());
    }
    unpipe(other) {
        this.off(other.getTriggerer());
    }
    removeListener(listener) {
        let listenerIndex = this.listeners.indexOf(listener);
        if (listenerIndex !== -1) {
            this.listeners.splice(listenerIndex, 1);
        }
    }
    addListener(options) {
        let { context, handler, once, onlyMatching, matchValue } = options;
        this.idCounter++;
        this.listeners.push({ context, handler, once, id: this.idCounter, onlyMatching, matchValue });
        return this.idCounter;
    }
    static event() {
        return function (prototype, eventName) {
            return {
                configurable: true,
                enumerable: false,
                get() {
                    let event = new Event();
                    Reflect.defineProperty(this, eventName, {
                        configurable: false,
                        enumerable: false,
                        writable: false,
                        value: event
                    });
                    return event;
                }
            };
        };
    }
    static emits(eventName) {
        return function (prototype, methodName, original) {
            let originalMethod = original.value;
            let descriptor = {
                configurable: false,
                enumerable: false,
                writeable: false,
                value(...args) {
                    let result = originalMethod.apply(this, args);
                    this[eventName].trigger(result);
                    return result;
                }
            };
            return descriptor;
        };
    }
}
exports.Event = Event;
function emits(name) {
    return Event.emits(name);
}
exports.emits = emits;
function event(name) {
    return Event.emits(name);
}
exports.event = event;
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Event;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZXZlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDO0FBRTdDLDRCQUE0QjtBQTJKNUI7SUF5Qkk7UUF4QlEsY0FBUyxHQUFnQyxFQUFFLENBQUM7UUFDNUMscUJBQWdCLEdBQVksS0FBSyxDQUFDO1FBRWxDLG9CQUFlLEdBQXNCLElBQUksQ0FBQztRQUUxQyxtQkFBYyxHQUFxQixJQUFJLENBQUM7UUFDeEMsa0JBQWEsR0FBMEIsSUFBSSxDQUFDO1FBQzVDLHNCQUFpQixHQUF1QixJQUFJLENBQUM7UUFDN0MscUJBQWdCLEdBQXVCLElBQUksQ0FBQztRQUU1QyxpQkFBWSxHQUFrQixJQUFJLENBQUM7UUFFbkMsaUJBQVksR0FBbUIsSUFBSSxDQUFDO1FBRXBDLGlCQUFZLEdBQW1CLElBQUksQ0FBQztRQUNwQyxrQkFBYSxHQUFvQixJQUFJLENBQUM7UUFFdEMsWUFBTyxHQUFlLElBQUksQ0FBQztRQUUzQix1QkFBa0IsR0FBWSxLQUFLLENBQUM7UUFFcEMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUkxQixJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsUUFBVyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLEdBQUcsSUFBVztZQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQztRQUNGLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxHQUFHLElBQVc7WUFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUM7UUFDRixJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxHQUFHLElBQVc7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Q0FBQztZQUNGLE1BQU0sQ0FBQyxVQUFVLENBQUM7UUFDdEIsQ0FBQyxDQUFBO0lBQ0wsQ0FBQztDQUNKO0FBdlNELHNCQXVTQztBQUVELGVBQXNCLElBQVk7SUFDOUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDN0IsQ0FBQztBQUZELHNCQUVDO0FBRUQsZUFBc0IsSUFBWTtJQUM5QixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRkQsc0JBRUM7O0FBRUQsa0JBQWUsS0FBSyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL3R5cGluZ3MvaW5kZXguZC50c1wiLz5cblxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuXG4vKipcbiAqIEEgZnVuY3Rpb24sIGNhbGxiYWNrLCB3aGljaCBpcyBjYWxsZWQsIHdoZW4gc3ViamVjdCBldmVudCBvY2N1cnMuXG4gKiBJdCBpcyBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudCAtIGl0IGlzIHRoZSBzYW1lIGFyZ3VtZW50IHRoYXQgd2FzIHBhc3NlZCB0byB0aGVcbiAqIFwidHJpZ2dlcigpXCIgbWV0aG9kIGNhbGwsIHdoaWNoIGlzIHRoZSBvbmx5IHdheSB0byBtYWtlIGV2ZW50IFwiaGFwcGVuXCIuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRIYW5kbGVyPFQ+IHtcbiAgICAoZXZlbnRBcmc6IFQpOiB2b2lkXG59XG5cbi8qKlxuICogVGhlIGZ1bGwgY29uZmlndXJhdGlvbiBmb3IgYSBzcGVjaWZpYyBldmVudC1oYW5kbGVyLiBJdCBjb250cm9scyB0aGUgd2F5XG4gKiB0aGUgcmVsZXZhbnQgZXZlbnQtaGFuZGxlciBmdW5jdGlvbiBpcyBpbnZva2VkLlxuICovXG5pbnRlcmZhY2UgRXZlbnRIYW5kbGVyT3B0aW9uczxUPiB7XG4gICAgLyoqIFRoZSBhY3R1YWwgaGFuZGxlciBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgb2NjdXJzLiAqL1xuICAgIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPjtcbiAgICBcbiAgICAvKiogSWYgdGhpcyBmbGFnIGlzIHNldCAtIHRoZSBldmVudCBoYW5kbGVyIHdpbGwgcmVtb3ZlIGl0c2VsZiBmcm9tIHRoZSBldmVudFxuICAgIGFmdGVyIGZpcnN0IGludm9jYXRpb24uICovXG4gICAgb25jZT86IGJvb2xlYW47XG4gICAgXG4gICAgLyoqIElmIHRoaXMgZmllbGQgaXMgc3BlY2lmaWVkLCB0aGVuIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGF0IGNvbnRleHQuICovXG4gICAgY29udGV4dD86IE9iamVjdDtcbiAgICBcbiAgICAvKiogVGhlIG5hbWUgb2YgdGhlIGV2ZW50IGhhbmRsZXIuIFVzZWQgZm9yIGlkZW50aWZpY2F0aW9uLiBZb3UgbWF5IGNyZWF0ZSB0d29cbiAgICAgKiBsaXN0ZW5lcnMsIHdpdGggc2FtZSBoYW5kbGVyIGZ1bmN0aW9uLCBidXQgZGlmZmVyZW50IG5hbWVzIC0gc28gdGhhdCBsYXRlcixcbiAgICAgKiB5b3UgY2FuICdvZmYnLyd1bmxpc3RlbicgYSBzcGVjaWZpYyBsaXN0ZW5lciBieSBuYW1lLCB3aGlsZSB1bmxpc3RlbmluZyBieVxuICAgICAqIGhhbmRsZXIgZnVuY3Rpb24gd291bGQndmUgcmVtb3ZlZCBib3RoIGxpc3RlbmVyLlxuICAgICAqL1xuICAgIG5hbWU/OiBzdHJpbmc7XG4gICAgXG4gICAgLyoqXG4gICAgICogQWx3YXlzIHVzZWQgaW4gY29tYmluYXRpb24gd2l0aCBmb2xsb3dpbmcgcGFyYW1ldGVyICdtYXRjaFZhbHVlJyBhbmQgaXMgYVxuICAgICAqIGZsYWcsIHdoaWNoIG1lYW5zKGlmIHNldCkgdGhhdCBvbmx5IGV2ZW50IGludm9jYXRpb25zIHdpdGggYXJndW1lbnQgZXF1YWxcbiAgICAgKiB0byB0aGF0IHByZWRlZmluZWQgJ21hdGNoVmFsdWUnIHNob3VsZCBiZSBwYXNzZWQgdG8gdGhlIGhhbmRsZXIgZnVuY3Rpb24uXG4gICAgICogQmFzaWNhbGx5IHRoaXMgaXMgYSBzaG9ydGhhbmQgZm9yIHRoZSBjb2RlIGxpa2UgdGhpczpcbiAgICAgKlxuICAgICAqICBldmVudC5saXN0ZW4oKGFyZykgPT4ge1xuICAgICAqICAgICAgaWYoYXJnID09PSBtYXRjaFZhbHVlKSkgZXZlbnQuY2FsbEhhbmRsZXIoKTtcbiAgICAgKiB9KTsgICAgICAgIFxuICAgICAqIFxuICAgICAqIEB0eXBlIHtbdHlwZV19XG4gICAgICovXG4gICAgb25seU1hdGNoaW5nPzogYm9vbGVhbjtcbiAgICBcbiAgICAvKipcbiAgICAgKiBUaGUgdmFsdWUsIHRvIGJlIG1hdGNoZWQgaWYgdGhlICdvbmx5TWF0Y2hpbmcnIGZsYWcgaXMgc2V0LlxuICAgICAqIEB0eXBlIHtbdHlwZV19XG4gICAgICovXG4gICAgbWF0Y2hWYWx1ZT86IFQ7XG59XG5cbi8qKlxuICogVGhpcyBpcyB0aGUgb2JqZWN0IHdoaWNoIHJlcHJlc2VudHMgYW4gZXhpc3RpbmcgaGFuZGxlciBpbnRlcm5hbGx5IGluIEV2ZW50IG9iamVjdC5cbiAqL1xuaW50ZXJmYWNlIEV2ZW50SGFuZGxlckRlc2NyaXB0b3I8VD4gZXh0ZW5kcyBFdmVudEhhbmRsZXJPcHRpb25zPFQ+IHtcbiAgICBpZDogbnVtYmVyO1xufVxuXG4vKipcbiAqIFRoZSBpbnRlcmZhY2UgZm9yIHRoZSAnZXZlbnQudHJpZ2dlcigpJyBtZXRob2RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudFRyaWdnZXJlcjxUPiB7XG4gICAgKGFyZzogVCk6IHZvaWRcbn1cblxuLyoqXG4gKiBUaGUgaW50ZXJmYWNlIGZvciB0aGUgJ2V2ZW50Lmxpc3RlbigpJyBtZXRob2RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudExpc3RlbmVyPFQ+IHtcbiAgICAoaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICAobmFtZTogc3RyaW5nLCBoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50VW5saXN0ZW5lcjxUPiB7XG4gICAgKGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG4gICAgKGNvbnRleHQ6IE9iamVjdCk6IHZvaWQ7XG4gICAgKG5hbWU6IHN0cmluZyk6IHZvaWQ7XG4gICAgKCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRPbmNlcjxUPiB7XG4gICAgKGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWRcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFdmVudE1hdGNoTGlzdGVuZXI8VD4ge1xuICAgICh2YWx1ZTogVCwgaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICAodmFsdWU6IFQsIG5hbWU6IHN0cmluZywgaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFdmVudE1hdGNoT25jZXI8VD4ge1xuICAgICh2YWx1ZTogVCwgaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFdmVudFdoZW5lcjxUPiB7XG4gICAgKCk6IFByb21pc2U8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRUaGVuZXI8VD4ge1xuICAgIChvbk9rOiBGdW5jdGlvbiwgb25GYWlsOiBGdW5jdGlvbik6IFByb21pc2U8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRDYXRjaGVyPFQ+IHtcbiAgICAob25GYWlsOiAoZXJyOmFueSkgPT4gVHxhbnkpOiBQcm9taXNlPFQ+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50RW1pdHRlcjxUPiBleHRlbmRzIFRoZW5hYmxlPFQ+IHtcbiAgICBsaXN0ZW4oaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuICAgIGxpc3RlbihuYW1lOiBzdHJpbmcsIGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcbiAgICBtYXRjaCh2YWx1ZTogVCwgaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuICAgIG1hdGNoKHZhbHVlOiBULCBuYW1lOiBzdHJpbmcsIGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcbiAgICBtYXRjaE9uY2UodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcbiAgICBvbihoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG4gICAgb24obmFtZTogc3RyaW5nLCBoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG5cbiAgICBhZnRlcihvblJlc29sdmU6IChyZXN1bHQ6IFR8YW55KT0+YW55KTogVGhlbmFibGU8VD47XG5cbiAgICB1bmxpc3RlbihoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgIHVubGlzdGVuKGNvbnRleHQ6IE9iamVjdCk6IHZvaWQ7XG4gICAgdW5saXN0ZW4obmFtZTogc3RyaW5nKTogdm9pZDtcbiAgICB1bmxpc3RlbihpZDogbnVtYmVyKTogdm9pZDtcbiAgICB1bmxpc3RlbigpOiB2b2lkO1xuICAgIG9mZihoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiB2b2lkO1xuICAgIG9mZihjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgIG9mZihuYW1lOiBzdHJpbmcpOiB2b2lkO1xuICAgIG9mZihpZDogbnVtYmVyKTogdm9pZDtcbiAgICBvZmYoKTogdm9pZDtcblxuICAgIHBpcGUob3RoZXI6IEV2ZW50RW1pdHRlcjxUPik6IHZvaWQ7XG5cbiAgICBvbmNlKGg6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcblxuICAgIHdoZW4oKTogUHJvbWlzZTxUPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFdmVudFRyYWl0PFQ+IGV4dGVuZHMgRXZlbnRFbWl0dGVyPFQ+IHtcbiAgICB0cmlnZ2VyKGFyZzogVCk6IHZvaWQ7XG5cbiAgICBnZXRUcmlnZ2VyZXIoKTogRXZlbnRUcmlnZ2VyZXI8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRUcmFpdFRyaWdnZXI8VD4gZXh0ZW5kcyBFdmVudFRyYWl0PFQ+IHtcbiAgICAoYXJnOiBUKTogdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFdmVudFRyYWl0ZWRNZXRob2Q8TWV0aG9kVCBleHRlbmRzICgpPT52b2lkLCBFdmVudEFyZ3NUPiBleHRlbmRzIEV2ZW50VHJhaXQ8RXZlbnRBcmdzVD4ge1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRoZW5hYmxlPFQ+IHtcbiAgICB0aGVuKG9uUmVzb2x2ZTogKHJlc3VsdDogVCk9PmFueSwgb25SZWplY3Q/OiAoZXJyb3I6IEVycm9yfGFueSk9PmFueSk6IFRoZW5hYmxlPFQ+O1xuICAgIGNhdGNoKG9uUmVqZWN0OiAoZXJyb3I6IEVycm9yfGFueSk9PmFueSk6IFRoZW5hYmxlPFQ+O1xufSBcblxuZXhwb3J0IGNsYXNzIEV2ZW50PFQ+IGltcGxlbWVudHMgRXZlbnRUcmFpdDxUPiwgVGhlbmFibGU8VD4ge1xuICAgIHByaXZhdGUgbGlzdGVuZXJzOiBFdmVudEhhbmRsZXJEZXNjcmlwdG9yPFQ+W10gPSBbXTtcbiAgICBwcml2YXRlIGlzQmVpbmdUcmlnZ2VyZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHByaXZhdGUgdHJpZ2dlckRlbGVnYXRlOiBFdmVudFRyaWdnZXJlcjxUPiA9IG51bGw7XG5cbiAgICBwcml2YXRlIGxpc3RlbkRlbGVnYXRlOiBFdmVudExpc3RlbmVyPFQ+ID0gbnVsbDtcbiAgICBwcml2YXRlIG1hdGNoRGVsZWdhdGU6IEV2ZW50TWF0Y2hMaXN0ZW5lcjxUPiA9IG51bGw7XG4gICAgcHJpdmF0ZSBtYXRjaE9uY2VEZWxlZ2F0ZTogRXZlbnRNYXRjaE9uY2VyPFQ+ID0gbnVsbDtcbiAgICBwcml2YXRlIHVubGlzdGVuRGVsZWdhdGU6IEV2ZW50VW5saXN0ZW5lcjxUPiA9IG51bGw7XG5cbiAgICBwcml2YXRlIG9uY2VEZWxlZ2F0ZTogRXZlbnRPbmNlcjxUPiA9IG51bGw7XG5cbiAgICBwcml2YXRlIHdoZW5EZWxlZ2F0ZTogRXZlbnRXaGVuZXI8VD4gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSB0aGVuRGVsZWdhdGU6IEV2ZW50VGhlbmVyPFQ+ID0gbnVsbDtcbiAgICBwcml2YXRlIGNhdGNoRGVsZWdhdGU6IEV2ZW50Q2F0Y2hlcjxUPiA9IG51bGw7XG5cbiAgICBwcml2YXRlIHByb21pc2U6IFByb21pc2U8VD4gPSBudWxsOyBcbiAgICBwcml2YXRlIHJlc29sdmU6ICh2YWx1ZTogVCkgPT4gVDtcbiAgICBwcml2YXRlIGlzRmlyc3RUcmlnZ2VyRG9uZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBpZENvdW50ZXI6IG51bWJlciA9IDA7XG5cblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnRyaWdnZXJEZWxlZ2F0ZSA9IChldmVudEFyZzogVCkgPT4gdGhpcy50cmlnZ2VyKGV2ZW50QXJnKTtcbiAgICAgICAgdGhpcy5saXN0ZW5EZWxlZ2F0ZSA9ICguLi5hcmdzOiBhbnlbXSk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubGlzdGVuLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLm1hdGNoRGVsZWdhdGUgPSAoLi4uYXJnczogYW55W10pOiB2b2lkID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hdGNoLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLm1hdGNoT25jZURlbGVnYXRlID0gKC4uLmFyZ3M6IGFueVtdKTogdm9pZCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXRjaE9uY2UuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgIH07IFxuICAgICAgICB0aGlzLnVubGlzdGVuRGVsZWdhdGUgPSAoLi4uYXJnczogYW55W10pOiB2b2lkID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVubGlzdGVuLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLm9uY2VEZWxlZ2F0ZSA9IChoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ6IE9iamVjdCA9IG51bGwpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9uY2UoaGFuZGxlciwgY29udGV4dCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMud2hlbkRlbGVnYXRlID0gKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMud2hlbigpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnRoZW5EZWxlZ2F0ZSA9IChvbk9rOiBFdmVudEhhbmRsZXI8VD4sIG9uRmFpbDogRnVuY3Rpb24pID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4ob25PaywgPGFueT5vbkZhaWwpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNhdGNoRGVsZWdhdGUgPSAob25GYWlsOiBGdW5jdGlvbikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2F0Y2goPGFueT5vbkZhaWwpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogYW55KSA9PiB7IHRoaXMucmVzb2x2ZSA9IHJlc29sdmU7IH0pO1xuICAgIH1cbiAgICBcbiAgICBtaXhpbih0YXJnZXQ6IGFueSk6IEV2ZW50VHJhaXQ8VD4ge1xuICAgICAgICB0YXJnZXQudHJpZ2dlciA9IHRoaXMuZ2V0VHJpZ2dlcmVyKCk7XG4gICAgICAgIHRhcmdldC5nZXRUcmlnZ2VyZXIgPSAoKT0+e1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VHJpZ2dlcmVyKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0YXJnZXQubGlzdGVuID0gdGhpcy5nZXRMaXN0ZW5lcigpO1xuICAgICAgICB0YXJnZXQubWF0Y2ggPSB0aGlzLmdldE1hdGNoTGlzdGVuZXIoKTtcbiAgICAgICAgdGFyZ2V0Lm1hdGNoT25jZSA9IHRoaXMuZ2V0TWF0Y2hPbmNlcigpO1xuICAgICAgICB0YXJnZXQudW5saXN0ZW4gPSB0aGlzLmdldFVubGlzdGVuZXIoKTtcblxuICAgICAgICB0YXJnZXQub25jZSA9IHRoaXMuZ2V0T25jZXIoKTtcblxuICAgICAgICB0YXJnZXQud2hlbiA9IHRoaXMuZ2V0V2hlbmVyKCk7XG4gICAgICAgIHRhcmdldC50aGVuID0gdGhpcy5nZXRUaGVuZXIoKTtcbiAgICAgICAgdGFyZ2V0LmNhdGNoICA9dGhpcy5nZXRDYXRjaGVyKCk7XG5cbiAgICAgICAgcmV0dXJuIHRhcmdldDtcbiAgICB9XG5cbiAgICAvKiogUmV0dXJucyBhIGNvbnRleHQtaW5kZXBlbmRlbnQgY2FsbGJhY2sgdGhhdCB0cmlnZ2VycyB0aGUgZXZlbnQgd2l0aCBnaXZlbiBhcmd1bWVudCAqL1xuICAgIGdldFRyaWdnZXJlcigpOiBFdmVudFRyaWdnZXJlcjxUPiB7IHJldHVybiB0aGlzLnRyaWdnZXJEZWxlZ2F0ZTsgfVxuICAgIGdldExpc3RlbmVyKCk6IEV2ZW50TGlzdGVuZXI8VD4geyByZXR1cm4gdGhpcy5saXN0ZW5EZWxlZ2F0ZTsgfVxuICAgIGdldE1hdGNoTGlzdGVuZXIoKTogRXZlbnRNYXRjaExpc3RlbmVyPFQ+IHsgcmV0dXJuIHRoaXMubWF0Y2hEZWxlZ2F0ZTsgfVxuICAgIGdldE1hdGNoT25jZXIoKTogRXZlbnRNYXRjaE9uY2VyPFQ+IHsgcmV0dXJuIHRoaXMubWF0Y2hPbmNlRGVsZWdhdGU7IH1cbiAgICBnZXRVbmxpc3RlbmVyKCk6IEV2ZW50VW5saXN0ZW5lcjxUPiB7IHJldHVybiB0aGlzLnVubGlzdGVuRGVsZWdhdGU7IH1cbiAgICBnZXRPbmNlcigpOiBFdmVudE9uY2VyPFQ+IHsgcmV0dXJuIHRoaXMub25jZURlbGVnYXRlOyB9XG4gICAgZ2V0V2hlbmVyKCk6IEV2ZW50V2hlbmVyPFQ+IHsgcmV0dXJuIHRoaXMud2hlbkRlbGVnYXRlOyB9XG4gICAgZ2V0VGhlbmVyKCk6IEV2ZW50VGhlbmVyPFQ+IHsgcmV0dXJuIHRoaXMudGhlbkRlbGVnYXRlOyB9XG4gICAgZ2V0Q2F0Y2hlcigpOiBFdmVudENhdGNoZXI8VD4geyByZXR1cm4gdGhpcy5jYXRjaERlbGVnYXRlOyB9XG5cbiAgICAvKipcbiAgICAgKiBUcmlnZ2VycyB0aGUgZXZlbnQgd2l0aCBnaXZlbiBhcmd1bWVudCwgaW52b2tpbmcgYWxsIG9mIGl0cyBoYW5kbGVycywgYW5kIGlmXG4gICAgICogdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBmb3IgdGhlIGZpcnN0IHRpbWUgLSByZW1vdmluZyB0aGUgb25jZSBldmVudCBoYW5kbGVycyBhbmRcbiAgICAgKiBzYXZpbmcgZ2l2ZW4gYXJndW1lbnQgaW5ldHJuYWxseSBhcyBmaXJzdCB0cmlnZ2VyIGFyZ3VtZW50LlxuICAgICAqL1xuICAgIHRyaWdnZXIoZXZlbnRBcmc/OiBUKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmlzQmVpbmdUcmlnZ2VyZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXZlbnQgdHJpZ2dlcmVkIGR1cmluZyB0cmlnZ2VyIGhhbmRsaW5nIC0gc3VzcGVjdGluZyByZWN1cnNpdmUgZXZlbnQuYCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc0JlaW5nVHJpZ2dlcmVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKCF0aGlzLmlzRmlyc3RUcmlnZ2VyRG9uZSkge1xuICAgICAgICAgICAgdGhpcy5pc0ZpcnN0VHJpZ2dlckRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlKGV2ZW50QXJnKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxpc3RlbmVycy5zbGljZSgpLmZvckVhY2goKGxpc3RlbmVyKSA9PiB7XG4gICAgICAgICAgICBsZXQgZG9DYWxsID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lci5vbmx5TWF0Y2hpbmcpIHtcbiAgICAgICAgICAgICAgICBkb0NhbGwgPSBsaXN0ZW5lci5tYXRjaFZhbHVlID09PSBldmVudEFyZztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGRvQ2FsbCkge1xuICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lci5jb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyLmhhbmRsZXIuY2FsbChsaXN0ZW5lci5jb250ZXh0LCBldmVudEFyZyk7IFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyLmhhbmRsZXIuY2FsbChudWxsLCBldmVudEFyZyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lci5vbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuaXNCZWluZ1RyaWdnZXJlZCA9IGZhbHNlO1xuICAgIH0gIFxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGxpc3RlbmVyLiBJZiBvbmNlPXRydWUgdGhlbiBhZGRzIG9uY2UgbGlzdGVuZXIgd2hpY2ggbWVhbnMgdGhhdCBsaXN0ZW5lciB3aWxsIGJlIHJlbW92ZWQsXG4gICAgICogd2hlbiBldmVudCB0cmlnZ2VycyBmb3IgdGhlIGZpcnN0IHRpbWUuIEFsc28gaWYgZXZlbnQgYWxscmVhZHkgd2FzIHRyaWdnZXJlZCBmb3IgdGhlIGZpcnN0IHRpbWVcbiAgICAgKiB3aGVuIHlvdSBjYWxsICdhZGQoKScgdGhlbiBvbmNlIGxpc3RlbmVyIHdpbGwgbm90IGJlIGFkZGVkIGJ1dCBpbnN0ZWFkIGludm9rZWQgaW1taWRpYXRlbHksXG4gICAgICogd2l0aCBhcmd1bWVudCwgdGhhdCBldmVudCB3YXMgdHJpZ2dlcmVkIHdpdGggdGhlIGZpcnN0IHRpbWUuXG4gICAgICovXG4gICAgbGlzdGVuKGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IG51bWJlcjtcbiAgICBsaXN0ZW4obmFtZTogc3RyaW5nLCBoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG4gICAgbGlzdGVuKC4uLmFyZ3M6IGFueVtdKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGlkOiBudW1iZXI7XG4gICAgICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGxldCBbbmFtZSwgaGFuZGxlciwgY29udGV4dF0gPSBhcmdzO1xuICAgICAgICAgICAgaWQgPSB0aGlzLmFkZExpc3RlbmVyKHsgbmFtZSwgaGFuZGxlciwgY29udGV4dCB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBbaGFuZGxlciwgY29udGV4dF0gPSBhcmdzO1xuICAgICAgICAgICAgaWQgPSB0aGlzLmFkZExpc3RlbmVyKHsgaGFuZGxlciwgY29udGV4dCB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfTtcblxuICAgIG1hdGNoKHZhbHVlOiBULCBoOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ/OiBPYmplY3QpOiBudW1iZXI7XG4gICAgbWF0Y2godmFsdWU6IFQsIG5hbWU6IHN0cmluZywgaDogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogbnVtYmVyO1xuICAgIG1hdGNoKHZhbHVlOiBULCAuLi5hcmdzOiBhbnlbXSk6IG51bWJlciB7XG4gICAgICAgIGxldCBpZDogbnVtYmVyO1xuICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBsZXQgW25hbWUsIGhhbmRsZXIsIGNvbnRleHRdID0gYXJncztcbiAgICAgICAgICAgIGlkID0gdGhpcy5hZGRMaXN0ZW5lcih7IG5hbWUsIGhhbmRsZXIsIGNvbnRleHQsIG9ubHlNYXRjaGluZzogdHJ1ZSwgbWF0Y2hWYWx1ZTogdmFsdWUgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgW2hhbmRsZXIsIGNvbnRleHRdID0gYXJncztcbiAgICAgICAgICAgIGlkID0gdGhpcy5hZGRMaXN0ZW5lcih7IGhhbmRsZXIsIGNvbnRleHQsIG9ubHlNYXRjaGluZzogdHJ1ZSwgbWF0Y2hWYWx1ZTogdmFsdWUgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGlkO1xuICAgIH07XG5cbiAgICBtYXRjaE9uY2UodmFsdWU6IFQsIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dDogT2JqZWN0ID0gbnVsbCk6IG51bWJlciB7XG4gICAgICAgICByZXR1cm4gdGhpcy5hZGRMaXN0ZW5lcih7IGNvbnRleHQsIGhhbmRsZXIsIG9uY2U6IHRydWUsIG9ubHlNYXRjaGluZzogdHJ1ZSwgbWF0Y2hWYWx1ZTogdmFsdWUgfSk7XG4gICAgfVxuXG4gICAgb25jZShoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGNvbnRleHQ6IE9iamVjdCA9IG51bGwpOiBudW1iZXIge1xuICAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoeyBjb250ZXh0LCBoYW5kbGVyLCBvbmNlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhIGxpc3RlbmVyKHMpLiBXaGVuIG5vIGNvbnRleHQgZ2l2ZW4gcmVtb3ZlcyBhbGwgbGlzdGVuZXJzLCB0aGF0IHdlcmUgYXR0YWNoZWRcbiAgICAgKiB3aXRob3V0IGEgY29udGV4dC4gV2hlbiBhIGNvbnRleHQgaXMgZ2l2ZW4gcmVtb3ZlcyBvbmx5IGxpc3RlbmVycyB0aGF0IHdlcmUgYXR0YWNoZWQgd2l0aFxuICAgICAqIHRoYXQgY29udGV4dCBhbmQgZG9lc24ndCByZW1vdmUgYW55IGxpc3RlbmVycyB0aGF0IHdlcmUgYXR0YWNoZWQgd2l0aG91dCBhIGNvbnRleHQuXG4gICAgICovXG4gICAgdW5saXN0ZW4oaGFuZGxlcjogRXZlbnRIYW5kbGVyPFQ+LCBjb250ZXh0PzogT2JqZWN0KTogdm9pZDtcbiAgICB1bmxpc3Rlbihjb250ZXh0OiBPYmplY3QpOiB2b2lkO1xuICAgIHVubGlzdGVuKG5hbWU6IHN0cmluZyk6IHZvaWQ7XG4gICAgdW5saXN0ZW4oaWQ6IG51bWJlcik6IHZvaWQ7XG4gICAgdW5saXN0ZW4oKTogdm9pZDtcbiAgICB1bmxpc3RlbiguLi5hcmdzOiBhbnlbXSk6IHZvaWQge1xuICAgICAgICBsZXQgbmFtZTogc3RyaW5nID0gbnVsbCwgY29udGV4dDogT2JqZWN0LCBoYW5kbGVyOiBFdmVudEhhbmRsZXI8VD4sIGlkVG9SZW1vdmU6IG51bWJlciA9IG51bGw7IFxuICAgICAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICBjYXNlIDA6IHRoaXMubGlzdGVuZXJzID0gW107IHJldHVybjtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhcmdzWzBdO1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYXJnc1sxXTtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGFyZ3NbMl07XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgICAgICAgaWRUb1JlbW92ZSA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBhcmdzWzFdO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICAgICAgaGFuZGxlciA9IGFyZ3NbMF07XG4gICAgICAgICAgICAgICAgY29udGV4dCA9IGFyZ3NbMV07XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxpc3RlbmVycyA9IF8uZmlsdGVyKHRoaXMubGlzdGVuZXJzLCAoaENvbmY6IEV2ZW50SGFuZGxlckRlc2NyaXB0b3I8VD4pID0+IHtcbiAgICAgICAgICAgIGxldCBkaWZmZXJlbnRIYW5kbGVyOiBib29sZWFuID0gaENvbmYuaGFuZGxlciAhPT0gaGFuZGxlcjtcbiAgICAgICAgICAgIGxldCBub0NvbnRleHRHaXZlbjogYm9vbGVhbiA9IGNvbnRleHQgPT09IG51bGw7XG4gICAgICAgICAgICBsZXQgY29uZkhhc05vQ29udGV4dDogYm9vbGVhbiA9ICEhaENvbmYuY29udGV4dDtcbiAgICAgICAgICAgIGxldCBkaWZmZXJlbnRDb250ZXh0OiBib29sZWFuID0gaENvbmYuY29udGV4dCAhPT0gY29udGV4dDtcbiAgICAgICAgICAgIGxldCBzYW1lTmFtZSA9IG5hbWUgJiYgaENvbmYubmFtZSAmJiAobmFtZSA9PT0gaENvbmYubmFtZSk7XG4gICAgICAgICAgICBsZXQgZG9udFJlbW92ZTogYm9vbGVhbjtcbiAgICAgICAgICAgIGlmIChpZFRvUmVtb3ZlICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgZG9udFJlbW92ZSA9IGlkVG9SZW1vdmUgIT09IGhDb25mLmlkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAobmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gIXNhbWVOYW1lO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaWZmZXJlbnRIYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb250UmVtb3ZlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbnRSZW1vdmUgPSBub0NvbnRleHRHaXZlbiA/ICghY29uZkhhc05vQ29udGV4dCkgOiAoY29uZkhhc05vQ29udGV4dCB8fCBkaWZmZXJlbnRDb250ZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGRvbnRSZW1vdmU7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG9uKG5hbWU6IHN0cmluZywgaDogRXZlbnRIYW5kbGVyPFQ+KTogbnVtYmVyO1xuICAgIG9uKGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPik6IG51bWJlcjtcbiAgICBvbihuYW1lT3JIYW5kbGVyOiBFdmVudEhhbmRsZXI8VD58c3RyaW5nLCBoYW5kbGVyT3JOb3RoaW5nPzogRXZlbnRIYW5kbGVyPFQ+KTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGlzdGVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgb2ZmKGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxUPiwgY29udGV4dD86IE9iamVjdCk6IHZvaWQ7XG4gICAgb2ZmKGNvbnRleHQ6IE9iamVjdCk6IHZvaWQ7XG4gICAgb2ZmKG5hbWU6IHN0cmluZyk6IHZvaWQ7XG4gICAgb2ZmKGlkOiBudW1iZXIpOiB2b2lkO1xuICAgIG9mZigpOiB2b2lkO1xuICAgIG9mZihidWxsc2hpdFdURj86IEV2ZW50SGFuZGxlcjxUPnxzdHJpbmd8bnVtYmVyLCBjb250ZXh0PzogT2JqZWN0KTogdm9pZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnVubGlzdGVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgd2hlbigpOiBQcm9taXNlPFQ+IHsgcmV0dXJuIHRoaXMucHJvbWlzZTsgfVxuICAgIHRoZW4ob25PazogKHI6IFQpPT4gVHxhbnksIG9uRmFpbD86IChlOiBhbnkpPT5UfGFueSk6IFByb21pc2U8VD4geyByZXR1cm4gdGhpcy53aGVuKCkudGhlbihvbk9rLCBvbkZhaWwpOyB9XG4gICAgYWZ0ZXIob25Bbnk6IChyOiBUfGFueSk9PlR8YW55KTogUHJvbWlzZTxUPiB7IHJldHVybiB0aGlzLnRoZW4ob25BbnkpLmNhdGNoKG9uQW55KTt9XG4gICAgY2F0Y2gob25GYWlsOiAoZTogYW55KT0+VHxhbnkpOiBQcm9taXNlPFQ+IHsgcmV0dXJuIHRoaXMud2hlbigpLmNhdGNoKG9uRmFpbCk7IH1cblxuICAgIHBpcGUob3RoZXI6IEV2ZW50PFQ+KTogdm9pZCB7XG4gICAgICAgIHRoaXMub24ob3RoZXIuZ2V0VHJpZ2dlcmVyKCkpO1xuICAgIH1cbiAgICB1bnBpcGUob3RoZXI6IEV2ZW50PFQ+KTogdm9pZCB7XG4gICAgICAgIHRoaXMub2ZmKG90aGVyLmdldFRyaWdnZXJlcigpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyOiBFdmVudEhhbmRsZXJEZXNjcmlwdG9yPFQ+KTogdm9pZCB7XG4gICAgICAgIGxldCBsaXN0ZW5lckluZGV4ID0gdGhpcy5saXN0ZW5lcnMuaW5kZXhPZihsaXN0ZW5lcik7XG4gICAgICAgIGlmIChsaXN0ZW5lckluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMuc3BsaWNlKGxpc3RlbmVySW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRMaXN0ZW5lcihvcHRpb25zOiBFdmVudEhhbmRsZXJPcHRpb25zPFQ+KTogbnVtYmVyIHtcbiAgICAgICAgbGV0IHtjb250ZXh0LCBoYW5kbGVyLCBvbmNlLCBvbmx5TWF0Y2hpbmcsIG1hdGNoVmFsdWV9ID0gb3B0aW9ucztcbiAgICAgICAgdGhpcy5pZENvdW50ZXIrKztcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMucHVzaCh7Y29udGV4dCwgaGFuZGxlciwgb25jZSwgaWQ6IHRoaXMuaWRDb3VudGVyLCBvbmx5TWF0Y2hpbmcsIG1hdGNoVmFsdWV9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaWRDb3VudGVyO1xuICAgIH1cblxuICAgIHN0YXRpYyBldmVudDxFdmVudFQ+KCk6IFByb3BlcnR5RGVjb3JhdG9yIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChwcm90b3R5cGU6IE9iamVjdCwgZXZlbnROYW1lOiBzdHJpbmcpOiBQcm9wZXJ0eURlc2NyaXB0b3Ige1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZ2V0KCkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZXZlbnQgPSBuZXcgRXZlbnQ8RXZlbnRUPigpO1xuICAgICAgICAgICAgICAgICAgICBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGV2ZW50TmFtZSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGV2ZW50XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHN0YXRpYyBlbWl0czxFdmVudFQ+KGV2ZW50TmFtZTogc3RyaW5nKSB7XG5cbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChwcm90b3R5cGU6IE9iamVjdCwgbWV0aG9kTmFtZTogc3RyaW5nLCBvcmlnaW5hbDogUHJvcGVydHlEZXNjcmlwdG9yKTogUHJvcGVydHlEZXNjcmlwdG9yIHtcbiAgICAgICAgICAgIGxldCBvcmlnaW5hbE1ldGhvZDogRnVuY3Rpb24gPSBvcmlnaW5hbC52YWx1ZTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGRlc2NyaXB0b3IgPSB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB3cml0ZWFibGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHZhbHVlKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBvcmlnaW5hbE1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpc1tldmVudE5hbWVdLnRyaWdnZXIocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbWl0cyhuYW1lOiBzdHJpbmcpOiBNZXRob2REZWNvcmF0b3Ige1xuICAgIHJldHVybiBFdmVudC5lbWl0cyhuYW1lKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV2ZW50KG5hbWU6IHN0cmluZyk6IE1ldGhvZERlY29yYXRvciB7XG4gICAgcmV0dXJuIEV2ZW50LmVtaXRzKG5hbWUpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBFdmVudDsiXX0=